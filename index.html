<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HourTrack â€” Industrial Runtime</title>
  <!-- ONLY ONE EXTERNAL SCRIPT â€” Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg:#09090b;--bg2:#18181b;--bg3:#27272a;--bdr:#3f3f46;
      --t1:#e4e4e7;--t2:#a1a1aa;--t3:#71717a;
      --amber:#f59e0b;--amber2:#fbbf24;
      --green:#6ee7b7;--red:#f87171;--sky:#38bdf8;
    }
    body{font-family:'Courier New',monospace;background:var(--bg);color:var(--t1);font-size:14px;line-height:1.5;min-height:100vh}
    ::-webkit-scrollbar{width:6px;height:6px}
    ::-webkit-scrollbar-track{background:var(--bg2)}
    ::-webkit-scrollbar-thumb{background:var(--bg3);border-radius:3px}
    select option{background:var(--bg2)}
    /* HEADER */
    #header{background:var(--bg);border-bottom:1px solid var(--bg3);position:sticky;top:0;z-index:50}
    .hdr-row{display:flex;align-items:center;justify-content:space-between;padding:.6rem 1rem}
    .logo{display:flex;align-items:center;gap:.6rem}
    .logo-icon{width:2rem;height:2rem;background:var(--amber);border-radius:.25rem;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.1rem;color:var(--bg)}
    .logo-text{color:var(--amber);font-weight:600;font-size:.85rem;letter-spacing:.2em;text-transform:uppercase}
    .logo-sub{color:var(--t3);font-size:.6rem;letter-spacing:.15em;text-transform:uppercase}
    .hdr-ctrl{display:flex;align-items:center;gap:.4rem}
    .role-tag{font-size:.6rem;padding:.125rem .4rem;border-radius:.25rem;border:1px solid;font-weight:700}
    .rt-admin{border-color:#d97706;color:var(--amber)}
    .rt-engineer{border-color:#0284c7;color:var(--sky)}
    .rt-viewer{border-color:var(--bdr);color:var(--t3)}
    .email-tag{font-size:.6rem;color:var(--t3);max-width:9rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .icon-btn{background:transparent;border:1px solid var(--bdr);color:var(--t3);border-radius:.25rem;padding:.2rem .5rem;font-size:.7rem;font-family:inherit;cursor:pointer}
    .icon-btn:hover{color:var(--t1)}
    /* NAV */
    #nav{display:flex;overflow-x:auto;padding:0 .5rem}
    .nav-btn{white-space:nowrap;padding:.55rem .75rem;font-size:.65rem;font-family:inherit;letter-spacing:.1em;text-transform:uppercase;border:none;background:transparent;cursor:pointer;color:var(--t3);border-bottom:2px solid transparent;transition:color .15s,border-color .15s}
    .nav-btn:hover{color:var(--t2)}
    .nav-btn.active{color:var(--amber);border-bottom-color:var(--amber)}
    /* MAIN */
    #main{max-width:1280px;margin:0 auto;padding:1rem}
    /* CARDS */
    .card{background:var(--bg2);border:1px solid var(--bg3);border-radius:.5rem;padding:1.1rem}
    .card-amber{border-color:rgba(202,138,4,.35)}
    .card-green{border-color:rgba(16,185,129,.35)}
    /* BUTTONS */
    .btn{display:inline-flex;align-items:center;padding:.45rem .9rem;border-radius:.375rem;font-size:.8rem;font-family:inherit;font-weight:600;letter-spacing:.04em;border:none;cursor:pointer;transition:background .15s;text-decoration:none}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-p{background:var(--amber);color:var(--bg)}
    .btn-p:hover{background:var(--amber2)}
    .btn-s{background:var(--bg3);color:var(--t1);border:1px solid var(--bdr)!important}
    .btn-s:hover{background:var(--bdr)}
    .btn-d{background:rgba(127,29,29,.5);color:#fca5a5;border:1px solid #7f1d1d!important}
    .btn-d:hover{background:rgba(127,29,29,.8)}
    /* FORMS */
    .inp{width:100%;background:var(--bg);border:1px solid var(--bdr);color:var(--t1);border-radius:.375rem;padding:.5rem .7rem;font-size:.85rem;font-family:inherit;outline:none;transition:border-color .15s}
    .inp:focus{border-color:var(--amber)}
    .inp:disabled{opacity:.5}
    .inp-sm{width:7.5rem;background:var(--bg);border:1px solid var(--bdr);color:var(--t1);border-radius:.375rem;padding:.45rem .6rem;font-size:.8rem;font-family:inherit;outline:none}
    .inp-sm:focus{border-color:var(--amber)}
    .inp-ok{border-color:#10b981!important}
    .inp-warn{border-color:#d97706!important}
    .inp-crit{border-color:#dc2626!important}
    label.lbl{display:block;font-size:.6rem;text-transform:uppercase;letter-spacing:.15em;color:var(--t3);margin-bottom:.2rem}
    .fg{margin-bottom:.7rem}
    .sel{background:var(--bg2);border:1px solid var(--bdr);color:var(--t1);border-radius:.375rem;padding:.45rem .7rem;font-size:.8rem;font-family:inherit;outline:none;cursor:pointer}
    .sel:focus{border-color:var(--amber)}
    /* TABLES */
    .tbl-wrap{overflow-x:auto}
    table{width:100%;border-collapse:collapse}
    th{padding:.45rem .75rem;text-align:left;font-size:.6rem;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.15em}
    td{padding:.5rem .75rem;font-size:.78rem;color:var(--t2);border-top:1px solid rgba(39,39,42,.6);font-family:inherit}
    .tr-click{cursor:pointer}
    .tr-click:hover td{background:rgba(39,39,42,.5)}
    tr:hover td{background:rgba(39,39,42,.3)}
    /* BADGES */
    .badge{display:inline-block;padding:.1rem .45rem;border-radius:.25rem;font-size:.6rem;font-weight:700;font-family:inherit;border:1px solid}
    .b-ok{background:rgba(6,78,59,.4);color:#6ee7b7;border-color:#059669}
    .b-warn{background:rgba(120,53,15,.4);color:#fcd34d;border-color:#d97706}
    .b-crit{background:rgba(127,29,29,.4);color:#fca5a5;border-color:#dc2626}
    .b-reset{background:rgba(7,89,133,.4);color:#7dd3fc;border-color:#0284c7}
    /* TOAST */
    #toast{position:fixed;top:1rem;right:1rem;z-index:200;padding:.7rem 1.2rem;border-radius:.5rem;font-size:.8rem;border:1px solid;box-shadow:0 10px 30px rgba(0,0,0,.5);display:none}
    .t-info{background:var(--bg2);border-color:var(--bdr);color:var(--t1)}
    .t-ok{background:#052e16;border-color:#166534;color:#86efac}
    .t-err{background:#450a0a;border-color:#991b1b;color:#fca5a5}
    /* MISC */
    .space>*+*{margin-top:1rem}
    .row{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:.6rem;margin-bottom:.9rem}
    .flex{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .grid4{display:grid;grid-template-columns:repeat(2,1fr);gap:.7rem}
    .grid-2col{display:grid;grid-template-columns:1fr;gap:1rem}
    @media(min-width:900px){.grid4{grid-template-columns:repeat(4,1fr)}.grid-2col{grid-template-columns:1fr 1fr}}
    .ptitle{font-size:1.1rem;font-weight:700;text-transform:uppercase;letter-spacing:.12em;color:var(--t1)}
    .stitle{font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.2em;color:var(--t3);margin-bottom:.75rem}
    .mono{font-family:'Courier New',monospace}
    .amber{color:var(--amber)}
    .sky{color:var(--sky)}
    .green{color:var(--green)}
    .red{color:var(--red)}
    .dim{color:var(--t3)}
    .bold{font-weight:700}
    .sm{font-size:.7rem}
    .xs{font-size:.6rem}
    .progbar{height:3px;background:var(--bg3);border-radius:2px;overflow:hidden;margin-top:3px;width:5rem}
    .progfill{height:100%;border-radius:2px}
    .bar-g{background:#10b981}.bar-a{background:var(--amber)}.bar-r{background:#ef4444}
    .formula{background:rgba(9,9,11,.7);border:1px solid var(--bg3);border-radius:.375rem;padding:.7rem;font-family:'Courier New',monospace;font-size:.82rem;display:flex;flex-wrap:wrap;gap:.35rem;align-items:center}
    .info-box{border:1px solid rgba(202,138,4,.4);background:rgba(120,53,15,.1);border-radius:.375rem;padding:.7rem;font-size:.75rem;color:#fbbf24}
    .step-row{display:flex;align-items:center;gap:.4rem;margin-bottom:.9rem}
    .step-c{width:1.4rem;height:1.4rem;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.6rem;font-weight:700;border:1px solid var(--bdr);background:var(--bg2);color:var(--t3)}
    .step-c.done{background:var(--amber);border-color:var(--amber);color:var(--bg)}
    .step-l{width:1.2rem;height:1px;background:var(--bdr)}
    .step-l.done{background:var(--amber)}
    .step-txt{font-size:.65rem;text-transform:uppercase;letter-spacing:.08em;color:var(--t3)}
    .step-txt.done{color:var(--t2)}
    .alert-row{display:flex;align-items:center;gap:.75rem;border:1px solid rgba(202,138,4,.5);border-radius:.375rem;padding:.75rem;background:rgba(120,53,15,.2);margin-bottom:.4rem}
    /* LOGIN */
    .full-center{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1.5rem}
    .login-box{width:100%;max-width:22rem}
    .tab-bar{display:flex;gap:.2rem;background:var(--bg);border-radius:.375rem;padding:.2rem;margin-bottom:1rem}
    .tab{flex:1;padding:.35rem;text-align:center;font-size:.65rem;font-family:inherit;text-transform:uppercase;letter-spacing:.1em;border-radius:.25rem;border:none;cursor:pointer;background:transparent;color:var(--t3);transition:all .15s}
    .tab.active{background:var(--amber);color:var(--bg)}
    /* CHART */
    .chart-svg{width:100%;overflow:hidden}
    /* SEARCH */
    .search-inp{background:var(--bg);border:1px solid var(--bdr);color:var(--t1);border-radius:.375rem;padding:.4rem .7rem;font-size:.8rem;font-family:inherit;outline:none;width:14rem}
    .search-inp:focus{border-color:var(--amber)}
    /* SPIN */
    .spin{display:inline-block;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* AI PANEL */
    .ai-wrap{display:flex;flex-direction:column;height:calc(100vh - 8rem);max-height:800px}
    .ai-messages{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:.6rem;padding:.5rem 0;min-height:0}
    .ai-msg{display:flex;flex-direction:column;gap:.25rem;animation:fadeUp .2s ease}
    @keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    .ai-msg-user{align-items:flex-end}
    .ai-msg-ai{align-items:flex-start}
    .ai-bubble{max-width:82%;padding:.6rem .85rem;border-radius:.5rem;font-size:.8rem;line-height:1.6;white-space:pre-wrap;word-break:break-word}
    .ai-bubble-user{background:var(--amber);color:#1a0a00;font-weight:600;border-radius:.5rem .5rem .1rem .5rem}
    .ai-bubble-ai{background:var(--bg2);border:1px solid var(--bg3);color:var(--t1);border-radius:.5rem .5rem .5rem .1rem}
    .ai-cmd-block{margin-top:.4rem;max-width:82%;border:1px solid rgba(202,138,4,.35);background:rgba(120,53,15,.12);border-radius:.375rem;padding:.5rem .8rem;font-size:.72rem;font-family:'Courier New',monospace}
    .ai-cmd-row{display:flex;align-items:center;gap:.4rem;margin-bottom:.2rem}
    .ai-cmd-action{color:var(--amber);font-weight:700;text-transform:uppercase;font-size:.65rem;letter-spacing:.1em}
    .ai-cmd-detail{color:var(--t3);font-size:.68rem}
    .ai-cmd-ok{color:#6ee7b7}
    .ai-cmd-err{color:#f87171}
    .ai-input-row{display:flex;gap:.5rem;padding-top:.6rem;border-top:1px solid var(--bg3);flex-shrink:0}
    .ai-inp{flex:1;background:var(--bg);border:1px solid var(--bdr);color:var(--t1);border-radius:.375rem;padding:.55rem .8rem;font-size:.82rem;font-family:'Courier New',monospace;outline:none;resize:none;height:2.6rem;transition:border-color .15s}
    .ai-inp:focus{border-color:var(--amber)}
    .ai-send{background:var(--amber);color:var(--bg);border:none;border-radius:.375rem;padding:.5rem 1rem;font-size:.8rem;font-family:inherit;font-weight:700;cursor:pointer;transition:background .15s;flex-shrink:0}
    .ai-send:hover{background:var(--amber2)}
    .ai-send:disabled{opacity:.5;cursor:not-allowed}
    .ai-chip{display:inline-flex;align-items:center;gap:.3rem;background:rgba(202,138,4,.15);border:1px solid rgba(202,138,4,.3);border-radius:.25rem;padding:.1rem .4rem;font-size:.6rem;font-family:'Courier New',monospace;color:var(--amber);margin:.1rem}
    .ai-hint-btn{display:inline-block;background:var(--bg3);border:1px solid var(--bdr);border-radius:.25rem;padding:.25rem .55rem;font-size:.68rem;font-family:inherit;color:var(--t2);cursor:pointer;margin:.15rem;transition:background .15s}
    .ai-hint-btn:hover{background:var(--bdr);color:var(--t1)}
    /* EDIT ASSET FORM */
    .edit-form{background:var(--bg2);border:1px solid rgba(202,138,4,.35);border-radius:.5rem;padding:1rem;margin-bottom:1rem}
    .edit-grid{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
    @media(max-width:600px){.edit-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div id="toast"></div>
<div id="root"><div style="color:#f59e0b;padding:2rem;font-family:monospace">â— Loading HourTrackâ€¦</div></div>

<script>
// â”€â”€ CATCH ALL ERRORS AND SHOW ON SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onerror = function(msg,src,line){
  document.getElementById('root').innerHTML =
    '<div style="padding:2rem;font-family:monospace;color:#f87171;max-width:600px">'+
    '<h3 style="margin-bottom:.5rem">âš  JavaScript Error</h3>'+
    '<p style="color:#e4e4e7">'+esc(msg)+'</p>'+
    '<p style="color:#71717a;font-size:.75rem;margin-top:.5rem">Line: '+line+'</p>'+
    '<p style="color:#71717a;font-size:.75rem;margin-top:.5rem">Open browser console (F12) for full details.</p></div>';
};

// â•â• CONFIG â€” REPLACE THESE TWO VALUES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var SUPABASE_URL = 'https://omtkabzcxudyiionloju.supabase.co';
var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tdGthYnpjeHVkeWlpb25sb2p1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2OTIyOTYsImV4cCI6MjA4NzI2ODI5Nn0.iE3r_O-qhzeQHj7FvSy76DEB4EJVfgrxmDHjYzsSHbk';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var CONFIGURED = SUPABASE_URL.indexOf('YOUR_') === -1;
var DB = CONFIGURED ? supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : null;

// â”€â”€ MONTHS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var now = new Date();
var MONTHS = (function(){
  var arr=[];
  for(var i=0;i<12;i++){
    var d=new Date(now.getFullYear(),now.getMonth()-11+i,1);
    arr.push(d.getFullYear()+'-'+pad2(d.getMonth()+1)+'-01');
  }
  return arr;
})();
var CUR_MONTH = MONTHS[MONTHS.length-1];
var PREV_MONTH = MONTHS[MONTHS.length-2];

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var S = {
  view: 'loading',       // loading|setup|login|app
  appTab: 'dashboard',   // dashboard|assets|entry|replacements|reports|audit|users
  session: null,
  userRole: 'viewer',
  assets: [], readings: [], repls: [], audit: [], closed: [],
  detailId: null,
  assetSearch: '',
  entryMonth: CUR_MONTH,
  entryPending: {},      // assetId -> value string (for monthly entry)
  entryResults: {},      // assetId -> {status,message}
  replStep: 0,
  replAssetId: '', replLastReading: '', replNotes: '',
  replConf: null,
  loginMode: 'login',
  loginEmail: '', loginPw: '', loginErr: '', loginMsg: '', loginBusy: false,
  addAssetOpen: false,
  addAssetBusy: false,
  aiMessages: [],
  aiInput: '',
  aiLoading: false,
  jumpThreshold: 800,
  editingAssetId: null,
  editFields: {}
};

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pad2(n){ return n<10?'0'+n:String(n); }
function fmtMonth(m){ return new Date(m+'T12:00:00Z').toLocaleDateString('en-US',{month:'short',year:'numeric'}); }
function getMotorType(loc){
  if(!loc) return 'unknown';
  var u=loc.toUpperCase();
  if(u.indexOf('CB')>=0) return 'MV';
  if(u.indexOf('CC')>=0) return 'LV';
  return 'unknown';
}
function getMeterMax(a){
  var t=getMotorType(a.location||'');
  if(t==='MV') return 65535;
  if(t==='LV') return 10000;
  return a.meter_max_value||9999;
}
function calcAcc(a,raw){
  return a.reset_count*getMeterMax(a)+a.stuck_reading+(raw||0);
}
function uid(){ return Date.now()+'-'+Math.random().toString(36).slice(2,6); }
function esc(s){
  if(s===null||s===undefined) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function badge(v){
  var m={OK:'b-ok',WARNING:'b-warn',CRITICAL:'b-crit',RESET:'b-reset',ROLLOVER:'b-reset'};
  return '<span class="badge '+(m[v]||'b-ok')+'">'+esc(v)+'</span>';
}
function roleBadge(r){
  var c=r==='admin'?'rt-admin':r==='engineer'?'rt-engineer':'rt-viewer';
  return '<span class="role-tag '+c+'">'+esc(r.toUpperCase())+'</span>';
}
function fmtNum(n){ return typeof n==='number'?n.toLocaleString():String(n||'â€”'); }
function validateReading(asset, readings, val, month){
  if(val<0) return {status:'CRITICAL',message:'Negative reading not allowed.'};
  var meterMax=getMeterMax(asset);
  var jt=(asset.threshold_hours&&asset.threshold_hours!==200)?asset.threshold_hours:(S.jumpThreshold||800);
  var prev=null, best='';
  for(var i=0;i<readings.length;i++){
    var r=readings[i];
    if(r.asset_id===asset.id && r.month<month && r.month>best){ best=r.month; prev=r; }
  }
  if(!prev) return {status:'OK',message:'First reading for this asset.'};
  var diff=val-prev.raw_meter_reading;
  if(diff<0){
    // Check if this is a natural counter rollover
    var wrapped=meterMax-prev.raw_meter_reading+val;
    if(wrapped>=0&&wrapped<=jt*2){
      return {status:'RESET',message:'Counter rollover at '+meterMax+' hrs. Wrapped Î”: +'+wrapped+' hrs. Log in Replacements tab to increment reset count.'};
    }
    return {status:'CRITICAL',message:'Reading dropped by '+Math.abs(diff)+' hrs â€” data error or missed rollover?'};
  }
  if(diff>jt*1.5) return {status:'CRITICAL',message:'+'+diff+' hrs â€” abnormal jump! Normal max: '+jt+' hrs/mo.'};
  if(diff>jt) return {status:'WARNING',message:'+'+diff+' hrs exceeds normal jump of '+jt+' hrs/mo.'};
  return {status:'OK',message:'+'+diff+' hrs this month.'};
}
function exportCSV(data, filename){
  if(!data.length) return;
  var keys=Object.keys(data[0]);
  var rows=[keys.join(',')].concat(data.map(function(r){
    return keys.map(function(k){ return '"'+(r[k]===null||r[k]===undefined?'':r[k])+'"'; }).join(',');
  }));
  var a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(rows.join('\n'));
  a.download=filename; a.click();
}
function svgChart(data, keys, colors, h){
  h=h||160;
  var all=[];
  data.forEach(function(d){ keys.forEach(function(k){ if(d[k]!=null&&!isNaN(d[k])) all.push(d[k]); }); });
  if(!all.length) return '<p class="dim sm" style="padding:.5rem 0">No data yet â€” add readings to see trend.</p>';
  var minY=Math.min.apply(null,all),maxY=Math.max.apply(null,all),range=maxY-minY||1;
  var W=800,H=h,pl=62,pr=10,pt=8,pb=26,iW=W-pl-pr,iH=H-pt-pb;
  function tx(i){ return pl+i*(iW/Math.max(data.length-1,1)); }
  function ty(v){ return pt+iH-((v-minY)/range)*iH; }
  var yLines='',step=Math.ceil(data.length/6);
  [0,.25,.5,.75,1].forEach(function(f){
    var v=Math.round(minY+range*f),y=ty(v);
    yLines+='<line x1="'+pl+'" y1="'+y+'" x2="'+(W-pr)+'" y2="'+y+'" stroke="#27272a" stroke-dasharray="3,3"/>';
    yLines+='<text x="'+(pl-4)+'" y="'+(y+4)+'" text-anchor="end" fill="#71717a" font-size="10" font-family="monospace">'+(v>9999?(v/1000).toFixed(0)+'k':v)+'</text>';
  });
  var labels='';
  data.forEach(function(d,i){
    if(i%step===0||i===data.length-1)
      labels+='<text x="'+tx(i)+'" y="'+(H-4)+'" text-anchor="middle" fill="#71717a" font-size="9" font-family="monospace">'+esc(d.label)+'</text>';
  });
  var lines='';
  keys.forEach(function(k,ki){
    var pts=data.map(function(d,i){ return (d[k]!=null&&!isNaN(d[k]))?tx(i)+','+ty(d[k]):null; }).filter(Boolean);
    if(pts.length>=2) lines+='<path d="M'+pts.join('L')+'" fill="none" stroke="'+(colors[ki]||'#f59e0b')+'" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>';
  });
  var legend='<div class="flex" style="margin-top:.4rem">';
  keys.forEach(function(k,ki){
    legend+='<div class="flex xs dim" style="gap:.3rem"><div style="width:14px;height:2px;background:'+(colors[ki]||'#f59e0b')+';border-radius:1px;margin-top:5px"></div>'+esc(k)+'</div>';
  });
  legend+='</div>';
  return '<svg class="chart-svg" viewBox="0 0 '+W+' '+H+'" style="height:'+h+'px">'+yLines+labels+lines+'</svg>'+legend;
}

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var _toastTimer=null;
function toast(msg,type){
  var el=document.getElementById('toast');
  if(!el) return;
  el.textContent=msg;
  el.className='t-'+(type||'info');
  el.style.display='block';
  clearTimeout(_toastTimer);
  _toastTimer=setTimeout(function(){ el.style.display='none'; },4000);
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render(){
  var root=document.getElementById('root');
  if(!root) return;
  if(!CONFIGURED){ root.innerHTML=renderSetup(); return; }
  if(S.view==='loading'){ root.innerHTML='<div style="color:#f59e0b;padding:2rem;font-family:monospace">â— Connectingâ€¦</div>'; return; }
  if(S.view==='login'){ root.innerHTML=renderLogin(); return; }
  root.innerHTML=renderApp();
}

// â”€â”€ SETUP SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSetup(){
  return '<div class="full-center">'+
    '<div style="max-width:34rem;width:100%" class="card card-amber">'+
    '<div class="flex" style="margin-bottom:1rem">'+
    '<div class="logo-icon">H</div>'+
    '<div><div class="logo-text">HourTrack</div><div class="dim xs">Setup Required</div></div></div>'+
    '<div class="amber bold sm" style="margin-bottom:.5rem">âš™ One-Time Configuration</div>'+
    '<p class="sm" style="color:#a1a1aa;margin-bottom:.7rem">Open <b style="color:#fbbf24">index.html</b> in Notepad and replace the two values near the top:</p>'+
    '<div style="background:var(--bg);border:1px solid var(--bdr);border-radius:.375rem;padding:.9rem;font-size:.72rem;font-family:monospace;margin-bottom:.7rem;line-height:1.8">'+
    '<span style="color:#71717a">// Replace these two lines:</span><br>'+
    '<span style="color:#fbbf24">var SUPABASE_URL = \'YOUR_SUPABASE_URL_HERE\';</span><br>'+
    '<span style="color:#fbbf24">var SUPABASE_KEY = \'YOUR_SUPABASE_ANON_KEY_HERE\';</span>'+
    '</div>'+
    '<p class="xs dim">Find both values in Supabase â†’ Settings â†’ API</p>'+
    '<p class="xs dim" style="margin-top:.3rem">See README.md for the full step-by-step guide.</p>'+
    '</div></div>';
}

// â”€â”€ LOGIN SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLogin(){
  var isLogin=S.loginMode==='login';
  return '<div class="full-center">'+
    '<div class="login-box">'+
    '<div class="flex" style="justify-content:center;margin-bottom:1.5rem">'+
    '<div class="logo-icon">H</div>'+
    '<div><div class="logo-text">HourTrack</div><div class="xs dim">Industrial Runtime Management</div></div></div>'+
    '<div class="card">'+
    '<div class="tab-bar">'+
    '<button class="tab'+(isLogin?' active':'')+'" onclick="setLoginMode(\'login\')">Sign In</button>'+
    '<button class="tab'+(!isLogin?' active':'')+'" onclick="setLoginMode(\'signup\')">Sign Up</button>'+
    '</div>'+
    (S.loginMsg?'<div style="color:#86efac;font-size:.75rem;padding:.6rem;background:#052e16;border:1px solid #166534;border-radius:.375rem;margin-bottom:.7rem">'+esc(S.loginMsg)+'</div>':'')+
    (S.loginErr?'<div style="color:#fca5a5;font-size:.75rem;padding:.6rem;background:#450a0a;border:1px solid #991b1b;border-radius:.375rem;margin-bottom:.7rem">'+esc(S.loginErr)+'</div>':'')+
    '<div class="fg"><label class="lbl">Email</label>'+
    '<input id="l-email" class="inp" type="email" value="'+esc(S.loginEmail)+'" oninput="S.loginEmail=this.value" placeholder="you@company.com" onkeydown="if(event.key===\'Enter\')doLogin()"></div>'+
    '<div class="fg"><label class="lbl">Password</label>'+
    '<input id="l-pw" class="inp" type="password" value="'+esc(S.loginPw)+'" oninput="S.loginPw=this.value" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key===\'Enter\')doLogin()"></div>'+
    '<button class="btn btn-p" style="width:100%;justify-content:center" onclick="doLogin()" '+(S.loginBusy?'disabled':'')+'>'+
    (S.loginBusy?'<span class="spin">â—</span> &nbsp;Please waitâ€¦':isLogin?'Sign In â†’':'Create Account â†’')+'</button>'+
    '</div></div>';
}

// â”€â”€ FULL APP SHELL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderApp(){
  var tabs=['dashboard','assets','entry','replacements','reports','audit'];
  if(S.userRole==='admin') tabs.push('users');
  if(S.userRole==='admin') tabs.push('ai');
  var _navL={dashboard:'Dashboard',assets:'Assets',entry:'Monthly Entry',replacements:'Replacements',reports:'Reports',audit:'Audit Log',users:'Users',ai:'âš¡ AI Admin'};
  var navHTML=tabs.map(function(t){
    var sty=t==='ai'?' style="color:var(--amber)"':'';
    return '<button class="nav-btn'+(S.appTab===t?' active':'')+'"'+sty+' onclick="goTab(\''+t+'\')">'+(_navL[t]||t)+'</button>';
  }).join('');
  var rc=S.userRole==='admin'?'rt-admin':S.userRole==='engineer'?'rt-engineer':'rt-viewer';
  return '<div id="header">'+
    '<div class="hdr-row">'+
    '<div class="logo"><div class="logo-icon">H</div>'+
    '<div><div class="logo-text">HourTrack</div><div class="logo-sub">Industrial Runtime</div></div></div>'+
    '<div class="hdr-ctrl">'+
    '<span class="role-tag '+rc+'">'+esc(S.userRole.toUpperCase())+'</span>'+
    '<span class="email-tag">'+esc(S.session.user.email)+'</span>'+
    '<button class="icon-btn" onclick="loadData()">â†» Sync</button>'+
    '<button class="icon-btn" style="color:#f87171" onclick="doLogout()">Sign Out</button>'+
    '</div></div>'+
    '<div id="nav">'+navHTML+'</div>'+
    '</div>'+
    '<div id="main" class="space">'+renderTab()+'</div>';
}

function renderTab(){
  var t=S.appTab;
  if(t==='dashboard') return renderDashboard();
  if(t==='assets') return S.detailId ? renderAssetDetail() : renderAssets();
  if(t==='entry') return renderEntry();
  if(t==='replacements') return renderReplacements();
  if(t==='reports') return renderReports();
  if(t==='audit') return renderAudit();
  if(t==='users') return renderUsers();
  if(t==='ai') return renderAI();
  return '';
}

// â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDashboard(){
  var activeAssets=S.assets.filter(function(a){ return a.active_status; });
  var warnings=0,criticals=0;
  S.readings.forEach(function(r){ if(r.month===CUR_MONTH){ if(r.validation==='WARNING')warnings++; if(r.validation==='CRITICAL')criticals++; } });

  var statCards=[
    {label:'Active Assets',val:activeAssets.length,color:'amber'},
    {label:'Warnings',val:warnings,color:'amber'},
    {label:'Critical',val:criticals,color:'red'},
    {label:'Current Period',val:fmtMonth(CUR_MONTH),color:'green',sm:1},
  ];

  var statsHTML='<div class="grid4">'+statCards.map(function(c){
    return '<div class="card"><div class="xs dim" style="text-transform:uppercase;letter-spacing:.15em;margin-bottom:.4rem">'+c.label+'</div>'+
      '<div class="'+(c.sm?'sm':'bold')+'" style="font-size:'+(c.sm?'1rem':'1.6rem')+';color:var(--'+c.color+')">'+(typeof c.val==='string'?c.val:c.val)+'</div></div>';
  }).join('')+'</div>';

  var tableRows='';
  if(activeAssets.length===0){
    tableRows='<tr><td colspan="8" style="color:#71717a;text-align:center;padding:1.5rem">No assets â€” run seed_data.sql in Supabase then click â†» Sync</td></tr>';
  } else {
    activeAssets.forEach(function(a){
      var srt=S.readings.filter(function(r){ return r.asset_id===a.id; }).sort(function(x,y){ return y.month.localeCompare(x.month); });
      var lat=srt[0],prv=srt[1];
      var acc=calcAcc(a,lat?lat.raw_meter_reading:0);
      var delta=(lat&&prv)?(lat.raw_meter_reading-prv.raw_meter_reading):null;
      var v=lat?lat.validation:'OK';
      var pct=Math.min(100,(acc/(getMeterMax(a)*5))*100);
      var barC=pct>85?'bar-r':pct>60?'bar-a':'bar-g';
      var dc=delta!==null&&delta>(S.jumpThreshold||800)?'amber':'green';
      tableRows+='<tr class="tr-click" onclick="openAssetDetail(\''+esc(a.id)+'\')">'+
        '<td><div class="bold xs" style="color:#e4e4e7">'+esc(a.name)+'</div><div class="xs dim">'+esc(a.id)+'</div></td>'+
        '<td class="xs dim">'+esc(a.location)+'</td>'+
        '<td>'+(lat?lat.raw_meter_reading.toLocaleString():'â€”')+' hrs</td>'+
        '<td><div class="amber bold">'+acc.toLocaleString()+' hrs</div>'+
        '<div class="progbar"><div class="progfill '+barC+'" style="width:'+pct+'%"></div></div></td>'+
        '<td>'+(delta!==null?'<span class="'+dc+'">+'+delta+' hrs</span>':'â€”')+'</td>'+
        '<td>'+a.reset_count+'Ã—</td>'+
        '<td>'+badge(v)+'</td>'+
        '<td class="dim xs">â†’</td>'+
        '</tr>';
    });
  }

  var replHTML='';
  if(S.repls.length===0){
    replHTML='<p class="dim sm">No replacements logged yet.</p>';
  } else {
    S.repls.slice().reverse().slice(0,4).forEach(function(r){
      var a=S.assets.find(function(x){ return x.id===r.asset_id; });
      replHTML+='<div style="border-left:2px solid var(--amber);padding:.4rem .7rem;margin-bottom:.6rem">'+
        '<div class="sm bold" style="color:var(--t1)">'+esc(a?a.name:r.asset_id)+'</div>'+
        '<div class="xs dim">'+fmtMonth(r.replacement_date)+' â€” Reset #'+r.new_reset_count+' â€” Stuck: '+(r.last_stuck_reading||0).toLocaleString()+' hrs</div>'+
        (r.notes?'<div class="xs" style="color:#52525b;margin-top:.15rem;font-style:italic">'+esc(r.notes)+'</div>':'')+
        '</div>';
    });
  }

  var chartData=MONTHS.map(function(m){
    var e={label:fmtMonth(m)};
    S.assets.slice(0,2).forEach(function(a){
      var r=S.readings.find(function(rd){ return rd.asset_id===a.id&&rd.month===m; });
      e[a.name]=r?calcAcc(a,r.raw_meter_reading):null;
    });
    return e;
  });
  var chartKeys=S.assets.slice(0,2).map(function(a){ return a.name; });

  return statsHTML+
    (activeAssets.length===0?'<div class="card card-amber"><div class="amber bold sm" style="margin-bottom:.4rem">ğŸ‘‹ Welcome to HourTrack!</div><p class="sm" style="color:#a1a1aa">Your 153 motors will appear here after running setup.sql and seed_data.sql in Supabase, then clicking â†» Sync.</p></div>':
    '<div class="card">'+
    '<div class="stitle">Asset Runtime Status â€” '+fmtMonth(CUR_MONTH)+'</div>'+
    '<div class="tbl-wrap"><table><thead><tr>'+
    '<th>Asset</th><th>Location</th><th>Latest Rdg</th><th>Accumulated</th><th>Monthly Î”</th><th>Resets</th><th>Status</th><th></th>'+
    '</tr></thead><tbody>'+tableRows+'</tbody></table></div></div>')+
    '<div class="grid-2col">'+
    '<div class="card"><div class="stitle">Recent Replacements</div>'+replHTML+'</div>'+
    '<div class="card"><div class="stitle">Accumulated Trend</div>'+svgChart(chartData,chartKeys,['#f59e0b','#6ee7b7'],160)+'</div>'+
    '</div>'+
    '<div class="flex" style="margin-top:-.2rem">'+
    '<button class="btn btn-p" onclick="goTab(\'entry\')">+ Add Reading</button>'+
    '<button class="btn btn-s" onclick="goTab(\'replacements\')">â†º Replace Meter</button>'+
    '<button class="btn btn-s" onclick="closeMonth()">âŠ  Close Month</button>'+
    '<button class="btn btn-s" onclick="goTab(\'reports\')">â†“ Reports</button>'+
    '</div>';
}

// â”€â”€ ASSETS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAssets(){
  var q=S.assetSearch.toLowerCase();
  var filtered=S.assets.filter(function(a){
    return !q||a.name.toLowerCase().indexOf(q)>=0||a.id.toLowerCase().indexOf(q)>=0||a.location.toLowerCase().indexOf(q)>=0;
  });
  var canEdit=S.userRole==='admin'||S.userRole==='engineer';
  var addForm='';
  if(S.addAssetOpen){
    addForm='<div class="card card-amber">'+
      '<div class="xs amber bold" style="text-transform:uppercase;letter-spacing:.15em;margin-bottom:.8rem">Register New Asset</div>'+
      '<div class="grid2">'+
      '<div class="fg"><label class="lbl">Tag Name *</label><input id="na-name" class="inp" placeholder="Motor tag no." value=""></div>'+
      '<div class="fg"><label class="lbl">Location / Drawer</label><input id="na-loc" class="inp" placeholder="Panel 185CC12A +03.17" value="" oninput="autoFillMeterMax(this.value)"></div>'+
      '<div class="fg"><label class="lbl" id="na-max-lbl">Meter Max Value</label><input id="na-max" class="inp" type="number" value="9999"></div>'+
      '<div class="fg"><label class="lbl">Monthly Jump Threshold (hrs) â€” leave blank for global default ('+((S.jumpThreshold)||800)+')</label><input id="na-thr" class="inp" type="number" value=""></div>'+
      '</div>'+
      '<div class="flex"><button class="btn btn-p" onclick="submitAddAsset()" '+(S.addAssetBusy?'disabled':'')+'>'+
      (S.addAssetBusy?'Savingâ€¦':'Register Asset')+'</button>'+
      '<button class="btn btn-s" onclick="S.addAssetOpen=false;render()">Cancel</button></div>'+
      '</div>';
  }
  var rows=filtered.length===0?
    '<tr><td colspan="7" style="color:#71717a;text-align:center;padding:1rem">No assets found.</td></tr>':
    filtered.map(function(a){
      return '<tr class="tr-click" onclick="openAssetDetail(\''+esc(a.id)+'\')">'+
        '<td class="amber xs">'+esc(a.id)+'</td>'+
        '<td><span class="bold xs" style="color:#e4e4e7">'+esc(a.name)+'</span></td>'+
        '<td class="xs dim">'+esc(a.location)+'</td>'+
        '<td><span class="xs '+(getMotorType(a.location)==='MV'?'sky':'green')+'">'+(getMotorType(a.location)==='MV'?'MV':'LV')+' '+getMeterMax(a).toLocaleString()+'</span></td>'+
        '<td>'+a.reset_count+'</td>'+
        '<td>'+(S.jumpThreshold||800)+' hrs/mo</td>'+
        '<td class="dim xs">â†’</td></tr>';
    }).join('');
  return '<div class="row">'+
    '<div class="ptitle">Asset Registry <span class="sm dim">('+filtered.length+'/'+S.assets.length+')</span></div>'+
    '<div class="flex">'+
    '<input class="search-inp" placeholder="Search tag, name, locationâ€¦" value="'+esc(S.assetSearch)+'" oninput="S.assetSearch=this.value;renderAssetList()">'+
    (canEdit?'<button class="btn btn-p" onclick="S.addAssetOpen=!S.addAssetOpen;render()">+ New Asset</button>':'')+
    '</div></div>'+
    addForm+
    '<div class="card">'+
    '<div class="tbl-wrap"><table><thead><tr>'+
    '<th>ID</th><th>Name</th><th>Location / Drawer</th><th>Meter Max</th><th>Resets</th><th>Threshold</th><th></th>'+
    '</tr></thead><tbody id="asset-tbody">'+rows+'</tbody></table></div></div>';
}
function renderAssetList(){
  var tbody=document.getElementById('asset-tbody');
  if(!tbody) return;
  var q=S.assetSearch.toLowerCase();
  var filtered=S.assets.filter(function(a){ return !q||a.name.toLowerCase().indexOf(q)>=0||a.id.toLowerCase().indexOf(q)>=0||a.location.toLowerCase().indexOf(q)>=0; });
  tbody.innerHTML=filtered.length===0?
    '<tr><td colspan="7" style="color:#71717a;text-align:center;padding:1rem">No assets found.</td></tr>':
    filtered.map(function(a){
      return '<tr class="tr-click" onclick="openAssetDetail(\''+esc(a.id)+'\')">'+
        '<td class="amber xs">'+esc(a.id)+'</td>'+
        '<td><span class="bold xs" style="color:#e4e4e7">'+esc(a.name)+'</span></td>'+
        '<td class="xs dim">'+esc(a.location)+'</td>'+
        '<td><span class="xs '+(getMotorType(a.location)==='MV'?'sky':'green')+'">'+(getMotorType(a.location)==='MV'?'MV':'LV')+' '+getMeterMax(a).toLocaleString()+'</span></td>'+
        '<td>'+a.reset_count+'</td>'+
        '<td>'+(S.jumpThreshold||800)+' hrs/mo</td>'+
        '<td class="dim xs">â†’</td></tr>';
    }).join('');
  // Update count
  var titleEl=document.querySelector('.ptitle');
  if(titleEl) titleEl.innerHTML='Asset Registry <span class="sm dim">('+filtered.length+'/'+S.assets.length+')</span>';
}

function renderAssetDetail(){
  var a=S.assets.find(function(x){ return x.id===S.detailId; });
  if(!a) return '<div class="card"><p class="dim">Asset not found.</p></div>';
  var ar=S.readings.filter(function(r){ return r.asset_id===a.id; }).sort(function(x,y){ return x.month.localeCompare(y.month); });
  var lat=ar[ar.length-1];
  var acc=calcAcc(a,lat?lat.raw_meter_reading:0);
  var assetRepls=S.repls.filter(function(r){ return r.asset_id===a.id; });

  var _mtype=getMotorType(a.location);
  var _mmax=getMeterMax(a);
  var statCards=[
    {l:'Accumulated Runtime',v:acc.toLocaleString()+' hrs',c:'amber'},
    {l:'Motor Type',v:(_mtype==='MV'?'MV â€” '+_mmax.toLocaleString()+' hr counter':_mtype==='LV'?'LV â€” '+_mmax.toLocaleString()+' hr counter':'Unknown â€” '+_mmax.toLocaleString()),c:_mtype==='MV'?'sky':'green'},
    {l:'Reset Count',v:a.reset_count,c:'sky'},
    {l:'Latest Raw',v:lat?lat.raw_meter_reading.toLocaleString()+' hrs':'â€”',c:'t2'},
  ];

  var chartData=ar.map(function(r,i){
    return {label:fmtMonth(r.month),'Accumulated':calcAcc(a,r.raw_meter_reading),'Monthly Î”':i>0?r.raw_meter_reading-ar[i-1].raw_meter_reading:0};
  });

  var rows=ar.map(function(r,i){
    var prev=ar[i-1];
    var delta=prev?r.raw_meter_reading-prev.raw_meter_reading:null;
    var dc=delta===null?'dim':delta<0?'red':delta>(S.jumpThreshold||800)?'amber':'green';
    return '<tr>'+
      '<td>'+fmtMonth(r.month)+'</td>'+
      '<td>'+r.raw_meter_reading.toLocaleString()+' hrs</td>'+
      '<td>'+(delta!==null?'<span class="'+dc+'">+'+delta+'</span>':'â€”')+'</td>'+
      '<td class="amber">'+calcAcc(a,r.raw_meter_reading).toLocaleString()+'</td>'+
      '<td>'+badge(r.validation)+'</td>'+
      '<td>'+(r.locked?'<span class="dim xs">ğŸ”’ Locked</span>':'<span class="green xs">Open</span>')+'</td>'+
      '<td class="dim xs">'+esc(r.created_by)+'</td>'+
      '</tr>';
  }).join('');

  // Inline edit form
  var editFormHTML='';
  if(S.editingAssetId===a.id){
    var ef=S.editFields;
    editFormHTML='<div class="edit-form">'+
      '<div class="xs amber bold" style="text-transform:uppercase;letter-spacing:.15em;margin-bottom:.75rem">âœ Edit Asset â€” '+esc(a.id)+'</div>'+
      '<div class="edit-grid">'+
      '<div class="fg"><label class="lbl">Tag Name</label><input id="ef-name" class="inp" value="'+esc(ef.name||a.name)+'"></div>'+
      '<div class="fg"><label class="lbl">Location / Drawer</label><input id="ef-loc" class="inp" value="'+esc(ef.location||a.location||'')+'"></div>'+
      '<div class="fg"><label class="lbl">Meter Max Value (auto: '+(getMotorType(a.location)==='MV'?'65535 MV':getMotorType(a.location)==='LV'?'10000 LV':'from location')+')</label><input id="ef-max" class="inp" type="number" value="'+(ef.meter_max_value!==undefined?ef.meter_max_value:a.meter_max_value)+'"></div>'+
      '<div class="fg"><label class="lbl">Monthly Jump Threshold (0 = use global '+(S.jumpThreshold||800)+' hrs)</label><input id="ef-thr" class="inp" type="number" value="'+(ef.threshold_hours!==undefined?ef.threshold_hours:a.threshold_hours)+'"></div>'+
      '<div class="fg"><label class="lbl">Stuck Reading (accumulated override)</label><input id="ef-stuck" class="inp" type="number" value="'+(ef.stuck_reading!==undefined?ef.stuck_reading:a.stuck_reading)+'"></div>'+
      '<div class="fg"><label class="lbl">Reset Count</label><input id="ef-reset" class="inp" type="number" value="'+(ef.reset_count!==undefined?ef.reset_count:a.reset_count)+'"></div>'+
      '</div>'+
      '<div class="fg"><label class="lbl">Active Status</label>'+
      '<select id="ef-active" class="sel">'+
      '<option value="true"'+(a.active_status?' selected':'')+'>Active</option>'+
      '<option value="false"'+(!a.active_status?' selected':'')+'>Inactive / Retired</option>'+
      '</select></div>'+
      '<div class="flex" style="margin-top:.5rem">'+
      '<button class="btn btn-p" onclick="saveAssetEdits(\''+esc(a.id)+'\')" >Save Changes</button>'+
      '<button class="btn btn-s" onclick="S.editingAssetId=null;S.editFields={};render()">Cancel</button>'+
      '</div></div>';
  }

  return '<div class="flex" style="margin-bottom:.8rem">'+
    '<button class="btn btn-s xs" onclick="S.detailId=null;S.editingAssetId=null;S.editFields={};render()">â† Back</button>'+
    '<div style="flex:1"><div class="ptitle">'+esc(a.name)+'</div><div class="xs dim">'+esc(a.id)+' â€” '+esc(a.location)+'</div></div>'+
    (S.userRole==='admin'?'<button class="btn btn-s" style="font-size:.72rem" onclick="S.editingAssetId=S.editingAssetId===\''+(a.id)+'\''+'?null:\''+(a.id)+'\';'+'S.editFields={};render()">âœ Edit Asset</button>':'')+
    '</div>'+editFormHTML+
    '<div class="grid4">'+statCards.map(function(c){ return '<div class="card"><div class="xs dim" style="text-transform:uppercase;letter-spacing:.12em;margin-bottom:.3rem">'+c.l+'</div><div class="bold" style="font-size:1.3rem;color:var(--'+c.c+')">'+esc(String(c.v))+'</div></div>'; }).join('')+'</div>'+
    '<div class="card card-amber"><div class="xs amber bold" style="text-transform:uppercase;letter-spacing:.15em;margin-bottom:.5rem">Runtime Formula</div>'+
    '<div class="formula"><span class="sky bold">'+a.reset_count+'</span><span class="dim"> Ã— </span>'+
    '<span>'+getMeterMax(a).toLocaleString()+'</span><span class="dim"> + </span>'+
    '<span>'+a.stuck_reading.toLocaleString()+'</span><span class="dim"> + </span>'+
    '<span>'+(lat?lat.raw_meter_reading:0)+'</span><span class="dim"> = </span>'+
    '<span class="amber bold">'+acc.toLocaleString()+' hrs</span></div></div>'+
    '<div class="card"><div class="stitle">Runtime Trend</div>'+
    svgChart(chartData,['Accumulated','Monthly Î”'],['#f59e0b','#6ee7b7'],200)+
    (assetRepls.length?'<p class="xs sky" style="margin-top:.4rem">Meter resets: '+assetRepls.map(function(r){ return fmtMonth(r.replacement_date); }).join(', ')+'</p>':'')+
    '</div>'+
    '<div class="card"><div class="stitle">Reading History</div><div class="tbl-wrap"><table><thead><tr>'+
    '<th>Month</th><th>Raw</th><th>Monthly Î”</th><th>Accumulated</th><th>Status</th><th>Locked</th><th>By</th>'+
    '</tr></thead><tbody>'+rows+'</tbody></table></div></div>';
}

// â”€â”€ MONTHLY ENTRY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderEntry(){
  var isLocked=S.closed.indexOf(S.entryMonth)>=0;
  var canEdit=(S.userRole==='admin'||S.userRole==='engineer')&&!isLocked;

  var monthOpts=MONTHS.map(function(m){ return '<option value="'+m+'"'+(S.entryMonth===m?' selected':'')+'>'+fmtMonth(m)+'</option>'; }).join('');

  if(S.assets.length===0){
    return '<div class="row"><div class="ptitle">Monthly Entry</div></div>'+
      '<div class="card"><p class="dim sm">No assets â€” run seed_data.sql in Supabase and click â†» Sync.</p></div>';
  }

  var rows=S.assets.filter(function(a){ return a.active_status; }).map(function(a){
    var prev=null,best='';
    S.readings.forEach(function(r){ if(r.asset_id===a.id&&r.month<S.entryMonth&&r.month>best){ best=r.month;prev=r; } });
    var existing=S.readings.find(function(r){ return r.asset_id===a.id&&r.month===S.entryMonth; });
    var val=S.entryPending[a.id]!==undefined?S.entryPending[a.id]:(existing?String(existing.raw_meter_reading):'');
    var res=S.entryResults[a.id]||null;
    var inpClass='inp-sm'+(res?res.status==='OK'?' inp-ok':res.status==='WARNING'?' inp-warn':' inp-crit':'');
    var acc=(val!==''&&!isNaN(+val)&&val.trim()!=='')?calcAcc(a,+val):null;
    return '<tr>'+
      '<td><div class="xs bold" style="color:#e4e4e7">'+esc(a.name)+'</div><div class="xs dim">'+esc(a.id)+'</div></td>'+
      '<td class="xs dim">'+esc(a.location)+'</td>'+
      '<td>'+(prev?prev.raw_meter_reading.toLocaleString():'â€”')+'</td>'+
      '<td>'+
      (canEdit?
        '<input id="inp-'+esc(a.id)+'" class="'+inpClass+'" type="number" min="0" value="'+esc(val)+'" placeholder="hrs" oninput="handleEntryInput(\''+esc(a.id)+'\',this.value)" disabled="'+(!canEdit)+'">'
        :'<span class="dim xs">'+(val||'â€”')+'</span>')+
      '</td>'+
      '<td id="val-'+esc(a.id)+'">'+
      (res?badge(res.status)+'<div class="xs dim" style="margin-top:.15rem">'+esc(res.message)+'</div>':'<span class="dim xs">â€”</span>')+
      '</td>'+
      '<td id="acc-'+esc(a.id)+'" class="amber bold">'+
      (acc!==null?acc.toLocaleString()+' hrs':'â€”')+'</td>'+
      '</tr>';
  }).join('');

  return '<div class="row">'+
    '<div><div class="ptitle">Monthly Entry</div><div class="xs dim" style="margin-top:.15rem">Record meter readings for all assets</div></div>'+
    '<div class="flex">'+
    '<select class="sel" onchange="S.entryMonth=this.value;S.entryPending={};S.entryResults={};render()">'+monthOpts+'</select>'+
    (isLocked?'<span class="dim xs" style="border:1px solid var(--bdr);padding:.3rem .6rem;border-radius:.25rem">ğŸ”’ Locked</span>':'')+
    (canEdit?'<button class="btn btn-p" onclick="saveAllReadings()">Save All</button>':'')+
    '</div></div>'+
    (isLocked&&S.userRole==='admin'?'<div class="info-box">âš  Month is closed. Admin edits are fully audited.</div>':'')+
    '<div class="card"><div class="tbl-wrap"><table><thead><tr>'+
    '<th>Asset / Tag</th><th>Drawer</th><th>Prev Reading</th><th>New Reading</th><th>Validation</th><th>Accumulated</th>'+
    '</tr></thead><tbody>'+rows+'</tbody></table></div></div>';
}

// â”€â”€ REPLACEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderReplacements(){
  var a=S.assets.find(function(x){ return x.id===S.replAssetId; });
  var canEdit=S.userRole==='admin'||S.userRole==='engineer';
  var step=S.replStep;

  var steps=['Select','Confirm','Done'].map(function(s,i){
    return '<span class="step-c'+(step>=i?' done':'')+'">'+( i+1)+'</span>'+
      '<span class="step-txt'+(step>=i?' done':'')+'">'+s+'</span>'+
      (i<2?'<span class="step-l'+(step>i?' done':'')+'"></span>':'');
  }).join('');

  var wiz='';
  if(step===0){
    var opts=S.assets.filter(function(a){ return a.active_status; }).map(function(a){ return '<option value="'+esc(a.id)+'"'+(S.replAssetId===a.id?' selected':'')+'>'+esc(a.name)+'</option>'; }).join('');
    wiz='<div class="card card-amber">'+
      '<div class="xs amber bold" style="text-transform:uppercase;letter-spacing:.15em;margin-bottom:.8rem">Step 1 â€” Select Asset</div>'+
      '<div class="fg"><label class="lbl">Asset</label>'+
      '<select class="sel" style="width:100%" onchange="S.replAssetId=this.value"><option value="">â€” Select â€”</option>'+opts+'</select></div>'+
      '<div class="fg"><label class="lbl">Notes / Reason</label>'+
      '<textarea class="inp" rows="2" placeholder="Reason for replacementâ€¦" oninput="S.replNotes=this.value">'+esc(S.replNotes)+'</textarea></div>'+
      (canEdit?'<button class="btn btn-p" style="width:100%;justify-content:center" onclick="replNext()">Next â†’</button>':
        '<div class="dim xs">Insufficient role.</div>')+
      '</div>';
  } else if(step===1&&a){
    var newStuck=a.stuck_reading+(+S.replLastReading);
    wiz='<div class="card card-amber">'+
      '<div class="xs amber bold" style="text-transform:uppercase;letter-spacing:.15em;margin-bottom:.8rem">Step 2 â€” Confirm Last Reading</div>'+
      '<div class="fg"><label class="lbl">Last Raw Reading (becomes stuck reading)</label>'+
      '<input class="inp" type="number" value="'+esc(S.replLastReading)+'" oninput="S.replLastReading=this.value;replUpdatePreview()"></div>'+
      '<div style="background:var(--bg);border:1px solid var(--bdr);border-radius:.375rem;padding:.75rem;font-size:.75rem;font-family:monospace;margin-bottom:.8rem" id="repl-preview">'+
      '<div class="dim">reset_count: <span style="color:#e4e4e7">'+a.reset_count+'</span> â†’ <span class="amber">'+( a.reset_count+1)+'</span></div>'+
      '<div class="dim">new stuck_reading: <span class="amber">'+newStuck.toLocaleString()+' hrs</span></div>'+
      '</div>'+
      '<div class="flex">'+
      '<button class="btn btn-s" onclick="S.replStep=0;render()">â† Back</button>'+
      '<button class="btn btn-d" onclick="replConfirm()">Confirm Reset</button>'+
      '</div></div>';
  } else if(step===2&&S.replConf){
    var rc=S.replConf;
    wiz='<div class="card card-green">'+
      '<div class="xs green bold" style="text-transform:uppercase;letter-spacing:.15em;margin-bottom:.8rem">âœ“ Replacement Logged</div>'+
      '<div class="sm" style="line-height:1.8">'+
      'Asset: <span style="color:#e4e4e7">'+esc(rc.assetName)+'</span><br>'+
      'New Reset Count: <span class="amber">'+rc.newReset+'</span><br>'+
      'Total Stuck: <span class="amber">'+rc.newStuck.toLocaleString()+' hrs</span></div>'+
      '<button class="btn btn-p" style="margin-top:1rem" onclick="replReset()">Log Another</button>'+
      '</div>';
  }

  var replRows=S.repls.length===0?
    '<tr><td colspan="5" style="color:#71717a;text-align:center;padding:1rem">No replacements yet.</td></tr>':
    S.repls.slice().reverse().map(function(r){
      var a=S.assets.find(function(x){ return x.id===r.asset_id; });
      return '<tr>'+
        '<td>'+fmtMonth(r.replacement_date)+'</td>'+
        '<td class="xs bold" style="color:#e4e4e7">'+esc(a?a.name:r.asset_id)+'</td>'+
        '<td class="amber">'+(r.last_stuck_reading||0).toLocaleString()+'</td>'+
        '<td>'+r.previous_reset_count+' â†’ <span class="sky">'+r.new_reset_count+'</span></td>'+
        '<td class="xs dim">'+esc(r.notes)+'</td></tr>';
    }).join('');

  return '<div class="ptitle" style="margin-bottom:1rem">Meter Replacements</div>'+
    '<div class="grid-2col">'+
    '<div class="space">'+
    '<div class="step-row">'+steps+'</div>'+
    wiz+'</div>'+
    '<div class="card">'+
    '<div class="stitle">Replacement Log</div>'+
    '<div class="tbl-wrap"><table><thead><tr>'+
    '<th>Date</th><th>Asset</th><th>Stuck Rdg</th><th>Reset #</th><th>Notes</th>'+
    '</tr></thead><tbody>'+replRows+'</tbody></table></div></div>'+
    '</div>';
}

// â”€â”€ REPORTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderReports(){
  var selM=S.reportsMonth||CUR_MONTH;
  var monthOpts=MONTHS.map(function(m){ return '<option value="'+m+'"'+(selM===m?' selected':'')+'>'+fmtMonth(m)+'</option>'; }).join('');
  var report=S.assets.map(function(a){
    var r=S.readings.find(function(rd){ return rd.asset_id===a.id&&rd.month===selM; });
    var prev=null,best='';
    S.readings.forEach(function(rd){ if(rd.asset_id===a.id&&rd.month<selM&&rd.month>best){ best=rd.month;prev=rd; } });
    var delta=(r&&prev)?(r.raw_meter_reading-prev.raw_meter_reading):null;
    var _thr=(a.threshold_hours&&a.threshold_hours>0)?a.threshold_hours:(S.jumpThreshold||800);
    return {id:a.id,name:a.name,location:a.location,raw:r?r.raw_meter_reading:null,delta:delta,acc:calcAcc(a,r?r.raw_meter_reading:0),thr:_thr,status:r?r.validation:'N/A'};
  });
  var trendData=MONTHS.map(function(m){
    var e={label:fmtMonth(m)};
    S.assets.forEach(function(a){
      var r=S.readings.find(function(rd){ return rd.asset_id===a.id&&rd.month===m; });
      e[a.name]=r?calcAcc(a,r.raw_meter_reading):null;
    });
    return e;
  });
  var colors=['#f59e0b','#6ee7b7','#38bdf8','#f472b6','#a78bfa','#fb7185'];
  var reportRows=report.map(function(r){
    return '<tr>'+
      '<td><div class="xs bold" style="color:#e4e4e7">'+esc(r.name)+'</div><div class="xs dim">'+esc(r.id)+'</div></td>'+
      '<td>'+(r.raw!==null?r.raw.toLocaleString():'â€”')+' hrs</td>'+
      '<td>'+(r.delta!==null?'<span class="'+(r.delta>r.thr?'amber':'green')+'">+'+r.delta+'</span>':'â€”')+'</td>'+
      '<td class="amber bold">'+r.acc.toLocaleString()+' hrs</td>'+
      '<td class="dim xs">'+r.thr+' hrs/mo</td>'+
      '<td>'+badge(r.status)+'</td></tr>';
  }).join('');
  var alerts=report.filter(function(r){ return r.delta!==null&&r.delta>r.thr; });
  var alertsHTML=alerts.length===0?'<p class="dim sm">No assets exceeded threshold this month. âœ“</p>':
    alerts.map(function(r){ return '<div class="alert-row">'+
      '<span class="amber">âš </span>'+
      '<div><span class="amber bold sm">'+esc(r.name)+'</span> '+
      '<span class="xs dim">ran '+r.delta+' hrs vs '+r.thr+' hr limit</span></div>'+
      '<span class="badge b-warn">+'+( r.delta-r.thr)+' over</span>'+
      '</div>'; }).join('');

  var csvData=report.map(function(r){ return {id:r.id,name:r.name,location:r.location,month:fmtMonth(selM),raw_reading:r.raw,monthly_delta:r.delta,accumulated:r.acc,threshold:r.thr,status:r.status}; });

  return '<div class="row">'+
    '<div class="ptitle">Reports</div>'+
    '<div class="flex">'+
    '<select class="sel" onchange="S.reportsMonth=this.value;render()">'+monthOpts+'</select>'+
    '<button class="btn btn-s" onclick="exportCSV('+JSON.stringify(csvData)+',\'runtime-'+selM+'.csv\')">â†“ CSV Export</button>'+
    '</div></div>'+
    '<div class="card"><div class="stitle">Monthly Report â€” '+fmtMonth(selM)+'</div>'+
    '<div class="tbl-wrap"><table><thead><tr>'+
    '<th>Asset</th><th>Raw Reading</th><th>Monthly Î”</th><th>Accumulated</th><th>Threshold</th><th>Status</th>'+
    '</tr></thead><tbody>'+reportRows+'</tbody></table></div></div>'+
    '<div class="card"><div class="stitle">All-Asset Accumulated Trend</div>'+
    svgChart(trendData,S.assets.map(function(a){ return a.name; }),colors,260)+'</div>'+
    '<div class="card"><div class="stitle">Threshold Alerts â€” '+fmtMonth(selM)+'</div>'+alertsHTML+'</div>';
}

// â”€â”€ AUDIT LOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAudit(){
  var colorMap={CREATE:'green',EDIT:'amber',DELETE:'red',LOCK:'sky',UNLOCK:'amber',CLOSE_MONTH:'sky',METER_REPLACEMENT:'amber'};
  var rows=S.audit.map(function(e){
    return '<tr>'+
      '<td class="xs dim">'+new Date(e.timestamp).toLocaleString()+'</td>'+
      '<td class="xs" style="color:#e4e4e7">'+esc(e.user_email)+'</td>'+
      '<td><span class="xs bold '+(colorMap[e.action]||'dim')+'">'+esc(e.action)+'</span></td>'+
      '<td class="xs dim">'+esc(e.entity)+'</td>'+
      '<td class="xs dim mono">'+esc(e.entity_id)+'</td>'+
      '<td class="xs dim">'+esc(e.detail)+'</td></tr>';
  }).join('');
  return '<div class="row">'+
    '<div class="ptitle">Audit Log</div>'+
    '<button class="btn btn-s" onclick="exportAudit()">â†“ Export CSV</button></div>'+
    '<div class="card"><div class="tbl-wrap"><table><thead><tr>'+
    '<th>Timestamp</th><th>User</th><th>Action</th><th>Entity</th><th>Record</th><th>Detail</th>'+
    '</tr></thead><tbody>'+(rows||'<tr><td colspan="6" style="color:#71717a;text-align:center;padding:1rem">No audit entries yet.</td></tr>')+'</tbody></table></div></div>';
}

// â”€â”€ USERS (admin) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderUsers(){
  if(!S._users){ loadUsers(); return '<div class="card"><div class="flex"><span class="spin">â—</span><span class="dim sm">Loading usersâ€¦</span></div></div>'; }
  var rows=S._users.map(function(u){
    var isMe=u.id===S.session.user.id;
    return '<tr>'+
      '<td><span class="'+(isMe?'amber bold':'sm')+'" style="color:'+(isMe?'#f59e0b':'#e4e4e7')+'">'+esc(u.email)+(isMe?' (you)':'')+'</span></td>'+
      '<td>'+roleBadge(u.role)+'</td>'+
      '<td class="xs dim">'+new Date(u.created_at).toLocaleDateString()+'</td>'+
      '<td>'+(isMe?'<span class="dim xs">Cannot change own role</span>':
        '<select class="sel" style="font-size:.72rem" onchange="changeRole(\''+esc(u.id)+'\',this.value)">'+
        '<option value="viewer"'+(u.role==='viewer'?' selected':'')+'>Viewer â€” read only</option>'+
        '<option value="engineer"'+(u.role==='engineer'?' selected':'')+'>Engineer â€” add readings</option>'+
        '<option value="admin"'+(u.role==='admin'?' selected':'')+'>Admin â€” full access</option>'+
        '</select>')+'</td></tr>';
  }).join('');
  return '<div class="ptitle" style="margin-bottom:1rem">User Management</div>'+
    '<div class="card"><div class="tbl-wrap"><table><thead><tr>'+
    '<th>Email</th><th>Role</th><th>Joined</th><th>Change Role</th>'+
    '</tr></thead><tbody>'+rows+'</tbody></table></div></div>'+
    '<div class="card">'+
    '<div class="stitle">How Team Access Works</div>'+
    '<p class="sm" style="color:#a1a1aa;margin-bottom:.7rem">Share your app URL. Colleagues sign up â†’ get Viewer access â†’ you promote them here.</p>'+
    '<div class="grid-2col">'+
    ['Viewer|Read all data and reports|rt-viewer','Engineer|+ Add readings, log replacements|rt-engineer','Admin|+ Close months, manage users|rt-admin'].map(function(s){
      var p=s.split('|');
      return '<div style="border:1px solid var(--bdr);border-radius:.375rem;padding:.7rem">'+
        '<div class="bold xs role-tag '+p[2]+'" style="display:inline-block;margin-bottom:.3rem">'+p[0].toUpperCase()+'</div>'+
        '<div class="xs dim">'+p[1]+'</div></div>';
    }).join('')+
    '</div></div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setLoginMode(m){ S.loginMode=m; S.loginErr=''; S.loginMsg=''; render(); }

async function doLogin(){
  S.loginErr=''; S.loginBusy=true; render();
  var email=document.getElementById('l-email')?document.getElementById('l-email').value:S.loginEmail;
  var pw=document.getElementById('l-pw')?document.getElementById('l-pw').value:S.loginPw;
  S.loginEmail=email; S.loginPw=pw;
  var r;
  if(S.loginMode==='login'){
    r=await DB.auth.signInWithPassword({email:email,password:pw});
  } else {
    r=await DB.auth.signUp({email:email,password:pw});
    if(!r.error){ S.loginMsg='Account created! You can now sign in.'; S.loginMode='login'; S.loginBusy=false; render(); return; }
  }
  if(r.error){ S.loginErr=r.error.message; }
  S.loginBusy=false; render();
}

async function doLogout(){
  await DB.auth.signOut();
  S.session=null; S.view='login'; render();
}

async function loadData(){
  var mainEl=document.getElementById('main');
  if(mainEl) mainEl.innerHTML='<div class="flex" style="padding:2rem;justify-content:center"><span class="spin">â—</span><span class="dim sm">&nbsp;Loading dataâ€¦</span></div>';
  var results=await Promise.all([
    DB.from('assets').select('*').order('id'),
    DB.from('monthly_readings').select('*').order('month'),
    DB.from('replacement_logs').select('*').order('replacement_date'),
    DB.from('audit_log').select('*').order('timestamp',{ascending:false}).limit(500),
    DB.from('closed_months').select('month'),
    DB.from('app_settings').select('*'),
  ]);
  S.assets=results[0].data||[];
  S.readings=results[1].data||[];
  S.repls=results[2].data||[];
  S.audit=results[3].data||[];
  S.closed=(results[4].data||[]).map(function(x){ return x.month; });
  // Load settings â€” each row is {key, value}
  var settings=results[5].data||[];
  settings.forEach(function(row){
    if(row.key==='jump_threshold'&&+row.value>0) S.jumpThreshold=+row.value;
  });
  render();
}

async function loadProfile(id){
  var r=await DB.from('profiles').select('role').eq('id',id).single();
  S.userRole=(r.data&&r.data.role)||'viewer';
}

function goTab(t){ S.appTab=t; S.detailId=null; render(); }
function openAssetDetail(id){ S.detailId=id; S.appTab='assets'; render(); }

// ADD ASSET
async function submitAddAsset(){
  var nameEl=document.getElementById('na-name');
  var locEl=document.getElementById('na-loc');
  var maxEl=document.getElementById('na-max');
  var thrEl=document.getElementById('na-thr');
  if(!nameEl||!nameEl.value.trim()){ toast('Name required.','err'); return; }
  S.addAssetBusy=true; render();
  var id='A'+String(S.assets.length+1).padStart(3,'0');
  var _loc=locEl?locEl.value:'';
  var _autoMax=getMotorType(_loc)==='MV'?65535:getMotorType(_loc)==='LV'?10000:9999;
  var _maxVal=maxEl&&maxEl.value?+maxEl.value:_autoMax;
  var _thrVal=thrEl&&thrEl.value?+thrEl.value:0; // 0 means use global jumpThreshold
  var rec={id:id,name:nameEl.value.trim(),location:_loc,meter_max_value:_maxVal,reset_count:0,stuck_reading:0,created_at:new Date().toISOString().slice(0,10),active_status:true,threshold_hours:_thrVal};
  var r=await DB.from('assets').insert(rec);
  if(r.error){ toast(r.error.message,'err'); S.addAssetBusy=false; render(); return; }
  S.assets.push(rec);
  await logAudit('CREATE','Asset',id,'Created: '+rec.name);
  toast('Asset '+id+' registered. âœ“','ok');
  S.addAssetOpen=false; S.addAssetBusy=false; render();
}

// MONTHLY ENTRY
function handleEntryInput(assetId, val){
  S.entryPending[assetId]=val;
  var asset=S.assets.find(function(a){ return a.id===assetId; });
  if(!asset) return;
  if(val===''||isNaN(+val)||val.trim()===''){ S.entryResults[assetId]=null; }
  else { S.entryResults[assetId]=validateReading(asset,S.readings,+val,S.entryMonth); }
  // update validation cell
  var valCell=document.getElementById('val-'+assetId);
  var accCell=document.getElementById('acc-'+assetId);
  var inpEl=document.getElementById('inp-'+assetId);
  var res=S.entryResults[assetId];
  if(valCell) valCell.innerHTML=res?badge(res.status)+'<div class="xs dim" style="margin-top:.15rem">'+esc(res.message)+'</div>':'<span class="dim xs">â€”</span>';
  if(accCell){
    var num=+val;
    if(val!==''&&!isNaN(num)&&val.trim()!==''){
      accCell.textContent=calcAcc(asset,num).toLocaleString()+' hrs';
      accCell.style.color='#f59e0b';
    } else { accCell.textContent='â€”'; accCell.style.color='var(--t3)'; }
  }
  if(inpEl&&res){
    inpEl.className='inp-sm '+(res.status==='OK'?'inp-ok':res.status==='WARNING'?'inp-warn':'inp-crit');
  } else if(inpEl){ inpEl.className='inp-sm'; }
}

async function saveAllReadings(){
  var canEdit=(S.userRole==='admin'||S.userRole==='engineer')&&S.closed.indexOf(S.entryMonth)<0;
  if(!canEdit){ toast('Month is locked or insufficient role.','err'); return; }
  var count=0;
  var newReadings=S.readings.slice();
  for(var i=0;i<S.assets.length;i++){
    var a=S.assets[i];
    if(!a.active_status) continue;
    // Get value from input first, then pending state
    var inpEl=document.getElementById('inp-'+a.id);
    var val=inpEl?inpEl.value:(S.entryPending[a.id]!==undefined?S.entryPending[a.id]:'');
    if(val===''||val===undefined) continue;
    var num=+val; if(isNaN(num)) continue;
    var v=validateReading(a,newReadings,num,S.entryMonth);
    var idx=-1;
    for(var j=0;j<newReadings.length;j++){
      if(newReadings[j].asset_id===a.id&&newReadings[j].month===S.entryMonth){ idx=j; break; }
    }
    var rec={id:idx>=0?newReadings[idx].id:uid(),asset_id:a.id,month:S.entryMonth,raw_meter_reading:num,locked:false,created_at:new Date().toISOString(),created_by:S.session.user.email,validation:v.status};
    var r=await DB.from('monthly_readings').upsert(rec,{onConflict:'asset_id,month'});
    if(r.error){ toast('Error on '+a.name+': '+r.error.message,'err'); continue; }
    if(idx>=0){ newReadings[idx]=rec; } else { newReadings.push(rec); }
    count++;
  }
  S.readings=newReadings;
  S.entryPending={};
  await logAudit('BULK_SAVE','MonthlyEntry',S.entryMonth,'Saved '+count+' readings for '+fmtMonth(S.entryMonth));
  toast(count+' reading(s) saved. âœ“','ok');
  render();
}

// CLOSE MONTH
async function closeMonth(){
  if(S.userRole!=='admin'){ toast('Only Admin can close months.','err'); return; }
  var r=await DB.from('closed_months').upsert({month:PREV_MONTH,closed_by:S.session.user.email});
  if(r.error){ toast(r.error.message,'err'); return; }
  if(S.closed.indexOf(PREV_MONTH)<0) S.closed.push(PREV_MONTH);
  await logAudit('CLOSE_MONTH','Month',PREV_MONTH,'Closed '+fmtMonth(PREV_MONTH));
  toast(fmtMonth(PREV_MONTH)+' locked. âœ“','ok');
}

// REPLACEMENTS
function replNext(){
  if(!S.replAssetId){ toast('Select an asset.','err'); return; }
  var latest=null,best='';
  S.readings.forEach(function(r){ if(r.asset_id===S.replAssetId&&r.month>best){ best=r.month;latest=r; } });
  S.replLastReading=latest?String(latest.raw_meter_reading):'0';
  S.replStep=1; render();
}
function replUpdatePreview(){
  var el=document.querySelector('.inp');
  if(el) S.replLastReading=el.value;
  var prev=document.getElementById('repl-preview');
  if(!prev) return;
  var a=S.assets.find(function(x){ return x.id===S.replAssetId; });
  if(!a) return;
  var ns=a.stuck_reading+(+S.replLastReading);
  prev.innerHTML='<div class="dim">reset_count: <span style="color:#e4e4e7">'+a.reset_count+'</span> â†’ <span class="amber">'+(a.reset_count+1)+'</span></div>'+
    '<div class="dim">new stuck_reading: <span class="amber">'+ns.toLocaleString()+' hrs</span></div>';
}
async function replConfirm(){
  var a=S.assets.find(function(x){ return x.id===S.replAssetId; });
  if(!a) return;
  var newReset=a.reset_count+1, newStuck=a.stuck_reading+(+S.replLastReading);
  var rl={id:uid(),asset_id:S.replAssetId,replacement_date:MONTHS[MONTHS.length-1],last_stuck_reading:+S.replLastReading,previous_reset_count:a.reset_count,new_reset_count:newReset,notes:S.replNotes};
  var r1=await DB.from('replacement_logs').insert(rl);
  var r2=await DB.from('assets').update({reset_count:newReset,stuck_reading:newStuck}).eq('id',S.replAssetId);
  if(r1.error||r2.error){ toast('Save error â€” try again.','err'); return; }
  S.repls.push(rl);
  S.assets=S.assets.map(function(x){ return x.id===S.replAssetId?Object.assign({},x,{reset_count:newReset,stuck_reading:newStuck}):x; });
  await logAudit('METER_REPLACEMENT','Asset',S.replAssetId,'Reset '+a.reset_count+'â†’'+newReset+'. Stuck: '+newStuck);
  S.replConf={assetName:a.name,newReset:newReset,newStuck:newStuck};
  S.replStep=2; render();
  toast('Meter replacement logged. âœ“','ok');
}
function replReset(){ S.replStep=0; S.replAssetId=''; S.replLastReading=''; S.replNotes=''; S.replConf=null; render(); }

// USERS
var _usersLoading=false;
async function loadUsers(){
  if(_usersLoading) return; _usersLoading=true;
  var r=await DB.from('profiles').select('*').order('created_at');
  S._users=r.data||[]; _usersLoading=false; render();
}
async function changeRole(userId,newRole){
  var r=await DB.from('profiles').update({role:newRole}).eq('id',userId);
  if(r.error){ toast(r.error.message,'err'); return; }
  S._users=S._users.map(function(u){ return u.id===userId?Object.assign({},u,{role:newRole}):u; });
  toast('Role updated. âœ“','ok');
  var tbody=document.querySelector('#main table tbody');
  if(tbody){ var newContent=renderUsers(); document.getElementById('main').innerHTML=newContent; }
}

// AUDIT EXPORT
function exportAudit(){ exportCSV(S.audit,'audit-log.csv'); }

// LOG AUDIT
async function logAudit(action,entity,entity_id,detail){
  if(!S.session) return;
  var e={id:uid(),timestamp:new Date().toISOString(),user_email:S.session.user.email,action:action,entity:entity,entity_id:entity_id,detail:detail};
  await DB.from('audit_log').insert(e);
  S.audit.unshift(e);
}

// REPORTS CSV EXPORT (called inline with data)
function exportCSV(data,filename){
  if(!data.length) return;
  var keys=Object.keys(data[0]);
  var rows=[keys.join(',')].concat(data.map(function(r){ return keys.map(function(k){ return '"'+(r[k]===null||r[k]===undefined?'':r[k])+'"'; }).join(','); }));
  var a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(rows.join('\n'));
  a.download=filename; a.click();
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE ASSET EDITS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveAssetEdits(assetId){
  var a=S.assets.find(function(x){ return x.id===assetId; });
  if(!a){ toast('Asset not found.','err'); return; }
  var nameEl=document.getElementById('ef-name');
  var locEl=document.getElementById('ef-loc');
  var maxEl=document.getElementById('ef-max');
  var thrEl=document.getElementById('ef-thr');
  var stuckEl=document.getElementById('ef-stuck');
  var resetEl=document.getElementById('ef-reset');
  var activeEl=document.getElementById('ef-active');
  var fields={};
  if(nameEl) fields.name=nameEl.value.trim()||a.name;
  if(locEl) fields.location=locEl.value;
  if(maxEl&&maxEl.value!=='') fields.meter_max_value=+maxEl.value;
  if(thrEl&&thrEl.value!=='') fields.threshold_hours=+thrEl.value;
  if(stuckEl&&stuckEl.value!=='') fields.stuck_reading=+stuckEl.value;
  if(resetEl&&resetEl.value!=='') fields.reset_count=+resetEl.value;
  if(activeEl) fields.active_status=activeEl.value==='true';
  var r=await DB.from('assets').update(fields).eq('id',assetId);
  if(r.error){ toast('Save error: '+r.error.message,'err'); return; }
  S.assets=S.assets.map(function(x){ return x.id===assetId?Object.assign({},x,fields):x; });
  await logAudit('EDIT','Asset',assetId,'Edited: '+JSON.stringify(fields));
  S.editingAssetId=null; S.editFields={};
  toast('Asset updated. âœ“','ok');
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMMAND ENGINE â€” renderAI + all handlers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderAI(){
  if(S.userRole!=='admin') return '<div class="card"><p class="dim">Admin only.</p></div>';

  var hints=[
    'summary report','show critical assets','assets with no readings this month',
    'fix all name formats','check data quality','show top 10 by runtime',
    'show MV motors','list assets by location','duplicate readings check',
    'highest monthly jump this month','bulk deactivate inactive assets',
    'show all resets','assets with zero readings ever','help'
  ];
  var hintsHTML=hints.map(function(h){
    return '<button class="ai-hint-btn" onclick="aiQuickSend(\''+esc(h)+'\')">'+esc(h)+'</button>';
  }).join('');

  var msgsHTML=S.aiMessages.length===0?
    '<div style="flex:1;display:flex;align-items:center;justify-content:center">'+
    '<div style="text-align:center;color:var(--t3)">'+
    '<div style="font-size:2rem;margin-bottom:.5rem">âš¡</div>'+
    '<div class="xs" style="text-transform:uppercase;letter-spacing:.15em;color:var(--amber)">HourTrack Command Console</div>'+
    '<div class="xs dim" style="margin-top:.4rem;max-width:26rem">Type commands in plain language. Ask for reports, edit assets, fix readings, manage months â€” all executed directly in your database.</div>'+
    '<div class="xs dim" style="margin-top:.3rem">Type <span class="amber">help</span> to see all commands.</div>'+
    '</div></div>':
    S.aiMessages.map(function(m){
      var bubCls=m.role==='user'?'ai-bubble-user':'ai-bubble-ai';
      var msgCls=m.role==='user'?'ai-msg-user':'ai-msg-ai';
      var cmdHTML='';
      if(m.cmds&&m.cmds.length){
        cmdHTML='<div class="ai-cmd-block">'+m.cmds.map(function(c){
          return '<div class="ai-cmd-row">'+
            '<span class="ai-cmd-action">'+(c.ok?'âœ“':'âœ—')+' '+esc(c.action)+'</span>'+
            '<span class="ai-cmd-detail">'+(c.detail?esc(c.detail):'')+'</span>'+
            (c.err?'<span class="ai-cmd-err xs"> â€” '+esc(c.err)+'</span>':'')+
            '</div>';
        }).join('')+'</div>';
      }
      return '<div class="ai-msg '+msgCls+'">'+
        '<div class="ai-bubble '+bubCls+'" style="white-space:pre-wrap">'+esc(m.text)+'</div>'+
        cmdHTML+'</div>';
    }).join('');

  var settingsBar='<div class="card" style="margin-bottom:.6rem;border-color:rgba(202,138,4,.3)">'+
    '<div style="display:flex;align-items:center;gap:.8rem;flex-wrap:wrap">'+
    '<div class="xs bold amber" style="text-transform:uppercase;letter-spacing:.12em;white-space:nowrap">âš™ Global Settings</div>'+
    '<div style="display:flex;align-items:center;gap:.4rem">'+
    '<label class="lbl" style="margin:0;white-space:nowrap">Normal Jump Threshold (hrs/month):</label>'+
    '<input id="jt-inp" class="inp" type="number" min="1" style="width:6rem" value="'+(S.jumpThreshold||800)+'" oninput="aiUpdateThreshold(this.value)">'+
    '<span class="xs dim">LV motors max 10,000 hrs Â· MV motors max 65,535 hrs (auto-detected from CC/CB in drawer)</span>'+
    '</div></div></div>';

  return '<div class="row"><div class="ptitle">Command Console <span class="role-tag rt-admin xs" style="vertical-align:middle">ADMIN ONLY</span></div>'+
    '<button class="btn btn-s" style="font-size:.7rem" onclick="S.aiMessages=[];render()">Clear</button></div>'+
    settingsBar+
    '<div class="card" style="margin-bottom:.6rem"><div class="xs dim" style="margin-bottom:.4rem">Quick commands:</div>'+hintsHTML+'</div>'+
    '<div class="card ai-wrap">'+
    '<div class="ai-messages" id="ai-msgs">'+msgsHTML+
    (S.aiLoading?'<div class="ai-msg ai-msg-ai"><div class="ai-bubble ai-bubble-ai dim xs"><span class="spin">â—</span> Processingâ€¦</div></div>':'')+
    '</div>'+
    '<div class="ai-input-row">'+
    '<textarea id="ai-inp" class="ai-inp" placeholder="Type a commandâ€¦  e.g.  show critical  |  edit A012 name to Pump 3  |  set threshold to 750" onkeydown="if(event.key===\'Enter\'&&!event.shiftKey){event.preventDefault();sendAI()}">'+(S.aiInput?esc(S.aiInput):'')+'</textarea>'+
    '<button class="ai-send" onclick="sendAI()" '+(S.aiLoading?'disabled':'')+'>Run</button>'+
    '</div></div>';
}

function aiQuickSend(text){
  S.aiInput=text;
  sendAI();
}

function autoFillMeterMax(loc){
  var t=getMotorType(loc);
  var maxEl=document.getElementById('na-max');
  var lblEl=document.getElementById('na-max-lbl');
  if(!maxEl) return;
  if(t==='MV'){ maxEl.value=65535; if(lblEl) lblEl.textContent='Meter Max Value â€” MV motor (65,535 auto)'; }
  else if(t==='LV'){ maxEl.value=10000; if(lblEl) lblEl.textContent='Meter Max Value â€” LV motor (10,000 auto)'; }
  else { maxEl.value=9999; if(lblEl) lblEl.textContent='Meter Max Value'; }
}

async function aiUpdateThreshold(val){
  var n=+val;
  if(isNaN(n)||n<1) return;
  S.jumpThreshold=n;
  var r=await DB.from('app_settings').upsert({key:'jump_threshold',value:String(n)},{onConflict:'key'});
  if(r.error){ toast('Could not save: '+r.error.message,'err'); }
  else { toast('Jump threshold updated to '+n+' hrs for all users. âœ“','ok'); render(); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMMAND PROCESSOR â€” pure JS, no external API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function sendAI(){
  if(S.aiLoading) return;
  var inpEl=document.getElementById('ai-inp');
  var raw=(inpEl?inpEl.value:S.aiInput).trim();
  if(!raw) return;
  if(inpEl) inpEl.value='';
  S.aiInput='';
  S.aiMessages.push({role:'user',text:raw});
  S.aiLoading=true; render();
  setTimeout(function(){ var el=document.getElementById('ai-msgs'); if(el) el.scrollTop=el.scrollHeight; },40);

  // Small artificial delay so it feels like it's "thinking"
  await new Promise(function(res){ setTimeout(res, 280); });

  var result=await processCommand(raw.toLowerCase().trim(), raw.trim());
  S.aiMessages.push({role:'ai', text:result.text, cmds:result.cmds||[]});
  S.aiLoading=false; render();
  setTimeout(function(){ var el=document.getElementById('ai-msgs'); if(el) el.scrollTop=el.scrollHeight; },60);
}

// â”€â”€ helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function findAsset(q){
  // Match by exact ID, then ID substring, then name substring
  q=q.trim().toUpperCase();
  var exact=S.assets.find(function(a){ return a.id.toUpperCase()===q; });
  if(exact) return exact;
  var byId=S.assets.find(function(a){ return a.id.toUpperCase().indexOf(q)>=0; });
  if(byId) return byId;
  var byName=S.assets.find(function(a){ return a.name.toUpperCase().indexOf(q)>=0; });
  return byName||null;
}
function fmtAssetLine(a){
  var rds=S.readings.filter(function(r){ return r.asset_id===a.id; }).sort(function(x,y){ return y.month.localeCompare(x.month); });
  var lat=rds[0];
  var acc=calcAcc(a,lat?lat.raw_meter_reading:0);
  var type=getMotorType(a.location);
  return '['+a.id+'] '+a.name+' | '+esc(a.location)+' | '+type+' | '+acc.toLocaleString()+' hrs acc | '+(lat?lat.validation:'NO DATA')+(a.active_status?'':' | INACTIVE');
}
function tbl(headers, rows){
  // Returns a plain-text table string
  var sep='  ';
  var lines=[headers.join(sep)];
  lines.push(headers.map(function(h){ return h.replace(/./g,'â”€'); }).join(sep));
  rows.forEach(function(r){ lines.push(r.join(sep)); });
  return lines.join('\n');
}
function parseMonth(s){
  // Accept "jan 2025", "2025-01", "january 2025", "01/2025"
  var months={jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12,
    january:1,february:2,march:3,april:4,june:6,july:7,august:8,september:9,october:10,november:11,december:12};
  var m=s.trim().toLowerCase();
  // YYYY-MM
  var iso=m.match(/^(\d{4})-(\d{2})$/);
  if(iso) return iso[1]+'-'+iso[2]+'-01';
  // Mon YYYY or YYYY Mon
  var my=m.match(/^([a-z]+)\s+(\d{4})$/);
  if(my&&months[my[1]]) return my[2]+'-'+String(months[my[1]]).padStart(2,'0')+'-01';
  var ym=m.match(/^(\d{4})\s+([a-z]+)$/);
  if(ym&&months[ym[2]]) return ym[1]+'-'+String(months[ym[2]]).padStart(2,'0')+'-01';
  // MM/YYYY
  var sl=m.match(/^(\d{1,2})\/(\d{4})$/);
  if(sl) return sl[2]+'-'+String(+sl[1]).padStart(2,'0')+'-01';
  return null;
}

// â”€â”€ MAIN COMMAND ROUTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function processCommand(q, raw){
  var jt=S.jumpThreshold||800;

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // HELP
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(/^help$|^what can you do|^commands/.test(q)){
    return {text:
'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n'+
' HOURTRACK COMMAND CONSOLE â€” ALL COMMANDS\n'+
'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n'+
'\nğŸ“Š REPORTS & ANALYTICS\n'+
'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n'+
'  summary report\n'+
'  total accumulated runtime\n'+
'  show top 10 by runtime\n'+
'  show bottom 10 by runtime\n'+
'  show highest jump this month\n'+
'  show lowest runtime\n'+
'  average runtime per motor\n'+
'  runtime breakdown by type\n'+
'  most replaced assets\n'+
'  show month [Jan 2025]\n'+
'\nğŸ” QUERY ASSETS\n'+
'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n'+
'  show all assets\n'+
'  show active / show inactive\n'+
'  show critical / show warnings\n'+
'  show MV motors / show LV motors\n'+
'  show asset [A012]\n'+
'  show readings [A012]\n'+
'  search [keyword]               â€” search name or location\n'+
'  list assets by location\n'+
'  list assets in [panel name]    â€” e.g. list assets in 185CB\n'+
'  assets with no readings this month\n'+
'  assets with zero readings ever\n'+
'  assets over threshold\n'+
'  assets never reset\n'+
'  assets reset more than [N] times\n'+
'  assets approaching counter limit\n'+
'  show replacements\n'+
'  show replacements for [A012]\n'+
'  show closed months\n'+
'\nğŸ”¬ DATA QUALITY\n'+
'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n'+
'  check data quality             â€” full audit report\n'+
'  fix all name formats           â€” add missing - before M\n'+
'  preview name fixes             â€” show what would change\n'+
'  find name format issues        â€” list bad names only\n'+
'  duplicate readings check\n'+
'  find flat readings             â€” same reading 2+ months\n'+
'  find suspicious jumps\n'+
'  find zero readings\n'+
'  find assets with wrong meter max\n'+
'\nâœï¸  EDIT SINGLE ASSET\n'+
'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n'+
'  edit [A012] name to [New Name]\n'+
'  rename [A012] to [New Name]\n'+
'  edit [A012] location to [185CB12A +03.17]\n'+
'  edit [A012] threshold to [750]\n'+
'  edit [A012] meter max to [65535]\n'+
'  edit [A012] reset count to [3]\n'+
'  edit [A012] stuck reading to [15000]\n'+
'  deactivate [A012] / activate [A012]\n'+
'\nâš¡ BULK EDITS\n'+
'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n'+
'  fix all name formats           â€” apply - fix to all assets\n'+
'  fix name [A012]                â€” fix one asset name\n'+
'  bulk set threshold to [750]\n'+
'  bulk set threshold MV to [750]\n'+
'  bulk set threshold LV to [750]\n'+
'  bulk fix meter max             â€” set MV=65535, LV=10000\n'+
'  bulk deactivate assets in [panel]\n'+
'  bulk activate assets in [panel]\n'+
'\nğŸ“… READINGS\n'+
'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n'+
'  set reading for [A012] in [Jan 2025] to [7823]\n'+
'  delete reading for [A012] in [Jan 2025]\n'+
'\nğŸ—“ï¸  MONTHS\n'+
'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n'+
'  close month [Jan 2025]\n'+
'  reopen month [Jan 2025]\n'+
'\nâš™ï¸  SETTINGS\n'+
'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n'+
'  set threshold to [750]\n'+
'  show settings\n'+
'\nTip: Use any part of an asset name or its full ID.'};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SHOW SETTINGS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(/^show settings?$|^current settings?$/.test(q)){
    var mvCount=S.assets.filter(function(a){ return getMotorType(a.location)==='MV'; }).length;
    var lvCount=S.assets.filter(function(a){ return getMotorType(a.location)==='LV'; }).length;
    return {text:
      'Current Settings\n'+
      'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n'+
      'Global jump threshold: '+(S.jumpThreshold||800)+' hrs/month\n'+
      'MV counter max: 65,535 hrs (CB in drawer)\n'+
      'LV counter max: 10,000 hrs (CC in drawer)\n'+
      '\nFleet: '+S.assets.length+' total ('+mvCount+' MV, '+lvCount+' LV)\n'+
      'Closed months: '+S.closed.length+'\n'+
      'Current month: '+fmtMonth(CUR_MONTH)};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // NAME FORMAT â€” PREVIEW / FIND / FIX
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function needsNameFix(name){
    // Pattern: ends in something like ...AM01, ...AM02, ...BM03 â€” needs dash before M
    // Standard: 028P001A-M01
    return /[A-Z0-9][A-Z]M\d+$/i.test(name) && !/[A-Z0-9]-M\d+$/i.test(name);
  }
  function fixName(name){
    // Insert - before the last occurrence of M followed by digits at end
    return name.replace(/([A-Z0-9])M(\d+)$/i, '$1-M$2');
  }

  if(/^preview name fix|^what.*name.*fix|^show.*name.*fix/.test(q)){
    var bad=S.assets.filter(function(a){ return needsNameFix(a.name); });
    if(!bad.length) return {text:'All asset names already follow the standard format (e.g. 028P001A-M01). âœ“'};
    return {text:'Preview â€” '+bad.length+' name(s) would be updated:\n\n'+
      bad.map(function(a){ return '['+a.id+']  '+a.name+'  â†’  '+fixName(a.name); }).join('\n')+
      '\n\nType "fix all name formats" to apply all changes.'};
  }

  if(/^find name.*(issue|problem|bad|wrong|format)|^list.*bad.*name|^name.*format.*issue/.test(q)){
    var bad=S.assets.filter(function(a){ return needsNameFix(a.name); });
    if(!bad.length) return {text:'No name format issues found. All names follow the standard. âœ“'};
    return {text:'Assets with name format issues ('+bad.length+') â€” missing - before M:\n\n'+
      bad.map(function(a){ return '['+a.id+'] '+a.name; }).join('\n')+
      '\n\nType "fix all name formats" to fix them all, or "fix name [ID]" for one.'};
  }

  if(/^fix all name|^fix.*name.*format|^apply.*name.*fix/.test(q)){
    var bad=S.assets.filter(function(a){ return needsNameFix(a.name); });
    if(!bad.length) return {text:'All asset names already follow the standard format. Nothing to fix. âœ“'};
    var cmds=[], errors=0;
    for(var i=0;i<bad.length;i++){
      var a=bad[i];
      var newName=fixName(a.name);
      var r=await DB.from('assets').update({name:newName}).eq('id',a.id);
      if(r.error){ cmds.push({ok:false,action:'fixName',detail:a.id,err:r.error.message}); errors++; continue; }
      S.assets=S.assets.map(function(x){ return x.id===a.id?Object.assign({},x,{name:newName}):x; });
      await logAudit('EDIT','Asset',a.id,'Name format fix: '+a.name+' â†’ '+newName);
      cmds.push({ok:true,action:'fixName',detail:a.id+':  '+a.name+' â†’ '+newName});
    }
    return {text:(bad.length-errors)+' name(s) fixed'+(errors?' ('+errors+' errors)':' âœ“')+':\n\n'+
      bad.map(function(a){ return '['+a.id+']  '+a.name+'  â†’  '+fixName(a.name); }).join('\n'), cmds:cmds};
  }

  var fixOne=q.match(/^fix name\s+(\S+)$/);
  if(fixOne){
    var a=findAsset(fixOne[1]);
    if(!a) return {text:'Asset not found: "'+fixOne[1]+'".'};
    if(!needsNameFix(a.name)) return {text:'['+a.id+'] '+a.name+' â€” name already follows the standard format. âœ“'};
    var newName=fixName(a.name);
    var r=await DB.from('assets').update({name:newName}).eq('id',a.id);
    if(r.error) return {text:'Database error: '+r.error.message};
    S.assets=S.assets.map(function(x){ return x.id===a.id?Object.assign({},x,{name:newName}):x; });
    await logAudit('EDIT','Asset',a.id,'Name format fix: '+a.name+' â†’ '+newName);
    return {text:'Fixed ['+a.id+']: '+a.name+' â†’ '+newName,
      cmds:[{ok:true,action:'fixName',detail:a.id+': '+a.name+' â†’ '+newName}]};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // DATA QUALITY AUDIT
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(/^check data quality|^data quality|^audit|^health check/.test(q)){
    var issues=[];
    var badNames=S.assets.filter(function(a){ return needsNameFix(a.name); });
    if(badNames.length) issues.push('âš  '+badNames.length+' asset(s) have name format issues (missing - before M)\n     â†’ Type "fix all name formats" to fix');

    var noLoc=S.assets.filter(function(a){ return !a.location||!a.location.trim(); });
    if(noLoc.length) issues.push('âš  '+noLoc.length+' asset(s) have no location set:\n     '+noLoc.map(function(a){ return a.id; }).join(', '));

    var missingCur=S.assets.filter(function(a){
      return a.active_status&&!S.readings.find(function(r){ return r.asset_id===a.id&&r.month===CUR_MONTH; });
    });
    if(missingCur.length) issues.push('âš  '+missingCur.length+' active asset(s) missing reading for '+fmtMonth(CUR_MONTH)+':\n     '+missingCur.slice(0,8).map(function(a){ return a.id; }).join(', ')+(missingCur.length>8?' â€¦':''));

    var criticals=[];
    S.assets.forEach(function(a){
      var lat=S.readings.filter(function(r){ return r.asset_id===a.id; }).sort(function(x,y){ return y.month.localeCompare(x.month); })[0];
      if(lat&&lat.validation==='CRITICAL') criticals.push(a.id);
    });
    if(criticals.length) issues.push('ğŸ”´ '+criticals.length+' asset(s) in CRITICAL status:\n     '+criticals.join(', '));

    var wrongMax=S.assets.filter(function(a){
      var auto=getMotorType(a.location)==='MV'?65535:getMotorType(a.location)==='LV'?10000:null;
      return auto&&a.meter_max_value!==auto;
    });
    if(wrongMax.length) issues.push('âš  '+wrongMax.length+' asset(s) have mismatched meter_max_value vs location type:\n     '+wrongMax.map(function(a){ return a.id+' (has '+a.meter_max_value+', should be '+getMeterMax(a)+')'; }).join('\n     ')+'\n     â†’ Type "bulk fix meter max" to correct all');

    // Flat readings
    var flat=[];
    S.assets.forEach(function(a){
      var rds=S.readings.filter(function(r){ return r.asset_id===a.id; }).sort(function(x,y){ return y.month.localeCompare(x.month); });
      for(var i=0;i<rds.length-1;i++){
        if(rds[i].raw_meter_reading===rds[i+1].raw_meter_reading){ flat.push(a.id); break; }
      }
    });
    if(flat.length) issues.push('âš  '+flat.length+' asset(s) have flat readings (same value 2+ consecutive months):\n     '+flat.slice(0,8).join(', ')+(flat.length>8?' â€¦':''));

    if(!issues.length) return {text:'âœ“ Data quality check passed â€” no issues found!\n\nFleet: '+S.assets.length+' assets, '+S.readings.length+' total readings.'};
    return {text:'Data Quality Report â€” '+issues.length+' issue(s) found:\n\n'+issues.join('\n\n')};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // FIND SPECIFIC DATA PROBLEMS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(/^find flat readings?|^flat readings?|^stuck readings?/.test(q)){
    var flat=[];
    S.assets.forEach(function(a){
      var rds=S.readings.filter(function(r){ return r.asset_id===a.id; }).sort(function(x,y){ return x.month.localeCompare(y.month); });
      for(var i=1;i<rds.length;i++){
        if(rds[i].raw_meter_reading===rds[i-1].raw_meter_reading)
          flat.push({a:a,month:rds[i].month,val:rds[i].raw_meter_reading,prevMonth:rds[i-1].month});
      }
    });
    if(!flat.length) return {text:'No flat readings found. All consecutive readings show movement. âœ“'};
    return {text:'Flat readings (same value 2+ consecutive months) â€” '+flat.length+' occurrence(s):\n\n'+
      flat.map(function(f){ return '['+f.a.id+'] '+f.a.name+':  '+fmtMonth(f.prevMonth)+' and '+fmtMonth(f.month)+' both = '+f.val.toLocaleString()+' hrs'; }).join('\n')};
  }

  if(/^find suspicious|^suspicious jumps?|^abnormal jumps?/.test(q)){
    var susp=[];
    S.assets.forEach(function(a){
      var rds=S.readings.filter(function(r){ return r.asset_id===a.id; }).sort(function(x,y){ return x.month.localeCompare(y.month); });
      var thr2=(a.threshold_hours&&a.threshold_hours>0)?a.threshold_hours:jt;
      for(var i=1;i<rds.length;i++){
        var diff=rds[i].raw_meter_reading-rds[i-1].raw_meter_reading;
        if(diff>thr2*1.5) susp.push({a:a,month:rds[i].month,diff:diff,thr:thr2});
      }
    });
    if(!susp.length) return {text:'No suspicious jumps found across all historical readings. âœ“'};
    return {text:'Suspicious jumps (>1.5Ã— threshold) â€” '+susp.length+' found:\n\n'+
      susp.map(function(s){ return '['+s.a.id+'] '+s.a.name+':  '+fmtMonth(s.month)+' jumped +'+s.diff.toLocaleString()+' hrs (limit '+s.thr+')'; }).join('\n')};
  }

  if(/^find zero readings?|^zero readings?/.test(q)){
    var zeros=[];
    S.readings.forEach(function(r){ if(r.raw_meter_reading===0) zeros.push(r); });
    if(!zeros.length) return {text:'No zero readings found. âœ“'};
    return {text:'Zero readings found ('+zeros.length+'):\n\n'+
      zeros.map(function(r){
        var a=S.assets.find(function(x){ return x.id===r.asset_id; });
        return '['+r.asset_id+'] '+(a?a.name:'?')+' â€” '+fmtMonth(r.month);
      }).join('\n')};
  }

  if(/^duplicate readings?|^check.*duplicate/.test(q)){
    var seen={}, dups=[];
    S.readings.forEach(function(r){
      var key=r.asset_id+'|'+r.month;
      if(seen[key]) dups.push(r);
      else seen[key]=true;
    });
    if(!dups.length) return {text:'No duplicate readings found. âœ“'};
    return {text:'Duplicate readings ('+dups.length+' extras â€” database issue):\n\n'+
      dups.map(function(r){
        var a=S.assets.find(function(x){ return x.id===r.asset_id; });
        return '['+r.asset_id+'] '+(a?a.name:'?')+' â€” '+fmtMonth(r.month)+' = '+r.raw_meter_reading+' (id: '+r.id+')';
      }).join('\n')};
  }

  if(/^find.*wrong meter max|^assets.*wrong meter|^check meter max/.test(q)){
    var wrong=S.assets.filter(function(a){
      var auto=getMotorType(a.location)==='MV'?65535:getMotorType(a.location)==='LV'?10000:null;
      return auto&&a.meter_max_value!==auto;
    });
    if(!wrong.length) return {text:'All motor meter_max values match their type (MV=65535, LV=10000). âœ“'};
    return {text:'Mismatched meter_max_value vs location type ('+wrong.length+'):\n\n'+
      wrong.map(function(a){ return '['+a.id+'] '+a.name+'\n  Location: '+a.location+'  ('+getMotorType(a.location)+')\n  Has: '+a.meter_max_value+'  Should be: '+getMeterMax(a); }).join('\n\n')+
      '\n\nType "bulk fix meter max" to correct all at once.'};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SET GLOBAL THRESHOLD
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var thr=q.match(/set\s+(global\s+)?threshold\s+to\s+(\d+)/);
  if(thr){
    var n=+thr[2];
    if(n<1||n>10000) return {text:'Threshold must be between 1 and 10,000 hrs.'};
    S.jumpThreshold=n;
    var r=await DB.from('app_settings').upsert({key:'jump_threshold',value:String(n)},{onConflict:'key'});
    if(r.error) return {text:'Database error: '+r.error.message};
    await logAudit('EDIT','AppSettings','jump_threshold','Set global jump threshold to '+n+' hrs');
    render();
    return {text:'Global jump threshold set to '+n.toLocaleString()+' hrs/month for all users. âœ“',
      cmds:[{ok:true,action:'setThreshold',detail:n+' hrs/month'}]};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SHOW ALL / FILTERED ASSETS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(/^show all assets?$|^list all assets?$|^all assets?$/.test(q)){
    if(!S.assets.length) return {text:'No assets in database yet.'};
    return {text:'All assets ('+S.assets.length+'):\n\n'+S.assets.map(fmtAssetLine).join('\n')};
  }
  if(/^show active|^list active|^active assets/.test(q)){
    var a=S.assets.filter(function(x){ return x.active_status; });
    return {text:'Active assets ('+a.length+'):\n\n'+a.map(fmtAssetLine).join('\n')};
  }
  if(/^show inactive|^list inactive|^inactive assets/.test(q)){
    var a=S.assets.filter(function(x){ return !x.active_status; });
    return {text:a.length?'Inactive assets ('+a.length+'):\n\n'+a.map(fmtAssetLine).join('\n'):'No inactive assets.'};
  }
  if(/show mv motor|list mv motor|mv motor/.test(q)){
    var a=S.assets.filter(function(x){ return getMotorType(x.location)==='MV'; });
    return {text:a.length?'MV motors ('+a.length+') â€” 65,535 hr counter:\n\n'+a.map(fmtAssetLine).join('\n'):'No MV motors found (CB in drawer location).'};
  }
  if(/show lv motor|list lv motor|lv motor/.test(q)){
    var a=S.assets.filter(function(x){ return getMotorType(x.location)==='LV'; });
    return {text:a.length?'LV motors ('+a.length+') â€” 10,000 hr counter:\n\n'+a.map(fmtAssetLine).join('\n'):'No LV motors found (CC in drawer location).'};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SEARCH BY KEYWORD
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var searchMatch=q.match(/^search\s+(.+)$/);
  if(searchMatch){
    var kw=searchMatch[1].toUpperCase();
    var found=S.assets.filter(function(a){
      return a.name.toUpperCase().indexOf(kw)>=0||a.id.toUpperCase().indexOf(kw)>=0||(a.location&&a.location.toUpperCase().indexOf(kw)>=0);
    });
    if(!found.length) return {text:'No assets match "'+searchMatch[1]+'".'};
    return {text:'Search results for "'+searchMatch[1]+'" ('+found.length+'):\n\n'+found.map(fmtAssetLine).join('\n')};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // LIST BY LOCATION / IN PANEL
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(/^list assets? by location$|^group by location$|^assets? by location$/.test(q)){
    var locs={};
    S.assets.forEach(function(a){
      var panel=(a.location||'Unknown').split(/\s+/)[0]||'Unknown';
      if(!locs[panel]) locs[panel]=[];
      locs[panel].push(a);
    });
    var keys=Object.keys(locs).sort();
    return {text:'Assets grouped by panel ('+keys.length+' panels):\n\n'+
      keys.map(function(k){ return k+' ('+locs[k].length+'):\n'+locs[k].map(function(a){ return '  ['+a.id+'] '+a.name+(a.active_status?'':' [INACTIVE]'); }).join('\n'); }).join('\n\n')};
  }

  var inPanel=q.match(/^(?:list|show)?\s*assets?\s+in\s+(.+)$|^show\s+(.+)\s+panel$/);
  if(inPanel){
    var panelKw=(inPanel[1]||inPanel[2]||'').toUpperCase().trim();
    var found=S.assets.filter(function(a){ return (a.location||'').toUpperCase().indexOf(panelKw)>=0; });
    if(!found.length) return {text:'No assets found in "'+panelKw+'".'};
    return {text:'Assets in "'+panelKw+'" ('+found.length+'):\n\n'+found.map(fmtAssetLine).join('\n')};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // CRITICAL / WARNING
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(/critical/.test(q)&&!/^show asset|^edit|^set reading/.test(q)){
    var crits=[];
    S.assets.forEach(function(a){
      var lat=S.readings.filter(function(r){ return r.asset_id===a.id; }).sort(function(x,y){ return y.month.localeCompare(x.month); })[0];
      if(lat&&lat.validation==='CRITICAL') crits.push(a);
    });
    return {text:crits.length?'Assets with CRITICAL status ('+crits.length+'):\n\n'+crits.map(fmtAssetLine).join('\n'):'No critical assets. âœ“'};
  }
  if(/warning/.test(q)&&!/^edit|^set reading/.test(q)){
    var warns=[];
    S.assets.forEach(function(a){
      var lat=S.readings.filter(function(r){ return r.asset_id===a.id; }).sort(function(x,y){ return y.month.localeCompare(x.month); })[0];
      if(lat&&lat.validation==='WARNING') warns.push(a);
    });
    return {text:warns.length?'Assets with WARNING status ('+warns.length+'):\n\n'+warns.map(fmtAssetLine).join('\n'):'No warning assets. âœ“'};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // NO READINGS THIS MONTH / EVER
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(/no readings?.*(this month|current)|missing readings/.test(q)){
    var missing=S.assets.filter(function(a){
      return a.active_status&&!S.readings.find(function(r){ return r.asset_id===a.id&&r.month===CUR_MONTH; });
    });
    return {text:missing.length?
      'Active assets missing reading for '+fmtMonth(CUR_MONTH)+' ('+missing.length+'):\n\n'+missing.map(function(a){ return '['+a.id+'] '+a.name+' | '+a.location; }).join('\n'):
      'All active assets have readings for '+fmtMonth(CUR_MONTH)+'. âœ“'};
  }

  if(/zero readings? ever|never.*reading|no readings? ever|assets without any reading/.test(q)){
    var never=S.assets.filter(function(a){ return !S.readings.find(function(r){ return r.asset_id===a.id; }); });
    return {text:never.length?
      'Assets with zero readings ever ('+never.length+'):\n\n'+never.map(function(a){ return '['+a.id+'] '+a.name+' | '+a.location+(a.active_status?'':' [INACTIVE]'); }).join('\n'):
      'All assets have at least one reading. âœ“'};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ASSETS OVER THRESHOLD
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(/over threshold|exceed.*(threshold|limit)|above threshold/.test(q)){
    var over=[];
    S.assets.forEach(function(a){
      var rds=S.readings.filter(function(r){ return r.asset_id===a.id; }).sort(function(x,y){ return y.month.localeCompare(x.month); });
      if(rds.length>=2){
        var diff=rds[0].raw_meter_reading-rds[1].raw_meter_reading;
        var thr2=(a.threshold_hours&&a.threshold_hours>0)?a.threshold_hours:jt;
        if(diff>thr2) over.push({a:a,delta:diff,thr:thr2});
      }
    });
    if(!over.length) return {text:'No assets exceeded the jump threshold this month. âœ“'};
    over.sort(function(a,b){ return b.delta-a.delta; });
    return {text:'Assets over threshold ('+over.length+'):\n\n'+over.map(function(o){
      return '['+o.a.id+'] '+o.a.name+' â€” +'+o.delta.toLocaleString()+' hrs vs '+o.thr+' hr limit (+'+(o.delta-o.thr)+' over)';
    }).join('\n')};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ASSETS NEVER RESET / RESET MANY TIMES
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(/assets? never reset|never been reset|reset count.*0/.test(q)){
    var nr=S.assets.filter(function(a){ return a.active_status&&a.reset_count===0; });
    return {text:nr.length?
      'Active assets never reset ('+nr.length+'):\n\n'+nr.map(function(a){
        var rds=S.readings.filter(function(r){ return r.asset_id===a.id; });
        var lat=rds.sort(function(x,y){ return y.month.localeCompare(x.month); })[0];
        return '['+a.id+'] '+a.name+' â€” current acc: '+calcAcc(a,lat?lat.raw_meter_reading:0).toLocaleString()+' hrs';
      }).join('\n'):
      'All active assets have been reset at least once.'};
  }

  var manyResets=q.match(/reset.*more than\s+(\d+)|reset.*(?:over|above)\s+(\d+)|more than\s+(\d+).*reset/);
  if(manyResets){
    var limit=+(manyResets[1]||manyResets[2]||manyResets[3]);
    var many=S.assets.filter(function(a){ return a.reset_count>limit; });
    return {text:many.length?
      'Assets reset more than '+limit+' time(s) ('+many.length+'):\n\n'+many.map(function(a){ return '['+a.id+'] '+a.name+' â€” '+a.reset_count+' resets'; }).join('\n'):
      'No assets have been reset more than '+limit+' times.'};
  }

  if(/^show all resets?|^list all resets?|^all replacements?$/.test(q)){
    if(!S.repls.length) return {text:'No meter replacements logged yet.'};
    return {text:'All meter replacements ('+S.repls.length+'):\n\n'+
      S.repls.slice().reverse().map(function(r){
        var a=S.assets.find(function(x){ return x.id===r.asset_id; });
        return fmtMonth(r.replacement_date)+' â€” ['+(a?a.id:r.asset_id)+'] '+(a?a.name:r.asset_id)+
          ' â€” Reset '+r.previous_reset_count+'â†’'+r.new_reset_count+
          ' â€” Stuck: '+r.last_stuck_reading.toLocaleString()+' hrs'+(r.notes?' â€” '+r.notes:'');
      }).join('\n')};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // APPROACHING COUNTER LIMIT
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(/approaching.*(?:limit|max|counter)|near.*(?:limit|max|rollover)|close to.*(?:limit|max)/.test(q)){
    var pct=0.85; // 85% of counter max
    var near=[];
    S.assets.forEach(function(a){
      var lat=S.readings.filter(function(r){ return r.asset_id===a.id; }).sort(function(x,y){ return y.month.localeCompare(x.month); })[0];
      if(!lat) return;
      var mx=getMeterMax(a);
      var ratio=lat.raw_meter_reading/mx;
      if(ratio>=pct) near.push({a:a,raw:lat.raw_meter_reading,mx:mx,pct:Math.round(ratio*100)});
    });
    near.sort(function(a,b){ return b.pct-a.pct; });
    return {text:near.length?
      'Assets approaching counter limit (â‰¥85% of max) â€” '+near.length+' found:\n\n'+
      near.map(function(n){ return '['+n.a.id+'] '+n.a.name+':  '+n.raw.toLocaleString()+' / '+n.mx.toLocaleString()+' hrs  ('+n.pct+'%)  '+getMotorType(n.a.location)+' motor'; }).join('\n')+
      '\n\nThese will rollover soon â€” make sure to log a replacement when they do.':
      'No assets are approaching their counter limit (threshold: 85%). âœ“'};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // TOTAL ACCUMULATED RUNTIME
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(/total.*(accumulated|runtime|hours?)|accumulated.*total/.test(q)){
    var total=0, active=0, mv=0, lv=0;
    S.assets.forEach(function(a){
      var lat=S.readings.filter(function(r){ return r.asset_id===a.id; }).sort(function(x,y){ return y.month.localeCompare(x.month); })[0];
      var acc=calcAcc(a,lat?lat.raw_meter_reading:0);
      total+=acc; if(a.active_status) active+=acc;
      if(getMotorType(a.location)==='MV') mv+=acc;
      if(getMotorType(a.location)==='LV') lv+=acc;
    });
    var years=function(h){ return (h/8760).toFixed(1)+' years'; };
    return {text:'Total accumulated runtime:\n\n'+
      '  All assets:    '+total.toLocaleString()+' hrs  ('+years(total)+')\n'+
      '  Active only:   '+active.toLocaleString()+' hrs  ('+years(active)+')\n'+
      '  MV motors:     '+mv.toLocaleString()+' hrs\n'+
      '  LV motors:     '+lv.toLocaleString()+' hrs\n\n'+
      'Fleet: '+S.assets.length+' total ('+S.assets.filter(function(a){ return a.active_status; }).length+' active)'};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // AVERAGE RUNTIME
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(/average runtime|avg runtime|mean runtime/.test(q)){
    var active=S.assets.filter(function(a){ return a.active_status; });
    if(!active.length) return {text:'No active assets.'};
    var total=0;
    active.forEach(function(a){
      var lat=S.readings.filter(function(r){ return r.asset_id===a.id; }).sort(function(x,y){ return y.month.localeCompare(x.month); })[0];
      total+=calcAcc(a,lat?lat.raw_meter_reading:0);
    });
    var avg=Math.round(total/active.length);
    var mvAssets=active.filter(function(a){ return getMotorType(a.location)==='MV'; });
    var lvAssets=active.filter(function(a){ return getMotorType(a.location)==='LV'; });
    var avgMV=0,avgLV=0;
    if(mvAssets.length){ var t=0; mvAssets.forEach(function(a){ var lat=S.readings.filter(function(r){ return r.asset_id===a.id; }).sort(function(x,y){ return y.month.localeCompare(x.month); })[0]; t+=calcAcc(a,lat?lat.raw_meter_reading:0); }); avgMV=Math.round(t/mvAssets.length); }
    if(lvAssets.length){ var t=0; lvAssets.forEach(function(a){ var lat=S.readings.filter(function(r){ return r.asset_id===a.id; }).sort(function(x,y){ return y.month.localeCompare(x.month); })[0]; t+=calcAcc(a,lat?lat.raw_meter_reading:0); }); avgLV=Math.round(t/lvAssets.length); }
    return {text:'Average accumulated runtime per motor:\n\n'+
      '  All active:   '+avg.toLocaleString()+' hrs\n'+
      (mvAssets.length?'  MV motors:   '+avgMV.toLocaleString()+' hrs\n':'')+
      (lvAssets.length?'  LV motors:   '+avgLV.toLocaleString()+' hrs\n':'')+
      '\nBased on '+active.length+' active assets.'};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // RUNTIME BREAKDOWN BY TYPE
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(/runtime breakdown|breakdown by type|type breakdown/.test(q)){
    var groups={MV:[],LV:[],Unknown:[]};
    S.assets.filter(function(a){ return a.active_status; }).forEach(function(a){
      var t=getMotorType(a.location);
      (groups[t]||groups.Unknown).push(a);
    });
    var lines=['Runtime breakdown by motor type:\n'];
    ['MV','LV','Unknown'].forEach(function(t){
      if(!groups[t].length) return;
      var total=0;
      groups[t].forEach(function(a){
        var lat=S.readings.filter(function(r){ return r.asset_id===a.id; }).sort(function(x,y){ return y.month.localeCompare(x.month); })[0];
        total+=calcAcc(a,lat?lat.raw_meter_reading:0);
      });
      var avg=Math.round(total/groups[t].length);
      lines.push(t+' motors ('+groups[t].length+'):\n  Total: '+total.toLocaleString()+' hrs\n  Avg:   '+avg.toLocaleString()+' hrs/motor');
    });
    return {text:lines.join('\n')};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // TOP/BOTTOM N BY RUNTIME
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var topN=q.match(/^show top\s+(\d+)|^top\s+(\d+)|^highest\s+(\d+)/);
  var botN=q.match(/^show bottom\s+(\d+)|^bottom\s+(\d+)|^lowest\s+(\d+)/);
  var n=topN?(+(topN[1]||topN[2]||topN[3])):botN?(+(botN[1]||botN[2]||botN[3])):0;
  if(!n&&/^show top|^top\s+\d|highest runtime$|^show lowest|lowest runtime/.test(q)) n=10;
  if(n>0&&(topN||botN||/top|highest|bottom|lowest/.test(q))){
    var sorted=S.assets.map(function(a){
      var lat=S.readings.filter(function(r){ return r.asset_id===a.id; }).sort(function(x,y){ return y.month.localeCompare(x.month); })[0];
      return {a:a, acc:calcAcc(a,lat?lat.raw_meter_reading:0)};
    }).sort(function(a,b){ return botN?a.acc-b.acc:b.acc-a.acc; }).slice(0,n||10);
    var label=botN?'Bottom':'Top';
    return {text:label+' '+sorted.length+' assets by accumulated runtime:\n\n'+
      sorted.map(function(r,i){ return (i+1)+'. ['+r.a.id+'] '+r.a.name+' â€” '+r.acc.toLocaleString()+' hrs  ('+getMotorType(r.a.location)+')'; }).join('\n')};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // HIGHEST JUMP THIS MONTH / LOWEST RUNTIME
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(/highest.*jump|biggest.*jump|largest.*jump|most.*hours.*this month/.test(q)){
    var jumps=[];
    S.assets.forEach(function(a){
      var rds=S.readings.filter(function(r){ return r.asset_id===a.id; }).sort(function(x,y){ return y.month.localeCompare(x.month); });
      if(rds.length>=2){
        var diff=rds[0].raw_meter_reading-rds[1].raw_meter_reading;
        if(diff>0) jumps.push({a:a,delta:diff,month:rds[0].month});
      }
    });
    jumps.sort(function(a,b){ return b.delta-a.delta; });
    var top5=jumps.slice(0,10);
    return {text:top5.length?'Highest monthly jumps (last recorded):\n\n'+
      top5.map(function(j,i){ return (i+1)+'. ['+j.a.id+'] '+j.a.name+' â€” +'+j.delta.toLocaleString()+' hrs in '+fmtMonth(j.month); }).join('\n'):
      'No consecutive readings found to compute jumps.'};
  }

  if(/^show lowest runtime|^lowest runtime|^least.*hours/.test(q)){
    var active=S.assets.filter(function(a){ return a.active_status; });
    var sorted=active.map(function(a){
      var lat=S.readings.filter(function(r){ return r.asset_id===a.id; }).sort(function(x,y){ return y.month.localeCompare(x.month); })[0];
      return {a:a,acc:calcAcc(a,lat?lat.raw_meter_reading:0)};
    }).sort(function(a,b){ return a.acc-b.acc; }).slice(0,10);
    return {text:'Lowest accumulated runtime (active assets):\n\n'+
      sorted.map(function(r,i){ return (i+1)+'. ['+r.a.id+'] '+r.a.name+' â€” '+r.acc.toLocaleString()+' hrs'; }).join('\n')};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // MOST REPLACED ASSETS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(/most replaced|most resets?|highest reset|reset.*rank/.test(q)){
    var ranked=S.assets.filter(function(a){ return a.reset_count>0; })
      .sort(function(a,b){ return b.reset_count-a.reset_count; }).slice(0,10);
    if(!ranked.length) return {text:'No assets have been reset yet.'};
    return {text:'Most replaced motors (top 10):\n\n'+
      ranked.map(function(a,i){ return (i+1)+'. ['+a.id+'] '+a.name+' â€” '+a.reset_count+' reset(s) â€” stuck: '+a.stuck_reading.toLocaleString()+' hrs'; }).join('\n')};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SHOW MONTH REPORT
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var showMonth=q.match(/^show month\s+(.+)$|^month report\s+(.+)$/);
  if(showMonth){
    var monthStr=(showMonth[1]||showMonth[2]).trim();
    var month=parseMonth(monthStr);
    if(!month) return {text:'Could not parse month: "'+monthStr+'". Try "Jan 2025" or "2025-01".'};
    var rds=S.readings.filter(function(r){ return r.month===month; });
    if(!rds.length) return {text:'No readings found for '+fmtMonth(month)+'.'};
    var ok=0,warn=0,crit=0,reset=0;
    rds.forEach(function(r){
      if(r.validation==='OK') ok++;
      else if(r.validation==='WARNING') warn++;
      else if(r.validation==='CRITICAL') crit++;
      else if(r.validation==='RESET') reset++;
    });
    return {text:'Month report â€” '+fmtMonth(month)+':\n\n'+
      'Readings logged: '+rds.length+' / '+S.assets.filter(function(a){ return a.active_status; }).length+' active assets\n'+
      'OK:       '+ok+'\n'+
      'WARNING:  '+warn+'\n'+
      'CRITICAL: '+crit+'\n'+
      'RESET:    '+reset+'\n'+
      'Locked:   '+(S.closed.indexOf(month)>=0?'Yes':'No')+'\n\n'+
      rds.map(function(r){
        var a=S.assets.find(function(x){ return x.id===r.asset_id; });
        return '['+r.asset_id+'] '+(a?a.name:'?')+':  '+r.raw_meter_reading.toLocaleString()+' hrs  ['+r.validation+']';
      }).join('\n')};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SUMMARY REPORT
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(/^summary|^report$|^status report/.test(q)){
    var active=S.assets.filter(function(a){ return a.active_status; });
    var warns2=0,crits2=0,nodata=0,resets2=0,oks=0;
    active.forEach(function(a){
      var lat=S.readings.filter(function(r){ return r.asset_id===a.id; }).sort(function(x,y){ return y.month.localeCompare(x.month); })[0];
      if(!lat) nodata++;
      else if(lat.validation==='CRITICAL') crits2++;
      else if(lat.validation==='WARNING') warns2++;
      else if(lat.validation==='RESET') resets2++;
      else oks++;
    });
    var badNames=S.assets.filter(function(a){ return needsNameFix(a.name); }).length;
    var mvC=S.assets.filter(function(a){ return getMotorType(a.location)==='MV'; }).length;
    var lvC=S.assets.filter(function(a){ return getMotorType(a.location)==='LV'; }).length;
    var total=0; S.assets.forEach(function(a){ var lat=S.readings.filter(function(r){ return r.asset_id===a.id; }).sort(function(x,y){ return y.month.localeCompare(x.month); })[0]; total+=calcAcc(a,lat?lat.raw_meter_reading:0); });
    return {text:
      'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n'+
      'â•‘  HourTrack â€” '+fmtMonth(CUR_MONTH).padEnd(24)+'â•‘\n'+
      'â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n'+
      'â•‘  FLEET                               â•‘\n'+
      'â•‘  Total assets:    '+String(S.assets.length).padEnd(18)+'â•‘\n'+
      'â•‘  Active:          '+String(active.length).padEnd(18)+'â•‘\n'+
      'â•‘  Inactive:        '+String(S.assets.length-active.length).padEnd(18)+'â•‘\n'+
      'â•‘  MV motors (CB):  '+String(mvC).padEnd(18)+'â•‘\n'+
      'â•‘  LV motors (CC):  '+String(lvC).padEnd(18)+'â•‘\n'+
      'â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n'+
      'â•‘  THIS MONTH STATUS                   â•‘\n'+
      'â•‘  OK:              '+String(oks).padEnd(18)+'â•‘\n'+
      'â•‘  Warning:         '+String(warns2).padEnd(18)+'â•‘\n'+
      'â•‘  Critical:        '+String(crits2).padEnd(18)+'â•‘\n'+
      'â•‘  Reset/Rollover:  '+String(resets2).padEnd(18)+'â•‘\n'+
      'â•‘  No data:         '+String(nodata).padEnd(18)+'â•‘\n'+
      'â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n'+
      'â•‘  RUNTIME                             â•‘\n'+
      'â•‘  Total fleet:     '+String(total.toLocaleString()+' hrs').padEnd(18)+'â•‘\n'+
      'â•‘  Jump threshold:  '+String((S.jumpThreshold||800)+' hrs/mo').padEnd(18)+'â•‘\n'+
      'â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n'+
      'â•‘  DATA QUALITY                        â•‘\n'+
      'â•‘  Name issues:     '+String(badNames+(badNames?' (type "fix all name formats")':'')).padEnd(18)+'â•‘\n'+
      'â•‘  Closed months:   '+String(S.closed.length).padEnd(18)+'â•‘\n'+
      'â•‘  Total readings:  '+String(S.readings.length).padEnd(18)+'â•‘\n'+
      'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SHOW REPLACEMENTS (general / for specific asset)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var replFor=q.match(/^show replacements?\s+(?:for\s+)?(.+)$/);
  if(replFor&&!/^show replacements?$/.test(q)){
    var a=findAsset(replFor[1]);
    if(!a) return {text:'Asset not found: "'+replFor[1]+'".'};
    var ar=S.repls.filter(function(r){ return r.asset_id===a.id; });
    if(!ar.length) return {text:'No replacements logged for ['+a.id+'] '+a.name+'.'};
    return {text:'Replacements for ['+a.id+'] '+a.name+' ('+ar.length+'):\n\n'+
      ar.map(function(r){ return fmtMonth(r.replacement_date)+' â€” Reset '+r.previous_reset_count+'â†’'+r.new_reset_count+' â€” Stuck: '+r.last_stuck_reading.toLocaleString()+' hrs'+(r.notes?' â€” '+r.notes:''); }).join('\n')};
  }
  if(/^show replacements?|^list replacements?|^all replacements?/.test(q)){
    if(!S.repls.length) return {text:'No meter replacements logged yet.'};
    return {text:'All replacements ('+S.repls.length+'):\n\n'+
      S.repls.slice().reverse().map(function(r){
        var a=S.assets.find(function(x){ return x.id===r.asset_id; });
        return fmtMonth(r.replacement_date)+' â€” ['+(a?a.id:r.asset_id)+'] '+(a?a.name:r.asset_id)+' â€” Reset '+r.previous_reset_count+'â†’'+r.new_reset_count+' â€” Stuck: '+r.last_stuck_reading.toLocaleString()+' hrs'+(r.notes?' â€” '+r.notes:'');
      }).join('\n')};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SHOW CLOSED MONTHS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(/closed months?|locked months?/.test(q)){
    return {text:S.closed.length?
      'Closed months ('+S.closed.length+'):\n\n'+S.closed.slice().sort().map(fmtMonth).join('\n'):
      'No months have been closed yet.'};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SHOW SPECIFIC ASSET
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var showAsset=q.match(/^show asset\s+(.+)$|^info(?:rmation)?\s+(?:on\s+|for\s+|about\s+)?(.+)$|^details?\s+(?:for\s+|of\s+)?(.+)$/);
  if(showAsset){
    var term=(showAsset[1]||showAsset[2]||showAsset[3]||'').trim();
    var a=findAsset(term);
    if(!a) return {text:'Asset not found: "'+term+'".'};
    var rds=S.readings.filter(function(r){ return r.asset_id===a.id; }).sort(function(x,y){ return x.month.localeCompare(y.month); });
    var lat=rds[rds.length-1];
    var acc=calcAcc(a,lat?lat.raw_meter_reading:0);
    var type=getMotorType(a.location);
    var nameFix=needsNameFix(a.name)?'\nâš  Name format issue â†’ type "fix name '+a.id+'" to correct':'';
    var rlines=rds.slice(-6).reverse().map(function(r,i){
      var idx2=rds.length-1-i;
      var prev2=rds[idx2-1];
      var delta=prev2?r.raw_meter_reading-prev2.raw_meter_reading:null;
      return '  '+fmtMonth(r.month)+':  '+r.raw_meter_reading.toLocaleString()+' hrs raw'+(delta!==null?'  (Î” '+delta+')':'  (first)')+' ['+r.validation+']';
    }).join('\n');
    return {text:
      '['+a.id+'] '+a.name+nameFix+'\n'+
      'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n'+
      'Location:       '+a.location+'\n'+
      'Type:           '+type+' motor ('+getMeterMax(a).toLocaleString()+' hr counter)\n'+
      'Status:         '+(a.active_status?'Active':'INACTIVE')+'\n'+
      'Accumulated:    '+acc.toLocaleString()+' hrs\n'+
      'Reset count:    '+a.reset_count+'Ã—\n'+
      'Stuck reading:  '+a.stuck_reading.toLocaleString()+' hrs\n'+
      'Latest raw:     '+(lat?lat.raw_meter_reading.toLocaleString()+' hrs  ['+lat.validation+']':'No readings')+'\n'+
      'Jump threshold: '+((a.threshold_hours&&a.threshold_hours>0)?a.threshold_hours:(S.jumpThreshold||800))+' hrs/month\n'+
      'Total readings: '+rds.length+'\n'+
      '\nLast 6 readings:\n'+rlines};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SHOW READINGS FOR ASSET
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var showReadings=q.match(/^show readings?\s+(?:for\s+)?(.+)$|^readings?\s+(?:for\s+)?(.+)$/);
  if(showReadings){
    var term=(showReadings[1]||showReadings[2]).trim();
    var a=findAsset(term);
    if(!a) return {text:'Asset not found: "'+term+'".'};
    var rds=S.readings.filter(function(r){ return r.asset_id===a.id; }).sort(function(x,y){ return x.month.localeCompare(y.month); });
    if(!rds.length) return {text:'No readings for ['+a.id+'] '+a.name+'.'};
    return {text:'All readings for ['+a.id+'] '+a.name+' ('+rds.length+'):\n\n'+
      rds.map(function(r,i){
        var prev2=rds[i-1];
        var delta=prev2?r.raw_meter_reading-prev2.raw_meter_reading:null;
        return fmtMonth(r.month)+':  '+r.raw_meter_reading.toLocaleString()+' raw'+(delta!==null?'  Î” '+delta:'  (first)')+
          '  acc: '+calcAcc(a,r.raw_meter_reading).toLocaleString()+
          '  ['+r.validation+']'+(r.locked?'  ğŸ”’':'');
      }).join('\n')};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // DEACTIVATE / ACTIVATE SINGLE ASSET
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var deact=q.match(/^(?:deactivate|retire|disable)\s+(.+)$/);
  if(deact){
    var a=findAsset(deact[1].trim());
    if(!a) return {text:'Asset not found: "'+deact[1]+'".'};
    if(!a.active_status) return {text:'['+a.id+'] '+a.name+' is already inactive.'};
    var r=await DB.from('assets').update({active_status:false}).eq('id',a.id);
    if(r.error) return {text:'Database error: '+r.error.message};
    S.assets=S.assets.map(function(x){ return x.id===a.id?Object.assign({},x,{active_status:false}):x; });
    await logAudit('EDIT','Asset',a.id,'Deactivated via command console');
    return {text:'['+a.id+'] '+a.name+' deactivated.',cmds:[{ok:true,action:'deactivate',detail:a.id}]};
  }
  var act=q.match(/^(?:activate|reactivate|enable)\s+(.+)$/);
  if(act){
    var a=findAsset(act[1].trim());
    if(!a) return {text:'Asset not found: "'+act[1]+'".'};
    if(a.active_status) return {text:'['+a.id+'] '+a.name+' is already active.'};
    var r=await DB.from('assets').update({active_status:true}).eq('id',a.id);
    if(r.error) return {text:'Database error: '+r.error.message};
    S.assets=S.assets.map(function(x){ return x.id===a.id?Object.assign({},x,{active_status:true}):x; });
    await logAudit('EDIT','Asset',a.id,'Activated via command console');
    return {text:'['+a.id+'] '+a.name+' activated.',cmds:[{ok:true,action:'activate',detail:a.id}]};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // EDIT SINGLE ASSET FIELDS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var editMatch=q.match(/^(?:edit|update|change|set)\s+(\S+)\s+(name|location|threshold|meter\s*max(?:\s*value)?|reset\s*count|stuck\s*reading)\s+to\s+(.+)$/);
  var renameMatch=q.match(/^rename\s+(\S+)\s+to\s+(.+)$/);
  if(editMatch||renameMatch){
    var assetTerm, field, newVal;
    if(renameMatch){ assetTerm=renameMatch[1]; field='name'; newVal=renameMatch[2].replace(/^["'\s]+|["'\s]+$/g,''); }
    else { assetTerm=editMatch[1]; field=editMatch[2].replace(/\s+/g,'_'); newVal=editMatch[3].replace(/^["'\s]+|["'\s]+$/g,''); }
    var a=findAsset(assetTerm);
    if(!a) return {text:'Asset not found: "'+assetTerm+'".'};
    var fieldMap={name:{db:'name',num:false},location:{db:'location',num:false},threshold:{db:'threshold_hours',num:true},
      meter_max:{db:'meter_max_value',num:true},meter_max_value:{db:'meter_max_value',num:true},
      reset_count:{db:'reset_count',num:true},stuck_reading:{db:'stuck_reading',num:true}};
    var fm=fieldMap[field];
    if(!fm) return {text:'Unknown field "'+field+'".'};
    var dbVal=fm.num?+newVal:newVal;
    if(fm.num&&isNaN(dbVal)) return {text:'"'+newVal+'" is not a valid number.'};
    var upd={}; upd[fm.db]=dbVal;
    var r=await DB.from('assets').update(upd).eq('id',a.id);
    if(r.error) return {text:'Database error: '+r.error.message};
    S.assets=S.assets.map(function(x){ return x.id===a.id?Object.assign({},x,upd):x; });
    await logAudit('EDIT','Asset',a.id,'Set '+fm.db+' to '+dbVal);
    return {text:'Updated ['+a.id+'] '+a.name+':\n  '+fm.db+' = '+dbVal,
      cmds:[{ok:true,action:'editAsset',detail:a.id+' â€” '+fm.db+' â†’ '+dbVal}]};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // BULK EDITS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  // bulk set threshold to N  (all / MV / LV)
  var bulkThr=q.match(/^bulk\s+set\s+threshold\s+(mv|lv|all)?\s*to\s+(\d+)$/)||
               q.match(/^set\s+(mv|lv|all)\s+threshold\s+to\s+(\d+)$/);
  if(bulkThr){
    var typeFilter=((bulkThr[1]||'all')).toUpperCase();
    var n=+(bulkThr[2]);
    if(n<1||n>10000) return {text:'Threshold must be between 1 and 10,000.'};
    var targets=S.assets.filter(function(a){
      if(typeFilter==='MV') return getMotorType(a.location)==='MV';
      if(typeFilter==='LV') return getMotorType(a.location)==='LV';
      return true;
    });
    var cmds=[], errs=0;
    for(var i=0;i<targets.length;i++){
      var r=await DB.from('assets').update({threshold_hours:n}).eq('id',targets[i].id);
      if(r.error){ errs++; continue; }
      S.assets=S.assets.map(function(x){ return x.id===targets[i].id?Object.assign({},x,{threshold_hours:n}):x; });
      cmds.push({ok:true,action:'bulkSetThreshold',detail:targets[i].id+' â†’ '+n+' hrs'});
    }
    await logAudit('EDIT','Bulk','threshold_hours','Bulk set threshold to '+n+' for '+typeFilter);
    return {text:'Bulk threshold update complete:\n  Type: '+(typeFilter==='ALL'?'All assets':typeFilter+' motors')+'\n  New threshold: '+n+' hrs/month\n  Updated: '+(targets.length-errs)+(errs?' ('+errs+' errors)':' assets âœ“'), cmds:cmds};
  }

  // bulk fix meter max  â€” set MV=65535, LV=10000
  if(/^bulk fix meter max|^fix all meter max|^fix meter max/.test(q)){
    var wrong=S.assets.filter(function(a){
      var auto=getMotorType(a.location)==='MV'?65535:getMotorType(a.location)==='LV'?10000:null;
      return auto&&a.meter_max_value!==auto;
    });
    if(!wrong.length) return {text:'All meter_max values already match their motor type. âœ“'};
    var cmds=[], errs=0;
    for(var i=0;i<wrong.length;i++){
      var a=wrong[i];
      var correctMax=getMeterMax(a);
      var r=await DB.from('assets').update({meter_max_value:correctMax}).eq('id',a.id);
      if(r.error){ errs++; cmds.push({ok:false,action:'bulkFixMeterMax',detail:a.id,err:r.error.message}); continue; }
      S.assets=S.assets.map(function(x){ return x.id===a.id?Object.assign({},x,{meter_max_value:correctMax}):x; });
      await logAudit('EDIT','Asset',a.id,'Bulk fix meter_max: '+a.meter_max_value+' â†’ '+correctMax);
      cmds.push({ok:true,action:'bulkFixMeterMax',detail:a.id+': '+a.meter_max_value+' â†’ '+correctMax});
    }
    return {text:(wrong.length-errs)+' meter_max value(s) corrected'+(errs?' ('+errs+' errors)':' âœ“')+':\n\n'+
      wrong.map(function(a){ return '['+a.id+'] '+a.name+': '+a.meter_max_value+' â†’ '+getMeterMax(a)+' ('+getMotorType(a.location)+')'; }).join('\n'), cmds:cmds};
  }

  // bulk deactivate / activate assets in [panel]
  var bulkDeact=q.match(/^bulk\s+deactivate\s+assets?\s+in\s+(.+)$/);
  if(bulkDeact){
    var kw=bulkDeact[1].toUpperCase();
    var targets=S.assets.filter(function(a){ return a.active_status&&(a.location||'').toUpperCase().indexOf(kw)>=0; });
    if(!targets.length) return {text:'No active assets found in "'+bulkDeact[1]+'".'};
    var cmds=[], errs=0;
    for(var i=0;i<targets.length;i++){
      var r=await DB.from('assets').update({active_status:false}).eq('id',targets[i].id);
      if(r.error){ errs++; continue; }
      S.assets=S.assets.map(function(x){ return x.id===targets[i].id?Object.assign({},x,{active_status:false}):x; });
      await logAudit('EDIT','Asset',targets[i].id,'Bulk deactivate in '+kw);
      cmds.push({ok:true,action:'bulkDeactivate',detail:targets[i].id});
    }
    return {text:(targets.length-errs)+' assets deactivated in "'+bulkDeact[1]+'"'+(errs?' ('+errs+' errors)':' âœ“'), cmds:cmds};
  }

  var bulkAct=q.match(/^bulk\s+activate\s+assets?\s+in\s+(.+)$/);
  if(bulkAct){
    var kw=bulkAct[1].toUpperCase();
    var targets=S.assets.filter(function(a){ return !a.active_status&&(a.location||'').toUpperCase().indexOf(kw)>=0; });
    if(!targets.length) return {text:'No inactive assets found in "'+bulkAct[1]+'".'};
    var cmds=[], errs=0;
    for(var i=0;i<targets.length;i++){
      var r=await DB.from('assets').update({active_status:true}).eq('id',targets[i].id);
      if(r.error){ errs++; continue; }
      S.assets=S.assets.map(function(x){ return x.id===targets[i].id?Object.assign({},x,{active_status:true}):x; });
      await logAudit('EDIT','Asset',targets[i].id,'Bulk activate in '+kw);
      cmds.push({ok:true,action:'bulkActivate',detail:targets[i].id});
    }
    return {text:(targets.length-errs)+' assets activated in "'+bulkAct[1]+'"'+(errs?' ('+errs+' errors)':' âœ“'), cmds:cmds};
  }

  // bulk deactivate inactive (assets with no readings this month for X months)
  if(/^bulk deactivate inactive|^deactivate all inactive/.test(q)){
    var targets=S.assets.filter(function(a){
      if(!a.active_status) return false;
      return !S.readings.find(function(r){ return r.asset_id===a.id; });
    });
    if(!targets.length) return {text:'No active assets with zero readings ever found.'};
    var cmds=[], errs=0;
    for(var i=0;i<targets.length;i++){
      var r=await DB.from('assets').update({active_status:false}).eq('id',targets[i].id);
      if(r.error){ errs++; continue; }
      S.assets=S.assets.map(function(x){ return x.id===targets[i].id?Object.assign({},x,{active_status:false}):x; });
      await logAudit('EDIT','Asset',targets[i].id,'Bulk deactivate: no readings ever');
      cmds.push({ok:true,action:'bulkDeactivateInactive',detail:targets[i].id+' '+targets[i].name});
    }
    return {text:(targets.length-errs)+' assets with zero readings ever have been deactivated'+(errs?' ('+errs+' errors)':' âœ“'), cmds:cmds};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SET / DELETE READING
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var setRead=q.match(/(?:set|update|correct|fix)\s+reading\s+(?:for\s+)?(\S+)\s+(?:in\s+)?(.+?)\s+to\s+(\d+)/)||
               q.match(/(?:set|update|correct|fix)\s+(\S+)\s+(?:reading\s+)?(?:for\s+|in\s+)?(.+?)\s+to\s+(\d+)/);
  if(setRead){
    var assetTerm=setRead[1],monthStr=setRead[2],num=+setRead[3];
    var a=findAsset(assetTerm);
    if(!a) return {text:'Asset not found: "'+assetTerm+'".'};
    var month=parseMonth(monthStr);
    if(!month) return {text:'Could not parse month: "'+monthStr+'".'};
    if(isNaN(num)||num<0) return {text:'Invalid reading value.'};
    var v=validateReading(a,S.readings,num,month);
    var rec={id:uid(),asset_id:a.id,month:month,raw_meter_reading:num,locked:false,
      created_at:new Date().toISOString(),created_by:S.session.user.email+' (console)',validation:v.status};
    var r2=await DB.from('monthly_readings').upsert(rec,{onConflict:'asset_id,month'});
    if(r2.error) return {text:'Database error: '+r2.error.message};
    var idx=-1;
    for(var i=0;i<S.readings.length;i++){ if(S.readings[i].asset_id===a.id&&S.readings[i].month===month){idx=i;break;} }
    if(idx>=0){ S.readings[idx]=rec; } else { S.readings.push(rec); }
    await logAudit('EDIT','MonthlyReading',a.id,'Console: '+fmtMonth(month)+' = '+num+' hrs ['+v.status+']');
    return {text:'Set ['+a.id+'] '+a.name+':\n  '+fmtMonth(month)+' = '+num.toLocaleString()+' hrs\n  Validation: '+v.status+(v.message?' â€” '+v.message:''),
      cmds:[{ok:true,action:'setReading',detail:a.id+' '+fmtMonth(month)+' = '+num+' ['+v.status+']'}]};
  }

  var delRead=q.match(/(?:delete|remove)\s+reading\s+(?:for\s+)?(\S+)\s+(?:in\s+)?(.+)$/);
  if(delRead){
    var a=findAsset(delRead[1]);
    if(!a) return {text:'Asset not found: "'+delRead[1]+'".'};
    var month=parseMonth(delRead[2]);
    if(!month) return {text:'Could not parse month: "'+delRead[2]+'".'};
    var r3=await DB.from('monthly_readings').delete().eq('asset_id',a.id).eq('month',month);
    if(r3.error) return {text:'Database error: '+r3.error.message};
    S.readings=S.readings.filter(function(x){ return !(x.asset_id===a.id&&x.month===month); });
    await logAudit('DELETE','MonthlyReading',a.id,'Console deleted '+fmtMonth(month));
    return {text:'Deleted '+fmtMonth(month)+' reading for ['+a.id+'] '+a.name+'.',
      cmds:[{ok:true,action:'deleteReading',detail:a.id+' '+fmtMonth(month)}]};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // CLOSE / REOPEN MONTH
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var closeM=q.match(/^close\s+(?:month\s+)?(.+)$/);
  if(closeM){
    var month=parseMonth(closeM[1].trim());
    if(!month) return {text:'Could not parse month: "'+closeM[1]+'".'};
    if(S.closed.indexOf(month)>=0) return {text:fmtMonth(month)+' is already closed.'};
    var r4=await DB.from('closed_months').upsert({month:month,closed_by:S.session.user.email});
    if(r4.error) return {text:'Database error: '+r4.error.message};
    if(S.closed.indexOf(month)<0) S.closed.push(month);
    await logAudit('CLOSE_MONTH','Month',month,'Console closed '+fmtMonth(month));
    return {text:fmtMonth(month)+' closed. âœ“',cmds:[{ok:true,action:'closeMonth',detail:fmtMonth(month)}]};
  }

  var openM=q.match(/^(?:reopen|open|unlock)\s+(?:month\s+)?(.+)$/);
  if(openM){
    var month=parseMonth(openM[1].trim());
    if(!month) return {text:'Could not parse month: "'+openM[1]+'".'};
    if(S.closed.indexOf(month)<0) return {text:fmtMonth(month)+' is not closed.'};
    var r5=await DB.from('closed_months').delete().eq('month',month);
    if(r5.error) return {text:'Database error: '+r5.error.message};
    S.closed=S.closed.filter(function(x){ return x!==month; });
    await logAudit('UNLOCK','Month',month,'Console reopened '+fmtMonth(month));
    return {text:fmtMonth(month)+' reopened. âœ“',cmds:[{ok:true,action:'openMonth',detail:fmtMonth(month)}]};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // FALLBACK â€” smart asset detection
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var words=raw.trim().split(/\s+/);
  for(var wi=0;wi<words.length;wi++){
    var maybe=findAsset(words[wi]);
    if(maybe&&words[wi].length>1){
      return {text:'Did you want info on ['+maybe.id+'] '+maybe.name+'?\n\nTry:\n  show asset '+maybe.id+'\n  show readings '+maybe.id+'\n  edit '+maybe.id+' name to "New Name"\n\nType help to see all commands.'};
    }
  }
  return {text:'Command not recognised: "'+raw+'"\n\nType help to see everything I can do.\n\nCommon commands:\n  show critical assets\n  check data quality\n  fix all name formats\n  summary report\n  show top 10 by runtime'};
}





// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if(!CONFIGURED){
  S.view='setup'; render();
} else {
  DB.auth.getSession().then(function(r){
    var sess=r.data&&r.data.session;
    S.session=sess;
    S.view=sess?'app':'login';
    if(sess){
      loadProfile(sess.user.id).then(function(){ loadData(); });
    } else { render(); }
  });
  DB.auth.onAuthStateChange(function(_,sess){
    S.session=sess;
    if(sess){
      S.view='app';
      loadProfile(sess.user.id).then(function(){ loadData(); });
    } else { S.view='login'; render(); }
  });
}
</script>
</body>
</html>
