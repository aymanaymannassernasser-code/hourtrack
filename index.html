<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HourTrack â€” Industrial Runtime Management</title>
  <meta name="description" content="Industrial equipment hour meter and runtime tracking" />
  <meta name="theme-color" content="#09090b" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    * { box-sizing: border-box; }
    body { margin: 0; background: #09090b; font-family: 'IBM Plex Mono', 'Courier New', monospace; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #18181b; }
    ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
    select option { background: #18181b; }
  </style>

  <!-- importmap: tells the browser where React and htm live. No Babel, no build step. -->
  <script type="importmap">
  {
    "imports": {
      "react":            "https://esm.sh/react@18.3.1",
      "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
      "htm/react":        "https://esm.sh/htm@3.1.1/react"
    }
  }
  </script>
</head>
<body>
  <div id="root">
    <div style="color:#f59e0b;padding:2rem;font-family:'IBM Plex Mono',monospace;font-size:13px">
      â— Loading HourTrackâ€¦
    </div>
  </div>

  <script type="module">
    import React, { useState, useEffect, useMemo } from 'react';
    import { createRoot } from 'react-dom/client';
    import html from 'htm/react';

    // â”€â”€â”€ PERSISTENCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const load = (k, fb) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : fb; } catch { return fb; } };
    const save = (k, v)  => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} };

    // â”€â”€â”€ SEED DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const now = new Date();
    const MONTHS = Array.from({ length: 12 }, (_, i) => {
      const d = new Date(now.getFullYear(), now.getMonth() - 11 + i, 1);
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-01`;
    });

    const SEED_ASSETS = [
      { id:'A001', name:'Compressor Unit #1',   location:'Building A â€” Bay 3',    meter_max_value:9999,  reset_count:1, stuck_reading:9850,  created_at:'2022-01-01', active_status:true, threshold_hours:200 },
      { id:'A002', name:'Hydraulic Press #7',   location:'Building B â€” Floor 2',  meter_max_value:9999,  reset_count:0, stuck_reading:0,     created_at:'2022-03-15', active_status:true, threshold_hours:180 },
      { id:'A003', name:'Diesel Generator G-2', location:'Utility Block',          meter_max_value:99999, reset_count:2, stuck_reading:87650, created_at:'2021-06-01', active_status:true, threshold_hours:350 },
      { id:'A004', name:'Pump Station P-4',     location:'Building C â€” Basement',  meter_max_value:9999,  reset_count:0, stuck_reading:0,     created_at:'2023-01-10', active_status:true, threshold_hours:160 },
    ];

    const rows = [
      ['A001',[820,1640,2460,3280,4100,9850,820,1640,2460,3280,4100,4920], i=>i===5?'RESET':'OK'],
      ['A002',[150,300,450,600,750,900,1050,1200,1350,1500,1650,1800],     ()=>'OK'],
      ['A003',[310,620,930,1240,1550,1860,2170,2480,2790,3100,3410,3720],  i=>i===3?'WARNING':'OK'],
      ['A004',[0,120,240,360,480,600,720,840,960,1080,1200,1320],          ()=>'OK'],
    ];
    let rid = 1;
    const SEED_READINGS = MONTHS.flatMap((m,i) =>
      rows.map(([aid,vals,vfn]) => ({
        id:`R${rid++}`, asset_id:aid, month:m, raw_meter_reading:vals[i],
        locked: i < MONTHS.length-2, created_at:m, created_by:'eng.smith', validation:vfn(i)
      }))
    );

    const SEED_REPLS = [
      { id:'RL1', asset_id:'A001', replacement_date:MONTHS[5],  last_stuck_reading:9850,  previous_reset_count:0, new_reset_count:1, notes:'Meter maxed out. Replaced with OEM unit.' },
      { id:'RL2', asset_id:'A003', replacement_date:MONTHS[0],  last_stuck_reading:43250, previous_reset_count:1, new_reset_count:2, notes:'Scheduled replacement during annual overhaul.' },
    ];

    const SEED_AUDIT = [
      { id:'AU1', timestamp:'2024-11-01T08:22:00Z', user:'admin.root', action:'UNLOCK', entity:'MonthlyReading', entity_id:'R5', detail:'Unlocked for correction' },
      { id:'AU2', timestamp:'2024-11-01T08:45:00Z', user:'eng.smith',  action:'EDIT',   entity:'MonthlyReading', entity_id:'R5', detail:'Corrected reading 3100 â†’ 3280' },
    ];

    // â”€â”€â”€ UTILITIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const fmtMonth = m => new Date(m+'T12:00:00Z').toLocaleDateString('en-US',{month:'short',year:'numeric'});
    const calcAcc  = (asset, raw) => asset.reset_count * asset.meter_max_value + asset.stuck_reading + (raw||0);

    const validate = (asset, readings, val, month) => {
      if (val < 0) return { status:'CRITICAL', message:'Negative reading not allowed.' };
      const prev = [...readings].filter(r=>r.asset_id===asset.id && r.month<month).sort((a,b)=>b.month.localeCompare(a.month))[0];
      if (!prev) return { status:'OK', message:'First reading for this asset.' };
      const diff = val - prev.raw_meter_reading;
      if (diff < 0) return { status:'CRITICAL', message:`Decreased by ${Math.abs(diff)} hrs. Record a reset first?` };
      if (diff > asset.threshold_hours*1.5) return { status:'CRITICAL', message:`+${diff} hrs exceeds critical limit.` };
      if (diff > asset.threshold_hours) return { status:'WARNING', message:`+${diff} hrs exceeds ${asset.threshold_hours} hr threshold.` };
      return { status:'OK', message:`+${diff} hrs this month.` };
    };

    const exportCSV = (data, filename) => {
      if (!data.length) return;
      const keys = Object.keys(data[0]);
      const csv = [keys.join(','), ...data.map(r=>keys.map(k=>`"${r[k]??''}"`).join(','))].join('\n');
      Object.assign(document.createElement('a'),{href:'data:text/csv;charset=utf-8,'+encodeURIComponent(csv),download:filename}).click();
    };

    // â”€â”€â”€ STYLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const S = {
      badge: v => { const m={OK:'bg-emerald-900/60 text-emerald-300 border-emerald-700',WARNING:'bg-amber-900/60 text-amber-300 border-amber-700',CRITICAL:'bg-red-900/60 text-red-300 border-red-700',RESET:'bg-sky-900/60 text-sky-300 border-sky-700'}; return `text-[10px] font-mono font-bold px-2 py-0.5 rounded border ${m[v]||m.OK}`; },
      input:  'bg-zinc-900 border border-zinc-700 text-zinc-100 rounded px-3 py-2 text-sm font-mono focus:outline-none focus:border-amber-500 w-full',
      btn:    'px-4 py-2 rounded text-sm font-semibold tracking-wide transition-all cursor-pointer',
      btnP:   'bg-amber-500 hover:bg-amber-400 text-zinc-950',
      btnS:   'bg-zinc-800 hover:bg-zinc-700 text-zinc-200 border border-zinc-700',
      card:   'bg-zinc-900 border border-zinc-800 rounded-lg p-5',
      th:     'px-3 py-2 text-left text-[10px] font-mono font-bold text-zinc-500 uppercase tracking-widest',
      td:     'px-3 py-2 text-sm font-mono text-zinc-300 border-t border-zinc-800/60',
    };

    // â”€â”€â”€ SVG LINE CHART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function SvgChart({ data, keys, colors, height=180 }) {
      const allVals = data.flatMap(d => keys.map(k=>d[k]).filter(v=>v!=null&&!isNaN(v)));
      if (!allVals.length) return html`<p class="text-zinc-600 text-sm">No data.</p>`;
      const minY=Math.min(...allVals), maxY=Math.max(...allVals), range=maxY-minY||1;
      const pad={t:10,r:10,b:28,l:60}, W=800, H=height;
      const iW=W-pad.l-pad.r, iH=H-pad.t-pad.b;
      const toX=i=>pad.l+i*(iW/(data.length-1||1));
      const toY=v=>pad.t+iH-((v-minY)/range)*iH;
      const yTicks=[0,0.25,0.5,0.75,1].map(f=>({v:Math.round(minY+range*f),y:toY(minY+range*f)}));
      const xStep=Math.ceil(data.length/6);
      return html`
        <svg viewBox="0 0 ${W} ${H}" style=${{width:'100%',height:`${height}px`,display:'block'}}>
          ${yTicks.map(({v,y})=>html`
            <g key=${v}>
              <line x1=${pad.l} y1=${y} x2=${W-pad.r} y2=${y} stroke="#27272a" stroke-dasharray="3,3"/>
              <text x=${pad.l-6} y=${y+4} text-anchor="end" fill="#71717a" font-size="10" font-family="monospace">${v>999?(v/1000).toFixed(1)+'k':v}</text>
            </g>
          `)}
          ${data.filter((_,i)=>i%xStep===0||i===data.length-1).map((d,i)=>html`
            <text key=${i} x=${toX(data.indexOf(d))} y=${H-4} text-anchor="middle" fill="#71717a" font-size="9" font-family="monospace">${d.label}</text>
          `)}
          ${keys.map((k,ki)=>{
            const pts=data.map((d,i)=>d[k]!=null&&!isNaN(d[k])?`${toX(i)},${toY(d[k])}`:null).filter(Boolean);
            return pts.length<2?null:html`<path key=${k} d=${'M'+pts.join('L')} fill="none" stroke=${colors[ki]||'#f59e0b'} stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`;
          })}
        </svg>`;
    }

    function Legend({ keys, colors }) {
      return html`<div class="flex gap-4 flex-wrap mt-2">
        ${keys.map((k,i)=>html`<div key=${k} class="flex items-center gap-1.5 text-[11px] text-zinc-400">
          <div style=${{width:16,height:2,background:colors[i]||'#f59e0b',borderRadius:1}}></div>${k}
        </div>`)}
      </div>`;
    }

    // â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function Toast({ notif }) {
      if (!notif) return null;
      const cls = notif.type==='error'?'bg-red-950 border-red-700 text-red-200':notif.type==='success'?'bg-emerald-950 border-emerald-700 text-emerald-200':'bg-zinc-800 border-zinc-600 text-zinc-200';
      return html`<div class=${'fixed top-4 right-4 z-50 px-5 py-3 rounded-lg text-sm font-mono border shadow-xl '+cls}>${notif.msg}</div>`;
    }

    // â”€â”€â”€ ROOT APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function App() {
      const [assets,  setAssets]  = useState(()=>load('ht_assets',  SEED_ASSETS));
      const [readings,setReadings]= useState(()=>load('ht_readings', SEED_READINGS));
      const [repls,   setRepls]   = useState(()=>load('ht_repls',   SEED_REPLS));
      const [audit,   setAudit]   = useState(()=>load('ht_audit',   SEED_AUDIT));
      const [closed,  setClosed]  = useState(()=>{ const v=load('ht_closed',null); return v?new Set(v):new Set(MONTHS.slice(0,MONTHS.length-2)); });
      const [view,    setView]    = useState('dashboard');
      const [detailId,setDetailId]= useState(null);
      const [role,    setRole]    = useState(()=>load('ht_role','admin'));
      const [notif,   setNotif]   = useState(null);

      useEffect(()=>save('ht_assets',  assets),   [assets]);
      useEffect(()=>save('ht_readings',readings), [readings]);
      useEffect(()=>save('ht_repls',   repls),    [repls]);
      useEffect(()=>save('ht_audit',   audit),    [audit]);
      useEffect(()=>save('ht_closed',  [...closed]),[closed]);
      useEffect(()=>save('ht_role',    role),     [role]);

      const notify = (msg, type='info') => { setNotif({msg,type}); setTimeout(()=>setNotif(null),3500); };
      const addAudit = (user,action,entity,entity_id,detail) =>
        setAudit(p=>[{id:`AU${Date.now()}`,timestamp:new Date().toISOString(),user,action,entity,entity_id,detail},...p]);

      const currentMonth = MONTHS[MONTHS.length-1];
      const prevMonth    = MONTHS[MONTHS.length-2];

      const stats = useMemo(()=>{
        let w=0,c=0;
        readings.filter(r=>r.month===currentMonth).forEach(r=>{ if(r.validation==='WARNING')w++; if(r.validation==='CRITICAL')c++; });
        return { total:assets.filter(a=>a.active_status).length, warnings:w, criticals:c };
      },[assets,readings,currentMonth]);

      const nav = ['dashboard','assets','entry','replacements','reports','audit'];
      const navLabel = { dashboard:'Dashboard', assets:'Assets', entry:'Monthly Entry', replacements:'Replacements', reports:'Reports', audit:'Audit Log' };

      const go = (v, did=null) => { setView(v); setDetailId(did); };
      const sp = { assets,setAssets,readings,setReadings,repls,setRepls,audit,setAudit,closed,setClosed,role,notify,addAudit,currentMonth,prevMonth,detailId,setDetailId,go };

      return html`
        <div class="min-h-screen bg-zinc-950 text-zinc-100" style=${{fontFamily:"'IBM Plex Mono',monospace"}}>
          <${Toast} notif=${notif}/>

          <header class="border-b border-zinc-800 bg-zinc-950 sticky top-0 z-40">
            <div class="flex items-center justify-between px-4 py-3">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-amber-500 rounded flex items-center justify-center text-zinc-950 font-bold text-sm">H</div>
                <div>
                  <div class="text-sm font-semibold tracking-widest text-amber-400 uppercase">HourTrack</div>
                  <div class="text-[9px] text-zinc-600 tracking-widest uppercase hidden sm:block">Industrial Runtime Management</div>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-[10px] text-zinc-600 uppercase tracking-widest hidden sm:block">Role:</span>
                <select value=${role} onChange=${e=>setRole(e.target.value)} class="bg-zinc-900 border border-zinc-700 text-amber-400 text-[11px] font-mono rounded px-2 py-1 focus:outline-none">
                  <option value="admin">Admin</option>
                  <option value="engineer">Engineer</option>
                  <option value="viewer">Viewer</option>
                </select>
              </div>
            </div>
            <nav class="flex overflow-x-auto px-2">
              ${nav.map(n=>html`
                <button key=${n} onClick=${()=>go(n)}
                  class=${'whitespace-nowrap px-3 py-2.5 text-[11px] font-mono tracking-widest uppercase border-b-2 transition-all '+(view===n?'border-amber-500 text-amber-400':'border-transparent text-zinc-500 hover:text-zinc-300')}>
                  ${navLabel[n]}
                </button>
              `)}
            </nav>
          </header>

          <main class="p-4 max-w-7xl mx-auto">
            ${view==='dashboard'    && html`<${Dashboard}    ...${sp} stats=${stats}/>`}
            ${view==='assets'       && html`<${Assets}       ...${sp}/>`}
            ${view==='entry'        && html`<${MonthlyEntry} ...${sp}/>`}
            ${view==='replacements' && html`<${Replacements} ...${sp}/>`}
            ${view==='reports'      && html`<${Reports}      ...${sp}/>`}
            ${view==='audit'        && html`<${AuditLog}     ...${sp}/>`}
          </main>
        </div>`;
    }

    // â”€â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function Dashboard({ assets,readings,repls,stats,closed,setClosed,go,role,notify,addAudit,currentMonth,prevMonth }) {
      const closeMonth = () => {
        if(role!=='admin'){ notify('Only Admin can close months.','error'); return; }
        setClosed(p=>new Set([...p,prevMonth]));
        addAudit(role,'CLOSE_MONTH','Month',prevMonth,`Closed ${fmtMonth(prevMonth)}`);
        notify(`${fmtMonth(prevMonth)} locked. âœ“`,'success');
      };
      const chartData = MONTHS.map(m=>({
        label:fmtMonth(m),
        [assets[0]?.name]: (()=>{ const r=readings.find(rd=>rd.asset_id===assets[0]?.id&&rd.month===m); return r?calcAcc(assets[0],r.raw_meter_reading):null; })(),
        [assets[1]?.name]: (()=>{ const r=readings.find(rd=>rd.asset_id===assets[1]?.id&&rd.month===m); return r?calcAcc(assets[1],r.raw_meter_reading):null; })(),
      }));
      return html`<div class="space-y-5">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <h1 class="text-xl font-bold tracking-widest text-zinc-100 uppercase">System Overview</h1>
            <p class="text-xs text-zinc-500 mt-1">Period: ${fmtMonth(currentMonth)}</p>
          </div>
          <div class="flex gap-2 flex-wrap">
            <button onClick=${()=>go('entry')}        class="${S.btn} ${S.btnP}">+ Reading</button>
            <button onClick=${()=>go('replacements')} class="${S.btn} ${S.btnS}">â†º Replace</button>
            <button onClick=${closeMonth}              class="${S.btn} ${S.btnS}">âŠ  Close Month</button>
            <button onClick=${()=>go('reports')}       class="${S.btn} ${S.btnS}">â†“ Reports</button>
          </div>
        </div>
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
          ${[{label:'Active Assets',val:stats.total,color:'text-amber-400'},{label:'Warnings',val:stats.warnings,color:'text-amber-300'},{label:'Critical',val:stats.criticals,color:'text-red-400'},{label:'Current Period',val:fmtMonth(currentMonth),color:'text-emerald-400',sm:true}].map(c=>html`
            <div key=${c.label} class=${S.card}>
              <div class="text-[10px] uppercase tracking-widest text-zinc-500 mb-2">${c.label}</div>
              <div class=${'font-bold tracking-tight '+(c.sm?'text-lg':'text-3xl')+' '+c.color}>${c.val}</div>
            </div>
          `)}
        </div>
        <div class=${S.card}>
          <div class="text-xs font-bold uppercase tracking-widest text-zinc-400 mb-4">Asset Runtime Status</div>
          <div class="overflow-x-auto">
            <table class="w-full min-w-[640px]">
              <thead><tr>${['Asset','Latest','Accumulated','Monthly Î”','Resets','Status',''].map(h=>html`<th key=${h} class=${S.th}>${h}</th>`)}</tr></thead>
              <tbody>
                ${assets.filter(a=>a.active_status).map(a=>{
                  const srt=readings.filter(r=>r.asset_id===a.id).sort((x,y)=>y.month.localeCompare(x.month));
                  const latest=srt[0],prev2=srt[1];
                  const acc=calcAcc(a,latest?.raw_meter_reading||0);
                  const delta=latest&&prev2?latest.raw_meter_reading-prev2.raw_meter_reading:null;
                  const v=latest?.validation||'OK';
                  const pct=Math.min(100,(acc/(a.meter_max_value*5))*100);
                  return html`<tr key=${a.id} class="hover:bg-zinc-800/40 cursor-pointer" onClick=${()=>go('assets',a.id)}>
                    <td class=${S.td}><div class="font-semibold text-zinc-100">${a.name}</div><div class="text-[10px] text-zinc-600">${a.id} â€” ${a.location}</div></td>
                    <td class=${S.td}>${latest?latest.raw_meter_reading.toLocaleString():'â€”'} hrs</td>
                    <td class=${S.td}>
                      <div class="text-amber-400 font-bold">${acc.toLocaleString()} hrs</div>
                      <div class="w-28 h-1 bg-zinc-800 rounded mt-1 overflow-hidden"><div class=${'h-full rounded '+(pct>85?'bg-red-500':pct>60?'bg-amber-500':'bg-emerald-500')} style=${{width:pct+'%'}}></div></div>
                    </td>
                    <td class=${S.td}>${delta!==null?html`<span class=${delta>a.threshold_hours?'text-amber-400':'text-emerald-400'}>+${delta} hrs</span>`:'â€”'}</td>
                    <td class="${S.td} text-zinc-500">${a.reset_count}Ã—</td>
                    <td class=${S.td}><span class=${S.badge(v)}>${v}</span></td>
                    <td class="${S.td} text-zinc-600">â†’</td>
                  </tr>`;
                })}
              </tbody>
            </table>
          </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class=${S.card}>
            <div class="text-xs font-bold uppercase tracking-widest text-zinc-400 mb-4">Recent Replacements</div>
            ${repls.length===0?html`<p class="text-zinc-600 text-sm">No replacements logged.</p>`:
              [...repls].reverse().slice(0,4).map(r=>{ const a=assets.find(a=>a.id===r.asset_id); return html`<div key=${r.id} class="border-l-2 border-amber-700 pl-3 mb-3">
                <div class="text-sm text-zinc-200 font-semibold">${a?.name}</div>
                <div class="text-xs text-zinc-500">${fmtMonth(r.replacement_date)} â€” Reset #${r.new_reset_count} â€” Stuck: ${r.last_stuck_reading.toLocaleString()} hrs</div>
                <div class="text-[10px] text-zinc-600 italic mt-0.5">${r.notes}</div>
              </div>`; })
            }
          </div>
          <div class=${S.card}>
            <div class="text-xs font-bold uppercase tracking-widest text-zinc-400 mb-2">Accumulated Trend (top 2 assets)</div>
            <${SvgChart} data=${chartData} keys=${[assets[0]?.name,assets[1]?.name].filter(Boolean)} colors=${['#f59e0b','#6ee7b7']} height=${160}/>
            <${Legend}   keys=${[assets[0]?.name,assets[1]?.name].filter(Boolean)} colors=${['#f59e0b','#6ee7b7']}/>
          </div>
        </div>
      </div>`;
    }

    // â”€â”€â”€ ASSETS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function Assets({ assets,setAssets,readings,repls,role,notify,addAudit,detailId,setDetailId }) {
      const [showAdd,setShowAdd]=useState(false);
      const [form,setForm]=useState({name:'',location:'',meter_max_value:9999,threshold_hours:200});
      const asset = detailId?assets.find(a=>a.id===detailId):null;

      const addAsset=()=>{
        if(!form.name){ notify('Name required.','error'); return; }
        const id=`A${String(assets.length+1).padStart(3,'0')}`;
        setAssets(p=>[...p,{id,name:form.name,location:form.location,meter_max_value:+form.meter_max_value,reset_count:0,stuck_reading:0,created_at:new Date().toISOString().slice(0,10),active_status:true,threshold_hours:+form.threshold_hours}]);
        addAudit(role,'CREATE','Asset',id,`Created: ${form.name}`);
        notify(`Asset ${id} registered. âœ“`,'success');
        setShowAdd(false); setForm({name:'',location:'',meter_max_value:9999,threshold_hours:200});
      };

      if (asset) {
        const ar=readings.filter(r=>r.asset_id===asset.id).sort((a,b)=>a.month.localeCompare(b.month));
        const latest=ar[ar.length-1];
        const acc=calcAcc(asset,latest?.raw_meter_reading||0);
        const assetRepls=repls.filter(r=>r.asset_id===asset.id);
        const chartData=ar.map((r,i)=>({label:fmtMonth(r.month),'Accumulated':calcAcc(asset,r.raw_meter_reading),'Monthly Î”':i>0?r.raw_meter_reading-ar[i-1].raw_meter_reading:0}));
        return html`<div class="space-y-5">
          <div class="flex items-center gap-3">
            <button onClick=${()=>setDetailId(null)} class="${S.btn} ${S.btnS} text-xs">â† Back</button>
            <div><h1 class="text-lg font-bold uppercase tracking-widest text-zinc-100">${asset.name}</h1><p class="text-xs text-zinc-500">${asset.id} â€” ${asset.location}</p></div>
          </div>
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
            ${[['Accumulated Runtime',`${acc.toLocaleString()} hrs`,'text-amber-400'],['Reset Count',asset.reset_count,'text-sky-400'],['Stuck Reading',`${asset.stuck_reading.toLocaleString()} hrs`,'text-zinc-300'],['Latest Raw',latest?`${latest.raw_meter_reading.toLocaleString()} hrs`:'â€”','text-zinc-300']].map(([l,v,c])=>html`
              <div key=${l} class=${S.card}><div class="text-[10px] uppercase tracking-widest text-zinc-500 mb-1">${l}</div><div class=${'text-2xl font-bold '+c}>${v}</div></div>
            `)}
          </div>
          <div class="${S.card} border-amber-900/40">
            <div class="text-[10px] uppercase tracking-widest text-amber-500 mb-2 font-bold">Runtime Formula</div>
            <div class="text-sm text-zinc-400 font-mono flex flex-wrap gap-1 items-center">
              <span class="text-sky-400">${asset.reset_count}</span><span class="text-zinc-600"> Ã— </span>
              <span class="text-zinc-300">${asset.meter_max_value.toLocaleString()}</span><span class="text-zinc-600"> + </span>
              <span class="text-zinc-300">${asset.stuck_reading.toLocaleString()}</span><span class="text-zinc-600"> + </span>
              <span class="text-zinc-300">${latest?.raw_meter_reading||0}</span><span class="text-zinc-600"> = </span>
              <span class="text-amber-400 font-bold">${acc.toLocaleString()} hrs</span>
            </div>
          </div>
          <div class=${S.card}>
            <div class="text-xs font-bold uppercase tracking-widest text-zinc-400 mb-2">Runtime Trend</div>
            <${SvgChart} data=${chartData} keys=${['Accumulated','Monthly Î”']} colors=${['#f59e0b','#6ee7b7']} height=${200}/>
            <${Legend} keys=${['Accumulated hrs','Monthly Î” hrs']} colors=${['#f59e0b','#6ee7b7']}/>
            ${assetRepls.length>0?html`<p class="text-[10px] text-sky-400 mt-2">Meter resets: ${assetRepls.map(r=>fmtMonth(r.replacement_date)).join(', ')}</p>`:null}
          </div>
          <div class=${S.card}>
            <div class="text-xs font-bold uppercase tracking-widest text-zinc-400 mb-3">Reading History</div>
            <div class="overflow-x-auto">
              <table class="w-full min-w-[500px]">
                <thead><tr>${['Month','Raw','Monthly Î”','Accumulated','Status','Locked'].map(h=>html`<th key=${h} class=${S.th}>${h}</th>`)}</tr></thead>
                <tbody>${ar.map((r,i)=>{ const prev=ar[i-1],delta=prev?r.raw_meter_reading-prev.raw_meter_reading:null; return html`<tr key=${r.id} class="hover:bg-zinc-800/30">
                  <td class=${S.td}>${fmtMonth(r.month)}</td>
                  <td class=${S.td}>${r.raw_meter_reading.toLocaleString()} hrs</td>
                  <td class=${S.td}>${delta!==null?html`<span class=${delta<0?'text-red-400':delta>asset.threshold_hours?'text-amber-400':'text-emerald-400'}>+${delta}</span>`:'â€”'}</td>
                  <td class="${S.td} text-amber-400">${calcAcc(asset,r.raw_meter_reading).toLocaleString()}</td>
                  <td class=${S.td}><span class=${S.badge(r.validation)}>${r.validation}</span></td>
                  <td class=${S.td}>${r.locked?html`<span class="text-zinc-500 text-xs">ğŸ”’ Locked</span>`:html`<span class="text-emerald-500 text-xs">Open</span>`}</td>
                </tr>`; })}</tbody>
              </table>
            </div>
          </div>
        </div>`;
      }

      return html`<div class="space-y-5">
        <div class="flex items-center justify-between">
          <h1 class="text-xl font-bold uppercase tracking-widest text-zinc-100">Asset Registry</h1>
          ${(role==='admin'||role==='engineer')?html`<button onClick=${()=>setShowAdd(!showAdd)} class="${S.btn} ${S.btnP}">+ New Asset</button>`:null}
        </div>
        ${showAdd?html`<div class="${S.card} border-amber-800/60">
          <div class="text-xs uppercase tracking-widest text-amber-400 mb-4 font-bold">Register New Asset</div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div><label class="text-[10px] text-zinc-500 uppercase tracking-widest block mb-1">Name *</label><input class=${S.input} value=${form.name} onInput=${e=>setForm(p=>({...p,name:e.target.value}))} placeholder="Compressor Unit #1"/></div>
            <div><label class="text-[10px] text-zinc-500 uppercase tracking-widest block mb-1">Location</label><input class=${S.input} value=${form.location} onInput=${e=>setForm(p=>({...p,location:e.target.value}))} placeholder="Building A â€” Bay 3"/></div>
            <div><label class="text-[10px] text-zinc-500 uppercase tracking-widest block mb-1">Meter Max</label><input type="number" class=${S.input} value=${form.meter_max_value} onInput=${e=>setForm(p=>({...p,meter_max_value:e.target.value}))}/></div>
            <div><label class="text-[10px] text-zinc-500 uppercase tracking-widest block mb-1">Monthly Threshold (hrs)</label><input type="number" class=${S.input} value=${form.threshold_hours} onInput=${e=>setForm(p=>({...p,threshold_hours:e.target.value}))}/></div>
          </div>
          <div class="flex gap-2 mt-4">
            <button onClick=${addAsset} class="${S.btn} ${S.btnP}">Register</button>
            <button onClick=${()=>setShowAdd(false)} class="${S.btn} ${S.btnS}">Cancel</button>
          </div>
        </div>`:null}
        <div class=${S.card}>
          <div class="overflow-x-auto">
            <table class="w-full min-w-[600px]">
              <thead><tr>${['ID','Name','Location','Meter Max','Resets','Threshold','Status',''].map(h=>html`<th key=${h} class=${S.th}>${h}</th>`)}</tr></thead>
              <tbody>${assets.map(a=>html`<tr key=${a.id} class="hover:bg-zinc-800/40 cursor-pointer" onClick=${()=>setDetailId(a.id)}>
                <td class="${S.td} text-amber-400">${a.id}</td>
                <td class="${S.td} font-semibold text-zinc-100">${a.name}</td>
                <td class="${S.td} text-zinc-500 text-xs">${a.location}</td>
                <td class=${S.td}>${a.meter_max_value.toLocaleString()}</td>
                <td class=${S.td}>${a.reset_count}</td>
                <td class=${S.td}>${a.threshold_hours} hrs/mo</td>
                <td class=${S.td}><span class=${'text-[10px] px-2 py-0.5 rounded border '+(a.active_status?'bg-emerald-900/40 text-emerald-400 border-emerald-800':'bg-zinc-800 text-zinc-500 border-zinc-700')}>${a.active_status?'ACTIVE':'INACTIVE'}</span></td>
                <td class="${S.td} text-zinc-600">â†’</td>
              </tr>`)}</tbody>
            </table>
          </div>
        </div>
      </div>`;
    }

    // â”€â”€â”€ MONTHLY ENTRY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function MonthlyEntry({ assets,readings,setReadings,closed,role,notify,addAudit,currentMonth }) {
      const [selMonth,setSelMonth]=useState(currentMonth);
      const [vals,setVals]=useState({});
      const [res,setRes]=useState({});
      const isLocked=closed.has(selMonth);
      const canEdit=(role==='admin'||role==='engineer')&&!isLocked;

      useEffect(()=>{
        const init={};
        assets.forEach(a=>{ const ex=readings.find(r=>r.asset_id===a.id&&r.month===selMonth); if(ex) init[a.id]=String(ex.raw_meter_reading); });
        setVals(init); setRes({});
      },[selMonth]);

      const handleChange=(aid,val)=>{
        setVals(p=>({...p,[aid]:val}));
        const asset=assets.find(a=>a.id===aid);
        if(val!==''&&!isNaN(val)) setRes(p=>({...p,[aid]:validate(asset,readings,+val,selMonth)}));
      };

      const submit=()=>{
        if(!canEdit){ notify('Month is locked or insufficient role.','error'); return; }
        let count=0;
        setReadings(prev=>{
          let upd=[...prev];
          assets.forEach(a=>{
            const val=vals[a.id]; if(val===undefined||val==='') return;
            const num=+val; if(isNaN(num)) return;
            const v=validate(a,upd,num,selMonth);
            const idx=upd.findIndex(r=>r.asset_id===a.id&&r.month===selMonth);
            const rec={id:idx>=0?upd[idx].id:`R${Date.now()}${Math.random()}`,asset_id:a.id,month:selMonth,raw_meter_reading:num,locked:false,created_at:new Date().toISOString(),created_by:`${role}.user`,validation:v.status};
            if(idx>=0){ upd[idx]=rec; addAudit(role,'EDIT','MonthlyReading',rec.id,`Updated to ${num}`); }
            else{ upd.push(rec); addAudit(role,'CREATE','MonthlyReading',rec.id,`New reading ${num}`); }
            count++;
          });
          return upd;
        });
        notify(`${count} reading(s) saved. âœ“`,'success');
      };

      return html`<div class="space-y-5">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div><h1 class="text-xl font-bold uppercase tracking-widest text-zinc-100">Monthly Entry</h1><p class="text-xs text-zinc-500 mt-1">Record meter readings for all assets</p></div>
          <div class="flex items-center gap-3 flex-wrap">
            <select value=${selMonth} onChange=${e=>setSelMonth(e.target.value)} class="bg-zinc-900 border border-zinc-700 text-zinc-200 text-sm font-mono rounded px-3 py-2 focus:outline-none focus:border-amber-500">
              ${MONTHS.map(m=>html`<option key=${m} value=${m}>${fmtMonth(m)}</option>`)}
            </select>
            ${isLocked?html`<span class="text-xs text-zinc-500 border border-zinc-700 rounded px-3 py-2">ğŸ”’ Locked</span>`:null}
            ${canEdit?html`<button onClick=${submit} class="${S.btn} ${S.btnP}">Save All</button>`:null}
          </div>
        </div>
        ${isLocked&&role==='admin'?html`<div class="border border-amber-800/60 rounded p-3 bg-amber-950/20 text-xs text-amber-400">âš  Month is closed. Admin edits are audited.</div>`:null}
        <div class=${S.card}>
          <div class="overflow-x-auto">
            <table class="w-full min-w-[600px]">
              <thead><tr>${['Asset','Prev Reading','New Reading','Validation','Accumulated'].map(h=>html`<th key=${h} class=${S.th}>${h}</th>`)}</tr></thead>
              <tbody>${assets.filter(a=>a.active_status).map(a=>{
                const prev=readings.filter(r=>r.asset_id===a.id&&r.month<selMonth).sort((x,y)=>y.month.localeCompare(x.month))[0];
                const val=vals[a.id]||'',r=res[a.id];
                const acc=val!==''&&!isNaN(val)?calcAcc(a,+val):null;
                const bord=r?(r.status==='OK'?'border-emerald-700':r.status==='WARNING'?'border-amber-600':'border-red-600'):'border-zinc-700';
                return html`<tr key=${a.id} class="border-t border-zinc-800/60 hover:bg-zinc-800/20">
                  <td class="px-3 py-3"><div class="text-sm font-semibold text-zinc-100">${a.name}</div><div class="text-[10px] text-zinc-600">${a.id}</div></td>
                  <td class="px-3 py-3 font-mono text-sm text-zinc-400">${prev?prev.raw_meter_reading.toLocaleString():'â€”'}</td>
                  <td class="px-3 py-3"><input type="number" min="0" class=${'bg-zinc-900 border text-zinc-100 rounded px-3 py-2 text-sm font-mono focus:outline-none w-32 '+bord} value=${val} onInput=${e=>handleChange(a.id,e.target.value)} disabled=${!canEdit} placeholder="hrs"/></td>
                  <td class="px-3 py-3">${r?html`<div><span class=${S.badge(r.status)}>${r.status}</span><div class="text-[10px] text-zinc-500 mt-1">${r.message}</div></div>`:html`<span class="text-zinc-700 text-xs">â€”</span>`}</td>
                  <td class="px-3 py-3 font-mono text-amber-400 font-bold">${acc!==null?`${acc.toLocaleString()} hrs`:'â€”'}</td>
                </tr>`;
              })}</tbody>
            </table>
          </div>
        </div>
      </div>`;
    }

    // â”€â”€â”€ REPLACEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function Replacements({ assets,setAssets,repls,setRepls,readings,role,notify,addAudit }) {
      const [step,setStep]=useState(0);
      const [form,setForm]=useState({asset_id:'',last_reading:'',notes:''});
      const [confirmed,setConfirmed]=useState(null);
      const canEdit=role==='admin'||role==='engineer';

      const start=()=>{ if(!form.asset_id){ notify('Select an asset.','error'); return; }
        const latest=readings.filter(r=>r.asset_id===form.asset_id).sort((a,b)=>b.month.localeCompare(a.month))[0];
        setForm(p=>({...p,last_reading:latest?.raw_meter_reading||0})); setStep(1); };

      const confirm=()=>{ const a=assets.find(a=>a.id===form.asset_id);
        const newReset=a.reset_count+1,newStuck=a.stuck_reading+(+form.last_reading);
        const rl={id:`RL${Date.now()}`,asset_id:form.asset_id,replacement_date:MONTHS[MONTHS.length-1],last_stuck_reading:+form.last_reading,previous_reset_count:a.reset_count,new_reset_count:newReset,notes:form.notes};
        setRepls(p=>[...p,rl]); setAssets(p=>p.map(x=>x.id===form.asset_id?{...x,reset_count:newReset,stuck_reading:newStuck}:x));
        addAudit(role,'METER_REPLACEMENT','Asset',form.asset_id,`Reset ${a.reset_count}â†’${newReset}. Stuck: ${newStuck}`);
        setConfirmed({asset:a,rl,newReset,newStuck}); setStep(2); notify('Meter replacement logged. âœ“','success'); };

      const a=assets.find(x=>x.id===form.asset_id);

      return html`<div class="space-y-5">
        <h1 class="text-xl font-bold uppercase tracking-widest text-zinc-100">Meter Replacements</h1>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
          <div class="space-y-4">
            <div class="flex items-center gap-2">
              ${['Select','Confirm','Done'].map((s,i)=>html`<span key=${s} class="flex items-center gap-2">
                <span class=${'w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-bold border '+(step>=i?'bg-amber-500 border-amber-500 text-zinc-950':'bg-zinc-900 border-zinc-700 text-zinc-600')}>${i+1}</span>
                <span class=${'text-[11px] tracking-widest uppercase '+(step>=i?'text-zinc-300':'text-zinc-600')}>${s}</span>
                ${i<2?html`<span class=${'w-6 h-px '+(step>i?'bg-amber-500':'bg-zinc-700')}></span>`:null}
              </span>`)}
            </div>
            ${step===0?html`<div class="${S.card} border-amber-900/40">
              <div class="text-xs uppercase tracking-widest text-amber-400 mb-3 font-bold">Step 1 â€” Select Asset</div>
              <div class="space-y-3">
                <div><label class="text-[10px] text-zinc-500 uppercase tracking-widest block mb-1">Asset</label>
                  <select value=${form.asset_id} onChange=${e=>setForm(p=>({...p,asset_id:e.target.value}))} class=${S.input}>
                    <option value="">â€” Select â€”</option>
                    ${assets.filter(a=>a.active_status).map(a=>html`<option key=${a.id} value=${a.id}>${a.name} (${a.id})</option>`)}
                  </select></div>
                <div><label class="text-[10px] text-zinc-500 uppercase tracking-widest block mb-1">Notes</label>
                  <textarea class=${S.input} rows="2" value=${form.notes} onInput=${e=>setForm(p=>({...p,notes:e.target.value}))} placeholder="Reason for replacement..."></textarea></div>
                ${canEdit?html`<button onClick=${start} class="${S.btn} ${S.btnP} w-full">Next â†’</button>`:html`<div class="text-xs text-zinc-600">Insufficient role.</div>`}
              </div>
            </div>`:null}
            ${step===1&&a?html`<div class="${S.card} border-amber-900/40">
              <div class="text-xs uppercase tracking-widest text-amber-400 mb-3 font-bold">Step 2 â€” Confirm Last Reading</div>
              <div class="space-y-3">
                <div><label class="text-[10px] text-zinc-500 uppercase tracking-widest block mb-1">Last Raw Reading (becomes stuck reading)</label>
                  <input type="number" class=${S.input} value=${form.last_reading} onInput=${e=>setForm(p=>({...p,last_reading:e.target.value}))}/></div>
                <div class="bg-zinc-950/60 border border-zinc-800 rounded p-3 text-xs font-mono space-y-1">
                  <div class="text-zinc-500">reset_count: <span class="text-zinc-300">${a.reset_count}</span> â†’ <span class="text-amber-400">${a.reset_count+1}</span></div>
                  <div class="text-zinc-500">new stuck_reading: <span class="text-amber-400">${(a.stuck_reading+(+form.last_reading)).toLocaleString()} hrs</span></div>
                </div>
                <div class="flex gap-2">
                  <button onClick=${()=>setStep(0)} class="${S.btn} ${S.btnS}">â† Back</button>
                  <button onClick=${confirm} class="${S.btn} bg-red-900 hover:bg-red-800 text-red-200 border border-red-700">Confirm Reset</button>
                </div>
              </div>
            </div>`:null}
            ${step===2&&confirmed?html`<div class="${S.card} border-emerald-800/60">
              <div class="text-xs uppercase tracking-widest text-emerald-400 mb-3 font-bold">âœ“ Replacement Logged</div>
              <div class="text-sm font-mono text-zinc-400 space-y-1">
                <div>Asset: <span class="text-zinc-100">${confirmed.asset.name}</span></div>
                <div>New Reset Count: <span class="text-amber-400">${confirmed.newReset}</span></div>
                <div>Total Stuck: <span class="text-amber-400">${confirmed.newStuck.toLocaleString()} hrs</span></div>
              </div>
              <button onClick=${()=>{ setStep(0); setForm({asset_id:'',last_reading:'',notes:''}); setConfirmed(null); }} class="${S.btn} ${S.btnP} mt-4">Log Another</button>
            </div>`:null}
          </div>
          <div class=${S.card}>
            <div class="text-xs font-bold uppercase tracking-widest text-zinc-400 mb-3">Replacement Log</div>
            <div class="overflow-x-auto">
              <table class="w-full min-w-[400px]">
                <thead><tr>${['Date','Asset','Stuck Rdg','Reset #','Notes'].map(h=>html`<th key=${h} class=${S.th}>${h}</th>`)}</tr></thead>
                <tbody>${[...repls].reverse().map(r=>{ const a=assets.find(a=>a.id===r.asset_id); return html`<tr key=${r.id} class="hover:bg-zinc-800/30">
                  <td class=${S.td}>${fmtMonth(r.replacement_date)}</td>
                  <td class=${S.td}><div class="text-zinc-100">${a?.name}</div><div class="text-[10px] text-zinc-600">${r.asset_id}</div></td>
                  <td class="${S.td} text-amber-400">${r.last_stuck_reading.toLocaleString()}</td>
                  <td class=${S.td}>${r.previous_reset_count}â†’<span class="text-sky-400">${r.new_reset_count}</span></td>
                  <td class="${S.td} text-zinc-500 text-xs">${r.notes}</td>
                </tr>`; })}</tbody>
              </table>
            </div>
          </div>
        </div>
      </div>`;
    }

    // â”€â”€â”€ REPORTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function Reports({ assets,readings }) {
      const [selMonth,setSelMonth]=useState(MONTHS[MONTHS.length-1]);
      const colors=['#f59e0b','#6ee7b7','#38bdf8','#f472b6'];
      const report=assets.map(a=>{
        const r=readings.find(rd=>rd.asset_id===a.id&&rd.month===selMonth);
        const prev=readings.filter(rd=>rd.asset_id===a.id&&rd.month<selMonth).sort((x,y)=>y.month.localeCompare(x.month))[0];
        return {id:a.id,name:a.name,location:a.location,raw_reading:r?.raw_meter_reading??'N/A',monthly_delta:r&&prev?r.raw_meter_reading-prev.raw_meter_reading:null,accumulated_runtime:calcAcc(a,r?.raw_meter_reading||0),threshold_hrs:a.threshold_hours,status:r?.validation??'N/A'};
      });
      const trendData=MONTHS.map(m=>{ const e={label:fmtMonth(m)}; assets.forEach(a=>{ const r=readings.find(rd=>rd.asset_id===a.id&&rd.month===m); e[a.name]=r?calcAcc(a,r.raw_meter_reading):null; }); return e; });
      return html`<div class="space-y-5">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <h1 class="text-xl font-bold uppercase tracking-widest text-zinc-100">Reports</h1>
          <div class="flex gap-2 flex-wrap">
            <select value=${selMonth} onChange=${e=>setSelMonth(e.target.value)} class="bg-zinc-900 border border-zinc-700 text-zinc-200 text-sm font-mono rounded px-3 py-2 focus:outline-none focus:border-amber-500">
              ${MONTHS.map(m=>html`<option key=${m} value=${m}>${fmtMonth(m)}</option>`)}
            </select>
            <button onClick=${()=>exportCSV(report,`runtime-${selMonth}.csv`)} class="${S.btn} ${S.btnS}">â†“ CSV</button>
          </div>
        </div>
        <div class=${S.card}>
          <div class="text-xs font-bold uppercase tracking-widest text-zinc-400 mb-3">Monthly Report â€” ${fmtMonth(selMonth)}</div>
          <div class="overflow-x-auto">
            <table class="w-full min-w-[600px]">
              <thead><tr>${['Asset','Raw Reading','Monthly Î”','Accumulated','Threshold','Status'].map(h=>html`<th key=${h} class=${S.th}>${h}</th>`)}</tr></thead>
              <tbody>${report.map(r=>html`<tr key=${r.id} class="hover:bg-zinc-800/30">
                <td class=${S.td}><div class="font-semibold text-zinc-100">${r.name}</div><div class="text-[10px] text-zinc-600">${r.id} â€” ${r.location}</div></td>
                <td class="${S.td} font-mono">${typeof r.raw_reading==='number'?r.raw_reading.toLocaleString():r.raw_reading} hrs</td>
                <td class="${S.td} font-mono">${typeof r.monthly_delta==='number'?html`<span class=${r.monthly_delta>r.threshold_hrs?'text-amber-400':'text-emerald-400'}>+${r.monthly_delta}</span>`:'â€”'}</td>
                <td class="${S.td} text-amber-400 font-bold">${r.accumulated_runtime.toLocaleString()} hrs</td>
                <td class="${S.td} text-zinc-500">${r.threshold_hrs} hrs/mo</td>
                <td class=${S.td}><span class=${S.badge(r.status)}>${r.status}</span></td>
              </tr>`)}</tbody>
            </table>
          </div>
        </div>
        <div class=${S.card}>
          <div class="text-xs font-bold uppercase tracking-widest text-zinc-400 mb-2">All-Asset Accumulated Runtime Trend</div>
          <${SvgChart} data=${trendData} keys=${assets.map(a=>a.name)} colors=${colors} height=${260}/>
          <${Legend} keys=${assets.map(a=>a.name)} colors=${colors}/>
        </div>
        <div class=${S.card}>
          <div class="text-xs font-bold uppercase tracking-widest text-zinc-400 mb-3">Threshold Alerts</div>
          ${report.filter(r=>typeof r.monthly_delta==='number'&&r.monthly_delta>r.threshold_hrs).length===0
            ?html`<p class="text-zinc-600 text-sm">No assets exceeded threshold this month. âœ“</p>`
            :report.filter(r=>typeof r.monthly_delta==='number'&&r.monthly_delta>r.threshold_hrs).map(r=>html`<div key=${r.id} class="flex items-center gap-3 border border-amber-800/50 rounded p-3 bg-amber-950/20 mb-2">
              <span class="text-amber-400">âš </span>
              <div class="flex-1"><span class="text-amber-300 font-semibold text-sm">${r.name}</span><span class="text-zinc-500 text-xs ml-2">ran ${r.monthly_delta} hrs vs ${r.threshold_hrs} hr limit</span></div>
              <span class=${S.badge('WARNING')}>+${r.monthly_delta-r.threshold_hrs} over</span>
            </div>`)
          }
        </div>
      </div>`;
    }

    // â”€â”€â”€ AUDIT LOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function AuditLog({ audit }) {
      const colors={CREATE:'text-emerald-400',EDIT:'text-amber-400',DELETE:'text-red-400',LOCK:'text-sky-400',UNLOCK:'text-amber-300',CLOSE_MONTH:'text-purple-400',METER_REPLACEMENT:'text-orange-400'};
      return html`<div class="space-y-5">
        <div class="flex items-center justify-between">
          <h1 class="text-xl font-bold uppercase tracking-widest text-zinc-100">Audit Log</h1>
          <button onClick=${()=>exportCSV(audit,'audit-log.csv')} class="${S.btn} ${S.btnS}">â†“ Export CSV</button>
        </div>
        <div class=${S.card}>
          <div class="overflow-x-auto">
            <table class="w-full min-w-[600px]">
              <thead><tr>${['Timestamp','User','Action','Entity','Record','Detail'].map(h=>html`<th key=${h} class=${S.th}>${h}</th>`)}</tr></thead>
              <tbody>${audit.map(e=>html`<tr key=${e.id} class="hover:bg-zinc-800/30">
                <td class="${S.td} text-zinc-500 text-xs">${new Date(e.timestamp).toLocaleString()}</td>
                <td class="${S.td} text-zinc-300">${e.user}</td>
                <td class=${S.td}><span class=${'text-[11px] font-bold '+(colors[e.action]||'text-zinc-400')}>${e.action}</span></td>
                <td class="${S.td} text-zinc-500 text-xs">${e.entity}</td>
                <td class="${S.td} text-zinc-600 text-xs font-mono">${e.entity_id}</td>
                <td class="${S.td} text-zinc-400 text-xs">${e.detail}</td>
              </tr>`)}</tbody>
            </table>
          </div>
        </div>
      </div>`;
    }

    // â”€â”€â”€ MOUNT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    createRoot(document.getElementById('root')).render(html`<${App}/>`);
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', ()=>navigator.serviceWorker.register('sw.js').catch(()=>{}));
    }
  </script>
</body>
</html>
