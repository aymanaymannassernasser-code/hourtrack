<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HourTrack â€” Industrial Runtime</title>
  <!-- ONLY ONE EXTERNAL SCRIPT â€” Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg:#09090b;--bg2:#18181b;--bg3:#27272a;--bdr:#3f3f46;
      --t1:#e4e4e7;--t2:#a1a1aa;--t3:#71717a;
      --amber:#f59e0b;--amber2:#fbbf24;
      --green:#6ee7b7;--red:#f87171;--sky:#38bdf8;
    }
    body{font-family:'Courier New',monospace;background:var(--bg);color:var(--t1);font-size:14px;line-height:1.5;min-height:100vh}
    ::-webkit-scrollbar{width:6px;height:6px}
    ::-webkit-scrollbar-track{background:var(--bg2)}
    ::-webkit-scrollbar-thumb{background:var(--bg3);border-radius:3px}
    select option{background:var(--bg2)}
    /* HEADER */
    #header{background:var(--bg);border-bottom:1px solid var(--bg3);position:sticky;top:0;z-index:50}
    .hdr-row{display:flex;align-items:center;justify-content:space-between;padding:.6rem 1rem}
    .logo{display:flex;align-items:center;gap:.6rem}
    .logo-icon{width:2rem;height:2rem;background:var(--amber);border-radius:.25rem;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.1rem;color:var(--bg)}
    .logo-text{color:var(--amber);font-weight:600;font-size:.85rem;letter-spacing:.2em;text-transform:uppercase}
    .logo-sub{color:var(--t3);font-size:.6rem;letter-spacing:.15em;text-transform:uppercase}
    .hdr-ctrl{display:flex;align-items:center;gap:.4rem}
    .role-tag{font-size:.6rem;padding:.125rem .4rem;border-radius:.25rem;border:1px solid;font-weight:700}
    .rt-admin{border-color:#d97706;color:var(--amber)}
    .rt-engineer{border-color:#0284c7;color:var(--sky)}
    .rt-viewer{border-color:var(--bdr);color:var(--t3)}
    .email-tag{font-size:.6rem;color:var(--t3);max-width:9rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .icon-btn{background:transparent;border:1px solid var(--bdr);color:var(--t3);border-radius:.25rem;padding:.2rem .5rem;font-size:.7rem;font-family:inherit;cursor:pointer}
    .icon-btn:hover{color:var(--t1)}
    /* NAV */
    #nav{display:flex;overflow-x:auto;padding:0 .5rem}
    .nav-btn{white-space:nowrap;padding:.55rem .75rem;font-size:.65rem;font-family:inherit;letter-spacing:.1em;text-transform:uppercase;border:none;background:transparent;cursor:pointer;color:var(--t3);border-bottom:2px solid transparent;transition:color .15s,border-color .15s}
    .nav-btn:hover{color:var(--t2)}
    .nav-btn.active{color:var(--amber);border-bottom-color:var(--amber)}
    /* MAIN */
    #main{max-width:1280px;margin:0 auto;padding:1rem}
    /* CARDS */
    .card{background:var(--bg2);border:1px solid var(--bg3);border-radius:.5rem;padding:1.1rem}
    .card-amber{border-color:rgba(202,138,4,.35)}
    .card-green{border-color:rgba(16,185,129,.35)}
    /* BUTTONS */
    .btn{display:inline-flex;align-items:center;padding:.45rem .9rem;border-radius:.375rem;font-size:.8rem;font-family:inherit;font-weight:600;letter-spacing:.04em;border:none;cursor:pointer;transition:background .15s;text-decoration:none}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-p{background:var(--amber);color:var(--bg)}
    .btn-p:hover{background:var(--amber2)}
    .btn-s{background:var(--bg3);color:var(--t1);border:1px solid var(--bdr)!important}
    .btn-s:hover{background:var(--bdr)}
    .btn-d{background:rgba(127,29,29,.5);color:#fca5a5;border:1px solid #7f1d1d!important}
    .btn-d:hover{background:rgba(127,29,29,.8)}
    /* FORMS */
    .inp{width:100%;background:var(--bg);border:1px solid var(--bdr);color:var(--t1);border-radius:.375rem;padding:.5rem .7rem;font-size:.85rem;font-family:inherit;outline:none;transition:border-color .15s}
    .inp:focus{border-color:var(--amber)}
    .inp:disabled{opacity:.5}
    .inp-sm{width:7.5rem;background:var(--bg);border:1px solid var(--bdr);color:var(--t1);border-radius:.375rem;padding:.45rem .6rem;font-size:.8rem;font-family:inherit;outline:none}
    .inp-sm:focus{border-color:var(--amber)}
    .inp-ok{border-color:#10b981!important}
    .inp-warn{border-color:#d97706!important}
    .inp-crit{border-color:#dc2626!important}
    label.lbl{display:block;font-size:.6rem;text-transform:uppercase;letter-spacing:.15em;color:var(--t3);margin-bottom:.2rem}
    .fg{margin-bottom:.7rem}
    .sel{background:var(--bg2);border:1px solid var(--bdr);color:var(--t1);border-radius:.375rem;padding:.45rem .7rem;font-size:.8rem;font-family:inherit;outline:none;cursor:pointer}
    .sel:focus{border-color:var(--amber)}
    /* TABLES */
    .tbl-wrap{overflow-x:auto}
    table{width:100%;border-collapse:collapse}
    th{padding:.45rem .75rem;text-align:left;font-size:.6rem;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.15em}
    td{padding:.5rem .75rem;font-size:.78rem;color:var(--t2);border-top:1px solid rgba(39,39,42,.6);font-family:inherit}
    .tr-click{cursor:pointer}
    .tr-click:hover td{background:rgba(39,39,42,.5)}
    tr:hover td{background:rgba(39,39,42,.3)}
    /* BADGES */
    .badge{display:inline-block;padding:.1rem .45rem;border-radius:.25rem;font-size:.6rem;font-weight:700;font-family:inherit;border:1px solid}
    .b-ok{background:rgba(6,78,59,.4);color:#6ee7b7;border-color:#059669}
    .b-warn{background:rgba(120,53,15,.4);color:#fcd34d;border-color:#d97706}
    .b-crit{background:rgba(127,29,29,.4);color:#fca5a5;border-color:#dc2626}
    .b-reset{background:rgba(7,89,133,.4);color:#7dd3fc;border-color:#0284c7}
    /* TOAST */
    #toast{position:fixed;top:1rem;right:1rem;z-index:200;padding:.7rem 1.2rem;border-radius:.5rem;font-size:.8rem;border:1px solid;box-shadow:0 10px 30px rgba(0,0,0,.5);display:none}
    .t-info{background:var(--bg2);border-color:var(--bdr);color:var(--t1)}
    .t-ok{background:#052e16;border-color:#166534;color:#86efac}
    .t-err{background:#450a0a;border-color:#991b1b;color:#fca5a5}
    /* MISC */
    .space>*+*{margin-top:1rem}
    .row{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:.6rem;margin-bottom:.9rem}
    .flex{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .grid4{display:grid;grid-template-columns:repeat(2,1fr);gap:.7rem}
    .grid-2col{display:grid;grid-template-columns:1fr;gap:1rem}
    @media(min-width:900px){.grid4{grid-template-columns:repeat(4,1fr)}.grid-2col{grid-template-columns:1fr 1fr}}
    .ptitle{font-size:1.1rem;font-weight:700;text-transform:uppercase;letter-spacing:.12em;color:var(--t1)}
    .stitle{font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.2em;color:var(--t3);margin-bottom:.75rem}
    .mono{font-family:'Courier New',monospace}
    .amber{color:var(--amber)}
    .sky{color:var(--sky)}
    .green{color:var(--green)}
    .red{color:var(--red)}
    .dim{color:var(--t3)}
    .bold{font-weight:700}
    .sm{font-size:.7rem}
    .xs{font-size:.6rem}
    .progbar{height:3px;background:var(--bg3);border-radius:2px;overflow:hidden;margin-top:3px;width:5rem}
    .progfill{height:100%;border-radius:2px}
    .bar-g{background:#10b981}.bar-a{background:var(--amber)}.bar-r{background:#ef4444}
    .formula{background:rgba(9,9,11,.7);border:1px solid var(--bg3);border-radius:.375rem;padding:.7rem;font-family:'Courier New',monospace;font-size:.82rem;display:flex;flex-wrap:wrap;gap:.35rem;align-items:center}
    .info-box{border:1px solid rgba(202,138,4,.4);background:rgba(120,53,15,.1);border-radius:.375rem;padding:.7rem;font-size:.75rem;color:#fbbf24}
    .step-row{display:flex;align-items:center;gap:.4rem;margin-bottom:.9rem}
    .step-c{width:1.4rem;height:1.4rem;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.6rem;font-weight:700;border:1px solid var(--bdr);background:var(--bg2);color:var(--t3)}
    .step-c.done{background:var(--amber);border-color:var(--amber);color:var(--bg)}
    .step-l{width:1.2rem;height:1px;background:var(--bdr)}
    .step-l.done{background:var(--amber)}
    .step-txt{font-size:.65rem;text-transform:uppercase;letter-spacing:.08em;color:var(--t3)}
    .step-txt.done{color:var(--t2)}
    .alert-row{display:flex;align-items:center;gap:.75rem;border:1px solid rgba(202,138,4,.5);border-radius:.375rem;padding:.75rem;background:rgba(120,53,15,.2);margin-bottom:.4rem}
    /* LOGIN */
    .full-center{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1.5rem}
    .login-box{width:100%;max-width:22rem}
    .tab-bar{display:flex;gap:.2rem;background:var(--bg);border-radius:.375rem;padding:.2rem;margin-bottom:1rem}
    .tab{flex:1;padding:.35rem;text-align:center;font-size:.65rem;font-family:inherit;text-transform:uppercase;letter-spacing:.1em;border-radius:.25rem;border:none;cursor:pointer;background:transparent;color:var(--t3);transition:all .15s}
    .tab.active{background:var(--amber);color:var(--bg)}
    /* CHART */
    .chart-svg{width:100%;overflow:hidden}
    /* SEARCH */
    .search-inp{background:var(--bg);border:1px solid var(--bdr);color:var(--t1);border-radius:.375rem;padding:.4rem .7rem;font-size:.8rem;font-family:inherit;outline:none;width:14rem}
    .search-inp:focus{border-color:var(--amber)}
    /* SPIN */
    .spin{display:inline-block;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* AI PANEL */
    .ai-wrap{display:flex;flex-direction:column;height:calc(100vh - 8rem);max-height:800px}
    .ai-messages{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:.6rem;padding:.5rem 0;min-height:0}
    .ai-msg{display:flex;flex-direction:column;gap:.25rem;animation:fadeUp .2s ease}
    @keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    .ai-msg-user{align-items:flex-end}
    .ai-msg-ai{align-items:flex-start}
    .ai-bubble{max-width:82%;padding:.6rem .85rem;border-radius:.5rem;font-size:.8rem;line-height:1.6;white-space:pre-wrap;word-break:break-word}
    .ai-bubble-user{background:var(--amber);color:#1a0a00;font-weight:600;border-radius:.5rem .5rem .1rem .5rem}
    .ai-bubble-ai{background:var(--bg2);border:1px solid var(--bg3);color:var(--t1);border-radius:.5rem .5rem .5rem .1rem}
    .ai-cmd-block{margin-top:.4rem;max-width:82%;border:1px solid rgba(202,138,4,.35);background:rgba(120,53,15,.12);border-radius:.375rem;padding:.5rem .8rem;font-size:.72rem;font-family:'Courier New',monospace}
    .ai-cmd-row{display:flex;align-items:center;gap:.4rem;margin-bottom:.2rem}
    .ai-cmd-action{color:var(--amber);font-weight:700;text-transform:uppercase;font-size:.65rem;letter-spacing:.1em}
    .ai-cmd-detail{color:var(--t3);font-size:.68rem}
    .ai-cmd-ok{color:#6ee7b7}
    .ai-cmd-err{color:#f87171}
    .ai-input-row{display:flex;gap:.5rem;padding-top:.6rem;border-top:1px solid var(--bg3);flex-shrink:0}
    .ai-inp{flex:1;background:var(--bg);border:1px solid var(--bdr);color:var(--t1);border-radius:.375rem;padding:.55rem .8rem;font-size:.82rem;font-family:'Courier New',monospace;outline:none;resize:none;height:2.6rem;transition:border-color .15s}
    .ai-inp:focus{border-color:var(--amber)}
    .ai-send{background:var(--amber);color:var(--bg);border:none;border-radius:.375rem;padding:.5rem 1rem;font-size:.8rem;font-family:inherit;font-weight:700;cursor:pointer;transition:background .15s;flex-shrink:0}
    .ai-send:hover{background:var(--amber2)}
    .ai-send:disabled{opacity:.5;cursor:not-allowed}
    .ai-chip{display:inline-flex;align-items:center;gap:.3rem;background:rgba(202,138,4,.15);border:1px solid rgba(202,138,4,.3);border-radius:.25rem;padding:.1rem .4rem;font-size:.6rem;font-family:'Courier New',monospace;color:var(--amber);margin:.1rem}
    .ai-hint-btn{display:inline-block;background:var(--bg3);border:1px solid var(--bdr);border-radius:.25rem;padding:.25rem .55rem;font-size:.68rem;font-family:inherit;color:var(--t2);cursor:pointer;margin:.15rem;transition:background .15s}
    .ai-hint-btn:hover{background:var(--bdr);color:var(--t1)}
    /* EDIT ASSET FORM */
    .edit-form{background:var(--bg2);border:1px solid rgba(202,138,4,.35);border-radius:.5rem;padding:1rem;margin-bottom:1rem}
    .edit-grid{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
    @media(max-width:600px){.edit-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div id="toast"></div>
<div id="root"><div style="color:#f59e0b;padding:2rem;font-family:monospace">â— Loading HourTrackâ€¦</div></div>

<script>
// â”€â”€ CATCH ALL ERRORS AND SHOW ON SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onerror = function(msg,src,line){
  document.getElementById('root').innerHTML =
    '<div style="padding:2rem;font-family:monospace;color:#f87171;max-width:600px">'+
    '<h3 style="margin-bottom:.5rem">âš  JavaScript Error</h3>'+
    '<p style="color:#e4e4e7">'+esc(msg)+'</p>'+
    '<p style="color:#71717a;font-size:.75rem;margin-top:.5rem">Line: '+line+'</p>'+
    '<p style="color:#71717a;font-size:.75rem;margin-top:.5rem">Open browser console (F12) for full details.</p></div>';
};

// â•â• CONFIG â€” REPLACE THESE TWO VALUES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var SUPABASE_URL = 'YOUR_SUPABASE_URL_HERE';
var SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY_HERE';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var CONFIGURED = SUPABASE_URL.indexOf('YOUR_') === -1;
var DB = CONFIGURED ? supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : null;

// â”€â”€ MONTHS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var now = new Date();
var MONTHS = (function(){
  var arr=[];
  for(var i=0;i<12;i++){
    var d=new Date(now.getFullYear(),now.getMonth()-11+i,1);
    arr.push(d.getFullYear()+'-'+pad2(d.getMonth()+1)+'-01');
  }
  return arr;
})();
var CUR_MONTH = MONTHS[MONTHS.length-1];
var PREV_MONTH = MONTHS[MONTHS.length-2];

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var S = {
  view: 'loading',       // loading|setup|login|app
  appTab: 'dashboard',   // dashboard|assets|entry|replacements|reports|audit|users
  session: null,
  userRole: 'viewer',
  assets: [], readings: [], repls: [], audit: [], closed: [],
  detailId: null,
  assetSearch: '',
  entryMonth: CUR_MONTH,
  entryPending: {},      // assetId -> value string (for monthly entry)
  entryResults: {},      // assetId -> {status,message}
  replStep: 0,
  replAssetId: '', replLastReading: '', replNotes: '',
  replConf: null,
  loginMode: 'login',
  loginEmail: '', loginPw: '', loginErr: '', loginMsg: '', loginBusy: false,
  addAssetOpen: false,
  addAssetBusy: false,
  aiMessages: [],
  aiInput: '',
  aiLoading: false,
  editingAssetId: null,
  editFields: {}
};

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pad2(n){ return n<10?'0'+n:String(n); }
function fmtMonth(m){ return new Date(m+'T12:00:00Z').toLocaleDateString('en-US',{month:'short',year:'numeric'}); }
function calcAcc(a,raw){ return a.reset_count*a.meter_max_value+a.stuck_reading+(raw||0); }
function uid(){ return Date.now()+'-'+Math.random().toString(36).slice(2,6); }
function esc(s){
  if(s===null||s===undefined) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function badge(v){
  var m={OK:'b-ok',WARNING:'b-warn',CRITICAL:'b-crit',RESET:'b-reset'};
  return '<span class="badge '+(m[v]||'b-ok')+'">'+esc(v)+'</span>';
}
function roleBadge(r){
  var c=r==='admin'?'rt-admin':r==='engineer'?'rt-engineer':'rt-viewer';
  return '<span class="role-tag '+c+'">'+esc(r.toUpperCase())+'</span>';
}
function fmtNum(n){ return typeof n==='number'?n.toLocaleString():String(n||'â€”'); }
function validateReading(asset, readings, val, month){
  if(val<0) return {status:'CRITICAL',message:'Negative reading not allowed.'};
  var prev=null, best='';
  for(var i=0;i<readings.length;i++){
    var r=readings[i];
    if(r.asset_id===asset.id && r.month<month && r.month>best){
      best=r.month; prev=r;
    }
  }
  if(!prev) return {status:'OK',message:'First reading for this asset.'};
  var diff=val-prev.raw_meter_reading;
  if(diff<0) return {status:'CRITICAL',message:'Decreased by '+Math.abs(diff)+' hrs â€” record a reset?'};
  if(diff>asset.threshold_hours*1.5) return {status:'CRITICAL',message:'+'+diff+' hrs exceeds critical limit.'};
  if(diff>asset.threshold_hours) return {status:'WARNING',message:'+'+diff+' hrs exceeds '+asset.threshold_hours+' hr threshold.'};
  return {status:'OK',message:'+'+diff+' hrs this month.'};
}
function exportCSV(data, filename){
  if(!data.length) return;
  var keys=Object.keys(data[0]);
  var rows=[keys.join(',')].concat(data.map(function(r){
    return keys.map(function(k){ return '"'+(r[k]===null||r[k]===undefined?'':r[k])+'"'; }).join(',');
  }));
  var a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(rows.join('\n'));
  a.download=filename; a.click();
}
function svgChart(data, keys, colors, h){
  h=h||160;
  var all=[];
  data.forEach(function(d){ keys.forEach(function(k){ if(d[k]!=null&&!isNaN(d[k])) all.push(d[k]); }); });
  if(!all.length) return '<p class="dim sm" style="padding:.5rem 0">No data yet â€” add readings to see trend.</p>';
  var minY=Math.min.apply(null,all),maxY=Math.max.apply(null,all),range=maxY-minY||1;
  var W=800,H=h,pl=62,pr=10,pt=8,pb=26,iW=W-pl-pr,iH=H-pt-pb;
  function tx(i){ return pl+i*(iW/Math.max(data.length-1,1)); }
  function ty(v){ return pt+iH-((v-minY)/range)*iH; }
  var yLines='',step=Math.ceil(data.length/6);
  [0,.25,.5,.75,1].forEach(function(f){
    var v=Math.round(minY+range*f),y=ty(v);
    yLines+='<line x1="'+pl+'" y1="'+y+'" x2="'+(W-pr)+'" y2="'+y+'" stroke="#27272a" stroke-dasharray="3,3"/>';
    yLines+='<text x="'+(pl-4)+'" y="'+(y+4)+'" text-anchor="end" fill="#71717a" font-size="10" font-family="monospace">'+(v>9999?(v/1000).toFixed(0)+'k':v)+'</text>';
  });
  var labels='';
  data.forEach(function(d,i){
    if(i%step===0||i===data.length-1)
      labels+='<text x="'+tx(i)+'" y="'+(H-4)+'" text-anchor="middle" fill="#71717a" font-size="9" font-family="monospace">'+esc(d.label)+'</text>';
  });
  var lines='';
  keys.forEach(function(k,ki){
    var pts=data.map(function(d,i){ return (d[k]!=null&&!isNaN(d[k]))?tx(i)+','+ty(d[k]):null; }).filter(Boolean);
    if(pts.length>=2) lines+='<path d="M'+pts.join('L')+'" fill="none" stroke="'+(colors[ki]||'#f59e0b')+'" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>';
  });
  var legend='<div class="flex" style="margin-top:.4rem">';
  keys.forEach(function(k,ki){
    legend+='<div class="flex xs dim" style="gap:.3rem"><div style="width:14px;height:2px;background:'+(colors[ki]||'#f59e0b')+';border-radius:1px;margin-top:5px"></div>'+esc(k)+'</div>';
  });
  legend+='</div>';
  return '<svg class="chart-svg" viewBox="0 0 '+W+' '+H+'" style="height:'+h+'px">'+yLines+labels+lines+'</svg>'+legend;
}

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var _toastTimer=null;
function toast(msg,type){
  var el=document.getElementById('toast');
  if(!el) return;
  el.textContent=msg;
  el.className='t-'+(type||'info');
  el.style.display='block';
  clearTimeout(_toastTimer);
  _toastTimer=setTimeout(function(){ el.style.display='none'; },4000);
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render(){
  var root=document.getElementById('root');
  if(!root) return;
  if(!CONFIGURED){ root.innerHTML=renderSetup(); return; }
  if(S.view==='loading'){ root.innerHTML='<div style="color:#f59e0b;padding:2rem;font-family:monospace">â— Connectingâ€¦</div>'; return; }
  if(S.view==='login'){ root.innerHTML=renderLogin(); return; }
  root.innerHTML=renderApp();
}

// â”€â”€ SETUP SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSetup(){
  return '<div class="full-center">'+
    '<div style="max-width:34rem;width:100%" class="card card-amber">'+
    '<div class="flex" style="margin-bottom:1rem">'+
    '<div class="logo-icon">H</div>'+
    '<div><div class="logo-text">HourTrack</div><div class="dim xs">Setup Required</div></div></div>'+
    '<div class="amber bold sm" style="margin-bottom:.5rem">âš™ One-Time Configuration</div>'+
    '<p class="sm" style="color:#a1a1aa;margin-bottom:.7rem">Open <b style="color:#fbbf24">index.html</b> in Notepad and replace the two values near the top:</p>'+
    '<div style="background:var(--bg);border:1px solid var(--bdr);border-radius:.375rem;padding:.9rem;font-size:.72rem;font-family:monospace;margin-bottom:.7rem;line-height:1.8">'+
    '<span style="color:#71717a">// Replace these two lines:</span><br>'+
    '<span style="color:#fbbf24">var SUPABASE_URL = \'YOUR_SUPABASE_URL_HERE\';</span><br>'+
    '<span style="color:#fbbf24">var SUPABASE_KEY = \'YOUR_SUPABASE_ANON_KEY_HERE\';</span>'+
    '</div>'+
    '<p class="xs dim">Find both values in Supabase â†’ Settings â†’ API</p>'+
    '<p class="xs dim" style="margin-top:.3rem">See README.md for the full step-by-step guide.</p>'+
    '</div></div>';
}

// â”€â”€ LOGIN SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLogin(){
  var isLogin=S.loginMode==='login';
  return '<div class="full-center">'+
    '<div class="login-box">'+
    '<div class="flex" style="justify-content:center;margin-bottom:1.5rem">'+
    '<div class="logo-icon">H</div>'+
    '<div><div class="logo-text">HourTrack</div><div class="xs dim">Industrial Runtime Management</div></div></div>'+
    '<div class="card">'+
    '<div class="tab-bar">'+
    '<button class="tab'+(isLogin?' active':'')+'" onclick="setLoginMode(\'login\')">Sign In</button>'+
    '<button class="tab'+(!isLogin?' active':'')+'" onclick="setLoginMode(\'signup\')">Sign Up</button>'+
    '</div>'+
    (S.loginMsg?'<div style="color:#86efac;font-size:.75rem;padding:.6rem;background:#052e16;border:1px solid #166534;border-radius:.375rem;margin-bottom:.7rem">'+esc(S.loginMsg)+'</div>':'')+
    (S.loginErr?'<div style="color:#fca5a5;font-size:.75rem;padding:.6rem;background:#450a0a;border:1px solid #991b1b;border-radius:.375rem;margin-bottom:.7rem">'+esc(S.loginErr)+'</div>':'')+
    '<div class="fg"><label class="lbl">Email</label>'+
    '<input id="l-email" class="inp" type="email" value="'+esc(S.loginEmail)+'" oninput="S.loginEmail=this.value" placeholder="you@company.com" onkeydown="if(event.key===\'Enter\')doLogin()"></div>'+
    '<div class="fg"><label class="lbl">Password</label>'+
    '<input id="l-pw" class="inp" type="password" value="'+esc(S.loginPw)+'" oninput="S.loginPw=this.value" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key===\'Enter\')doLogin()"></div>'+
    '<button class="btn btn-p" style="width:100%;justify-content:center" onclick="doLogin()" '+(S.loginBusy?'disabled':'')+'>'+
    (S.loginBusy?'<span class="spin">â—</span> &nbsp;Please waitâ€¦':isLogin?'Sign In â†’':'Create Account â†’')+'</button>'+
    '</div></div>';
}

// â”€â”€ FULL APP SHELL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderApp(){
  var tabs=['dashboard','assets','entry','replacements','reports','audit'];
  if(S.userRole==='admin') tabs.push('users');
  if(S.userRole==='admin') tabs.push('ai');
  var _navL={dashboard:'Dashboard',assets:'Assets',entry:'Monthly Entry',replacements:'Replacements',reports:'Reports',audit:'Audit Log',users:'Users',ai:'âš¡ AI Admin'};
  var navHTML=tabs.map(function(t){
    var sty=t==='ai'?' style="color:var(--amber)"':'';
    return '<button class="nav-btn'+(S.appTab===t?' active':'')+'"'+sty+' onclick="goTab(\''+t+'\')">'+(_navL[t]||t)+'</button>';
  }).join('');
  var rc=S.userRole==='admin'?'rt-admin':S.userRole==='engineer'?'rt-engineer':'rt-viewer';
  return '<div id="header">'+
    '<div class="hdr-row">'+
    '<div class="logo"><div class="logo-icon">H</div>'+
    '<div><div class="logo-text">HourTrack</div><div class="logo-sub">Industrial Runtime</div></div></div>'+
    '<div class="hdr-ctrl">'+
    '<span class="role-tag '+rc+'">'+esc(S.userRole.toUpperCase())+'</span>'+
    '<span class="email-tag">'+esc(S.session.user.email)+'</span>'+
    '<button class="icon-btn" onclick="loadData()">â†» Sync</button>'+
    '<button class="icon-btn" style="color:#f87171" onclick="doLogout()">Sign Out</button>'+
    '</div></div>'+
    '<div id="nav">'+navHTML+'</div>'+
    '</div>'+
    '<div id="main" class="space">'+renderTab()+'</div>';
}

function renderTab(){
  var t=S.appTab;
  if(t==='dashboard') return renderDashboard();
  if(t==='assets') return S.detailId ? renderAssetDetail() : renderAssets();
  if(t==='entry') return renderEntry();
  if(t==='replacements') return renderReplacements();
  if(t==='reports') return renderReports();
  if(t==='audit') return renderAudit();
  if(t==='users') return renderUsers();
  if(t==='ai') return renderAI();
  return '';
}

// â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDashboard(){
  var activeAssets=S.assets.filter(function(a){ return a.active_status; });
  var warnings=0,criticals=0;
  S.readings.forEach(function(r){ if(r.month===CUR_MONTH){ if(r.validation==='WARNING')warnings++; if(r.validation==='CRITICAL')criticals++; } });

  var statCards=[
    {label:'Active Assets',val:activeAssets.length,color:'amber'},
    {label:'Warnings',val:warnings,color:'amber'},
    {label:'Critical',val:criticals,color:'red'},
    {label:'Current Period',val:fmtMonth(CUR_MONTH),color:'green',sm:1},
  ];

  var statsHTML='<div class="grid4">'+statCards.map(function(c){
    return '<div class="card"><div class="xs dim" style="text-transform:uppercase;letter-spacing:.15em;margin-bottom:.4rem">'+c.label+'</div>'+
      '<div class="'+(c.sm?'sm':'bold')+'" style="font-size:'+(c.sm?'1rem':'1.6rem')+';color:var(--'+c.color+')">'+(typeof c.val==='string'?c.val:c.val)+'</div></div>';
  }).join('')+'</div>';

  var tableRows='';
  if(activeAssets.length===0){
    tableRows='<tr><td colspan="8" style="color:#71717a;text-align:center;padding:1.5rem">No assets â€” run seed_data.sql in Supabase then click â†» Sync</td></tr>';
  } else {
    activeAssets.forEach(function(a){
      var srt=S.readings.filter(function(r){ return r.asset_id===a.id; }).sort(function(x,y){ return y.month.localeCompare(x.month); });
      var lat=srt[0],prv=srt[1];
      var acc=calcAcc(a,lat?lat.raw_meter_reading:0);
      var delta=(lat&&prv)?(lat.raw_meter_reading-prv.raw_meter_reading):null;
      var v=lat?lat.validation:'OK';
      var pct=Math.min(100,(acc/(a.meter_max_value*5))*100);
      var barC=pct>85?'bar-r':pct>60?'bar-a':'bar-g';
      var dc=delta!==null&&delta>a.threshold_hours?'amber':'green';
      tableRows+='<tr class="tr-click" onclick="openAssetDetail(\''+esc(a.id)+'\')">'+
        '<td><div class="bold xs" style="color:#e4e4e7">'+esc(a.name)+'</div><div class="xs dim">'+esc(a.id)+'</div></td>'+
        '<td class="xs dim">'+esc(a.location)+'</td>'+
        '<td>'+(lat?lat.raw_meter_reading.toLocaleString():'â€”')+' hrs</td>'+
        '<td><div class="amber bold">'+acc.toLocaleString()+' hrs</div>'+
        '<div class="progbar"><div class="progfill '+barC+'" style="width:'+pct+'%"></div></div></td>'+
        '<td>'+(delta!==null?'<span class="'+dc+'">+'+delta+' hrs</span>':'â€”')+'</td>'+
        '<td>'+a.reset_count+'Ã—</td>'+
        '<td>'+badge(v)+'</td>'+
        '<td class="dim xs">â†’</td>'+
        '</tr>';
    });
  }

  var replHTML='';
  if(S.repls.length===0){
    replHTML='<p class="dim sm">No replacements logged yet.</p>';
  } else {
    S.repls.slice().reverse().slice(0,4).forEach(function(r){
      var a=S.assets.find(function(x){ return x.id===r.asset_id; });
      replHTML+='<div style="border-left:2px solid var(--amber);padding:.4rem .7rem;margin-bottom:.6rem">'+
        '<div class="sm bold" style="color:var(--t1)">'+esc(a?a.name:r.asset_id)+'</div>'+
        '<div class="xs dim">'+fmtMonth(r.replacement_date)+' â€” Reset #'+r.new_reset_count+' â€” Stuck: '+(r.last_stuck_reading||0).toLocaleString()+' hrs</div>'+
        (r.notes?'<div class="xs" style="color:#52525b;margin-top:.15rem;font-style:italic">'+esc(r.notes)+'</div>':'')+
        '</div>';
    });
  }

  var chartData=MONTHS.map(function(m){
    var e={label:fmtMonth(m)};
    S.assets.slice(0,2).forEach(function(a){
      var r=S.readings.find(function(rd){ return rd.asset_id===a.id&&rd.month===m; });
      e[a.name]=r?calcAcc(a,r.raw_meter_reading):null;
    });
    return e;
  });
  var chartKeys=S.assets.slice(0,2).map(function(a){ return a.name; });

  return statsHTML+
    (activeAssets.length===0?'<div class="card card-amber"><div class="amber bold sm" style="margin-bottom:.4rem">ğŸ‘‹ Welcome to HourTrack!</div><p class="sm" style="color:#a1a1aa">Your 153 motors will appear here after running setup.sql and seed_data.sql in Supabase, then clicking â†» Sync.</p></div>':
    '<div class="card">'+
    '<div class="stitle">Asset Runtime Status â€” '+fmtMonth(CUR_MONTH)+'</div>'+
    '<div class="tbl-wrap"><table><thead><tr>'+
    '<th>Asset</th><th>Location</th><th>Latest Rdg</th><th>Accumulated</th><th>Monthly Î”</th><th>Resets</th><th>Status</th><th></th>'+
    '</tr></thead><tbody>'+tableRows+'</tbody></table></div></div>')+
    '<div class="grid-2col">'+
    '<div class="card"><div class="stitle">Recent Replacements</div>'+replHTML+'</div>'+
    '<div class="card"><div class="stitle">Accumulated Trend</div>'+svgChart(chartData,chartKeys,['#f59e0b','#6ee7b7'],160)+'</div>'+
    '</div>'+
    '<div class="flex" style="margin-top:-.2rem">'+
    '<button class="btn btn-p" onclick="goTab(\'entry\')">+ Add Reading</button>'+
    '<button class="btn btn-s" onclick="goTab(\'replacements\')">â†º Replace Meter</button>'+
    '<button class="btn btn-s" onclick="closeMonth()">âŠ  Close Month</button>'+
    '<button class="btn btn-s" onclick="goTab(\'reports\')">â†“ Reports</button>'+
    '</div>';
}

// â”€â”€ ASSETS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAssets(){
  var q=S.assetSearch.toLowerCase();
  var filtered=S.assets.filter(function(a){
    return !q||a.name.toLowerCase().indexOf(q)>=0||a.id.toLowerCase().indexOf(q)>=0||a.location.toLowerCase().indexOf(q)>=0;
  });
  var canEdit=S.userRole==='admin'||S.userRole==='engineer';
  var addForm='';
  if(S.addAssetOpen){
    addForm='<div class="card card-amber">'+
      '<div class="xs amber bold" style="text-transform:uppercase;letter-spacing:.15em;margin-bottom:.8rem">Register New Asset</div>'+
      '<div class="grid2">'+
      '<div class="fg"><label class="lbl">Tag Name *</label><input id="na-name" class="inp" placeholder="Motor tag no." value=""></div>'+
      '<div class="fg"><label class="lbl">Location / Drawer</label><input id="na-loc" class="inp" placeholder="Panel 185CC12A +03.17" value=""></div>'+
      '<div class="fg"><label class="lbl">Meter Max Value</label><input id="na-max" class="inp" type="number" value="9999"></div>'+
      '<div class="fg"><label class="lbl">Monthly Threshold (hrs)</label><input id="na-thr" class="inp" type="number" value="200"></div>'+
      '</div>'+
      '<div class="flex"><button class="btn btn-p" onclick="submitAddAsset()" '+(S.addAssetBusy?'disabled':'')+'>'+
      (S.addAssetBusy?'Savingâ€¦':'Register Asset')+'</button>'+
      '<button class="btn btn-s" onclick="S.addAssetOpen=false;render()">Cancel</button></div>'+
      '</div>';
  }
  var rows=filtered.length===0?
    '<tr><td colspan="7" style="color:#71717a;text-align:center;padding:1rem">No assets found.</td></tr>':
    filtered.map(function(a){
      return '<tr class="tr-click" onclick="openAssetDetail(\''+esc(a.id)+'\')">'+
        '<td class="amber xs">'+esc(a.id)+'</td>'+
        '<td><span class="bold xs" style="color:#e4e4e7">'+esc(a.name)+'</span></td>'+
        '<td class="xs dim">'+esc(a.location)+'</td>'+
        '<td>'+a.meter_max_value.toLocaleString()+'</td>'+
        '<td>'+a.reset_count+'</td>'+
        '<td>'+a.threshold_hours+' hrs/mo</td>'+
        '<td class="dim xs">â†’</td></tr>';
    }).join('');
  return '<div class="row">'+
    '<div class="ptitle">Asset Registry <span class="sm dim">('+filtered.length+'/'+S.assets.length+')</span></div>'+
    '<div class="flex">'+
    '<input class="search-inp" placeholder="Search tag, name, locationâ€¦" value="'+esc(S.assetSearch)+'" oninput="S.assetSearch=this.value;renderAssetList()">'+
    (canEdit?'<button class="btn btn-p" onclick="S.addAssetOpen=!S.addAssetOpen;render()">+ New Asset</button>':'')+
    '</div></div>'+
    addForm+
    '<div class="card">'+
    '<div class="tbl-wrap"><table><thead><tr>'+
    '<th>ID</th><th>Name</th><th>Location / Drawer</th><th>Meter Max</th><th>Resets</th><th>Threshold</th><th></th>'+
    '</tr></thead><tbody id="asset-tbody">'+rows+'</tbody></table></div></div>';
}
function renderAssetList(){
  var tbody=document.getElementById('asset-tbody');
  if(!tbody) return;
  var q=S.assetSearch.toLowerCase();
  var filtered=S.assets.filter(function(a){ return !q||a.name.toLowerCase().indexOf(q)>=0||a.id.toLowerCase().indexOf(q)>=0||a.location.toLowerCase().indexOf(q)>=0; });
  tbody.innerHTML=filtered.length===0?
    '<tr><td colspan="7" style="color:#71717a;text-align:center;padding:1rem">No assets found.</td></tr>':
    filtered.map(function(a){
      return '<tr class="tr-click" onclick="openAssetDetail(\''+esc(a.id)+'\')">'+
        '<td class="amber xs">'+esc(a.id)+'</td>'+
        '<td><span class="bold xs" style="color:#e4e4e7">'+esc(a.name)+'</span></td>'+
        '<td class="xs dim">'+esc(a.location)+'</td>'+
        '<td>'+a.meter_max_value.toLocaleString()+'</td>'+
        '<td>'+a.reset_count+'</td>'+
        '<td>'+a.threshold_hours+' hrs/mo</td>'+
        '<td class="dim xs">â†’</td></tr>';
    }).join('');
  // Update count
  var titleEl=document.querySelector('.ptitle');
  if(titleEl) titleEl.innerHTML='Asset Registry <span class="sm dim">('+filtered.length+'/'+S.assets.length+')</span>';
}

function renderAssetDetail(){
  var a=S.assets.find(function(x){ return x.id===S.detailId; });
  if(!a) return '<div class="card"><p class="dim">Asset not found.</p></div>';
  var ar=S.readings.filter(function(r){ return r.asset_id===a.id; }).sort(function(x,y){ return x.month.localeCompare(y.month); });
  var lat=ar[ar.length-1];
  var acc=calcAcc(a,lat?lat.raw_meter_reading:0);
  var assetRepls=S.repls.filter(function(r){ return r.asset_id===a.id; });

  var statCards=[
    {l:'Accumulated Runtime',v:acc.toLocaleString()+' hrs',c:'amber'},
    {l:'Reset Count',v:a.reset_count,c:'sky'},
    {l:'Stuck Reading',v:a.stuck_reading.toLocaleString()+' hrs',c:'t2'},
    {l:'Latest Raw',v:lat?lat.raw_meter_reading.toLocaleString()+' hrs':'â€”',c:'t2'},
  ];

  var chartData=ar.map(function(r,i){
    return {label:fmtMonth(r.month),'Accumulated':calcAcc(a,r.raw_meter_reading),'Monthly Î”':i>0?r.raw_meter_reading-ar[i-1].raw_meter_reading:0};
  });

  var rows=ar.map(function(r,i){
    var prev=ar[i-1];
    var delta=prev?r.raw_meter_reading-prev.raw_meter_reading:null;
    var dc=delta===null?'dim':delta<0?'red':delta>a.threshold_hours?'amber':'green';
    return '<tr>'+
      '<td>'+fmtMonth(r.month)+'</td>'+
      '<td>'+r.raw_meter_reading.toLocaleString()+' hrs</td>'+
      '<td>'+(delta!==null?'<span class="'+dc+'">+'+delta+'</span>':'â€”')+'</td>'+
      '<td class="amber">'+calcAcc(a,r.raw_meter_reading).toLocaleString()+'</td>'+
      '<td>'+badge(r.validation)+'</td>'+
      '<td>'+(r.locked?'<span class="dim xs">ğŸ”’ Locked</span>':'<span class="green xs">Open</span>')+'</td>'+
      '<td class="dim xs">'+esc(r.created_by)+'</td>'+
      '</tr>';
  }).join('');

  // Inline edit form
  var editFormHTML='';
  if(S.editingAssetId===a.id){
    var ef=S.editFields;
    editFormHTML='<div class="edit-form">'+
      '<div class="xs amber bold" style="text-transform:uppercase;letter-spacing:.15em;margin-bottom:.75rem">âœ Edit Asset â€” '+esc(a.id)+'</div>'+
      '<div class="edit-grid">'+
      '<div class="fg"><label class="lbl">Tag Name</label><input id="ef-name" class="inp" value="'+esc(ef.name||a.name)+'"></div>'+
      '<div class="fg"><label class="lbl">Location / Drawer</label><input id="ef-loc" class="inp" value="'+esc(ef.location||a.location||'')+'"></div>'+
      '<div class="fg"><label class="lbl">Meter Max Value</label><input id="ef-max" class="inp" type="number" value="'+(ef.meter_max_value!==undefined?ef.meter_max_value:a.meter_max_value)+'"></div>'+
      '<div class="fg"><label class="lbl">Monthly Threshold (hrs)</label><input id="ef-thr" class="inp" type="number" value="'+(ef.threshold_hours!==undefined?ef.threshold_hours:a.threshold_hours)+'"></div>'+
      '<div class="fg"><label class="lbl">Stuck Reading (accumulated override)</label><input id="ef-stuck" class="inp" type="number" value="'+(ef.stuck_reading!==undefined?ef.stuck_reading:a.stuck_reading)+'"></div>'+
      '<div class="fg"><label class="lbl">Reset Count</label><input id="ef-reset" class="inp" type="number" value="'+(ef.reset_count!==undefined?ef.reset_count:a.reset_count)+'"></div>'+
      '</div>'+
      '<div class="fg"><label class="lbl">Active Status</label>'+
      '<select id="ef-active" class="sel">'+
      '<option value="true"'+(a.active_status?' selected':'')+'>Active</option>'+
      '<option value="false"'+(!a.active_status?' selected':'')+'>Inactive / Retired</option>'+
      '</select></div>'+
      '<div class="flex" style="margin-top:.5rem">'+
      '<button class="btn btn-p" onclick="saveAssetEdits(\''+esc(a.id)+'\')" >Save Changes</button>'+
      '<button class="btn btn-s" onclick="S.editingAssetId=null;S.editFields={};render()">Cancel</button>'+
      '</div></div>';
  }

  return '<div class="flex" style="margin-bottom:.8rem">'+
    '<button class="btn btn-s xs" onclick="S.detailId=null;S.editingAssetId=null;S.editFields={};render()">â† Back</button>'+
    '<div style="flex:1"><div class="ptitle">'+esc(a.name)+'</div><div class="xs dim">'+esc(a.id)+' â€” '+esc(a.location)+'</div></div>'+
    (S.userRole==='admin'?'<button class="btn btn-s" style="font-size:.72rem" onclick="S.editingAssetId=S.editingAssetId===\''+(a.id)+'\''+'?null:\''+(a.id)+'\';'+'S.editFields={};render()">âœ Edit Asset</button>':'')+
    '</div>'+editFormHTML+
    '<div class="grid4">'+statCards.map(function(c){ return '<div class="card"><div class="xs dim" style="text-transform:uppercase;letter-spacing:.12em;margin-bottom:.3rem">'+c.l+'</div><div class="bold" style="font-size:1.3rem;color:var(--'+c.c+')">'+esc(String(c.v))+'</div></div>'; }).join('')+'</div>'+
    '<div class="card card-amber"><div class="xs amber bold" style="text-transform:uppercase;letter-spacing:.15em;margin-bottom:.5rem">Runtime Formula</div>'+
    '<div class="formula"><span class="sky bold">'+a.reset_count+'</span><span class="dim"> Ã— </span>'+
    '<span>'+a.meter_max_value.toLocaleString()+'</span><span class="dim"> + </span>'+
    '<span>'+a.stuck_reading.toLocaleString()+'</span><span class="dim"> + </span>'+
    '<span>'+(lat?lat.raw_meter_reading:0)+'</span><span class="dim"> = </span>'+
    '<span class="amber bold">'+acc.toLocaleString()+' hrs</span></div></div>'+
    '<div class="card"><div class="stitle">Runtime Trend</div>'+
    svgChart(chartData,['Accumulated','Monthly Î”'],['#f59e0b','#6ee7b7'],200)+
    (assetRepls.length?'<p class="xs sky" style="margin-top:.4rem">Meter resets: '+assetRepls.map(function(r){ return fmtMonth(r.replacement_date); }).join(', ')+'</p>':'')+
    '</div>'+
    '<div class="card"><div class="stitle">Reading History</div><div class="tbl-wrap"><table><thead><tr>'+
    '<th>Month</th><th>Raw</th><th>Monthly Î”</th><th>Accumulated</th><th>Status</th><th>Locked</th><th>By</th>'+
    '</tr></thead><tbody>'+rows+'</tbody></table></div></div>';
}

// â”€â”€ MONTHLY ENTRY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderEntry(){
  var isLocked=S.closed.indexOf(S.entryMonth)>=0;
  var canEdit=(S.userRole==='admin'||S.userRole==='engineer')&&!isLocked;

  var monthOpts=MONTHS.map(function(m){ return '<option value="'+m+'"'+(S.entryMonth===m?' selected':'')+'>'+fmtMonth(m)+'</option>'; }).join('');

  if(S.assets.length===0){
    return '<div class="row"><div class="ptitle">Monthly Entry</div></div>'+
      '<div class="card"><p class="dim sm">No assets â€” run seed_data.sql in Supabase and click â†» Sync.</p></div>';
  }

  var rows=S.assets.filter(function(a){ return a.active_status; }).map(function(a){
    var prev=null,best='';
    S.readings.forEach(function(r){ if(r.asset_id===a.id&&r.month<S.entryMonth&&r.month>best){ best=r.month;prev=r; } });
    var existing=S.readings.find(function(r){ return r.asset_id===a.id&&r.month===S.entryMonth; });
    var val=S.entryPending[a.id]!==undefined?S.entryPending[a.id]:(existing?String(existing.raw_meter_reading):'');
    var res=S.entryResults[a.id]||null;
    var inpClass='inp-sm'+(res?res.status==='OK'?' inp-ok':res.status==='WARNING'?' inp-warn':' inp-crit':'');
    var acc=(val!==''&&!isNaN(+val)&&val.trim()!=='')?calcAcc(a,+val):null;
    return '<tr>'+
      '<td><div class="xs bold" style="color:#e4e4e7">'+esc(a.name)+'</div><div class="xs dim">'+esc(a.id)+'</div></td>'+
      '<td class="xs dim">'+esc(a.location)+'</td>'+
      '<td>'+(prev?prev.raw_meter_reading.toLocaleString():'â€”')+'</td>'+
      '<td>'+
      (canEdit?
        '<input id="inp-'+esc(a.id)+'" class="'+inpClass+'" type="number" min="0" value="'+esc(val)+'" placeholder="hrs" oninput="handleEntryInput(\''+esc(a.id)+'\',this.value)" disabled="'+(!canEdit)+'">'
        :'<span class="dim xs">'+(val||'â€”')+'</span>')+
      '</td>'+
      '<td id="val-'+esc(a.id)+'">'+
      (res?badge(res.status)+'<div class="xs dim" style="margin-top:.15rem">'+esc(res.message)+'</div>':'<span class="dim xs">â€”</span>')+
      '</td>'+
      '<td id="acc-'+esc(a.id)+'" class="amber bold">'+
      (acc!==null?acc.toLocaleString()+' hrs':'â€”')+'</td>'+
      '</tr>';
  }).join('');

  return '<div class="row">'+
    '<div><div class="ptitle">Monthly Entry</div><div class="xs dim" style="margin-top:.15rem">Record meter readings for all assets</div></div>'+
    '<div class="flex">'+
    '<select class="sel" onchange="S.entryMonth=this.value;S.entryPending={};S.entryResults={};render()">'+monthOpts+'</select>'+
    (isLocked?'<span class="dim xs" style="border:1px solid var(--bdr);padding:.3rem .6rem;border-radius:.25rem">ğŸ”’ Locked</span>':'')+
    (canEdit?'<button class="btn btn-p" onclick="saveAllReadings()">Save All</button>':'')+
    '</div></div>'+
    (isLocked&&S.userRole==='admin'?'<div class="info-box">âš  Month is closed. Admin edits are fully audited.</div>':'')+
    '<div class="card"><div class="tbl-wrap"><table><thead><tr>'+
    '<th>Asset / Tag</th><th>Drawer</th><th>Prev Reading</th><th>New Reading</th><th>Validation</th><th>Accumulated</th>'+
    '</tr></thead><tbody>'+rows+'</tbody></table></div></div>';
}

// â”€â”€ REPLACEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderReplacements(){
  var a=S.assets.find(function(x){ return x.id===S.replAssetId; });
  var canEdit=S.userRole==='admin'||S.userRole==='engineer';
  var step=S.replStep;

  var steps=['Select','Confirm','Done'].map(function(s,i){
    return '<span class="step-c'+(step>=i?' done':'')+'">'+( i+1)+'</span>'+
      '<span class="step-txt'+(step>=i?' done':'')+'">'+s+'</span>'+
      (i<2?'<span class="step-l'+(step>i?' done':'')+'"></span>':'');
  }).join('');

  var wiz='';
  if(step===0){
    var opts=S.assets.filter(function(a){ return a.active_status; }).map(function(a){ return '<option value="'+esc(a.id)+'"'+(S.replAssetId===a.id?' selected':'')+'>'+esc(a.name)+'</option>'; }).join('');
    wiz='<div class="card card-amber">'+
      '<div class="xs amber bold" style="text-transform:uppercase;letter-spacing:.15em;margin-bottom:.8rem">Step 1 â€” Select Asset</div>'+
      '<div class="fg"><label class="lbl">Asset</label>'+
      '<select class="sel" style="width:100%" onchange="S.replAssetId=this.value"><option value="">â€” Select â€”</option>'+opts+'</select></div>'+
      '<div class="fg"><label class="lbl">Notes / Reason</label>'+
      '<textarea class="inp" rows="2" placeholder="Reason for replacementâ€¦" oninput="S.replNotes=this.value">'+esc(S.replNotes)+'</textarea></div>'+
      (canEdit?'<button class="btn btn-p" style="width:100%;justify-content:center" onclick="replNext()">Next â†’</button>':
        '<div class="dim xs">Insufficient role.</div>')+
      '</div>';
  } else if(step===1&&a){
    var newStuck=a.stuck_reading+(+S.replLastReading);
    wiz='<div class="card card-amber">'+
      '<div class="xs amber bold" style="text-transform:uppercase;letter-spacing:.15em;margin-bottom:.8rem">Step 2 â€” Confirm Last Reading</div>'+
      '<div class="fg"><label class="lbl">Last Raw Reading (becomes stuck reading)</label>'+
      '<input class="inp" type="number" value="'+esc(S.replLastReading)+'" oninput="S.replLastReading=this.value;replUpdatePreview()"></div>'+
      '<div style="background:var(--bg);border:1px solid var(--bdr);border-radius:.375rem;padding:.75rem;font-size:.75rem;font-family:monospace;margin-bottom:.8rem" id="repl-preview">'+
      '<div class="dim">reset_count: <span style="color:#e4e4e7">'+a.reset_count+'</span> â†’ <span class="amber">'+( a.reset_count+1)+'</span></div>'+
      '<div class="dim">new stuck_reading: <span class="amber">'+newStuck.toLocaleString()+' hrs</span></div>'+
      '</div>'+
      '<div class="flex">'+
      '<button class="btn btn-s" onclick="S.replStep=0;render()">â† Back</button>'+
      '<button class="btn btn-d" onclick="replConfirm()">Confirm Reset</button>'+
      '</div></div>';
  } else if(step===2&&S.replConf){
    var rc=S.replConf;
    wiz='<div class="card card-green">'+
      '<div class="xs green bold" style="text-transform:uppercase;letter-spacing:.15em;margin-bottom:.8rem">âœ“ Replacement Logged</div>'+
      '<div class="sm" style="line-height:1.8">'+
      'Asset: <span style="color:#e4e4e7">'+esc(rc.assetName)+'</span><br>'+
      'New Reset Count: <span class="amber">'+rc.newReset+'</span><br>'+
      'Total Stuck: <span class="amber">'+rc.newStuck.toLocaleString()+' hrs</span></div>'+
      '<button class="btn btn-p" style="margin-top:1rem" onclick="replReset()">Log Another</button>'+
      '</div>';
  }

  var replRows=S.repls.length===0?
    '<tr><td colspan="5" style="color:#71717a;text-align:center;padding:1rem">No replacements yet.</td></tr>':
    S.repls.slice().reverse().map(function(r){
      var a=S.assets.find(function(x){ return x.id===r.asset_id; });
      return '<tr>'+
        '<td>'+fmtMonth(r.replacement_date)+'</td>'+
        '<td class="xs bold" style="color:#e4e4e7">'+esc(a?a.name:r.asset_id)+'</td>'+
        '<td class="amber">'+(r.last_stuck_reading||0).toLocaleString()+'</td>'+
        '<td>'+r.previous_reset_count+' â†’ <span class="sky">'+r.new_reset_count+'</span></td>'+
        '<td class="xs dim">'+esc(r.notes)+'</td></tr>';
    }).join('');

  return '<div class="ptitle" style="margin-bottom:1rem">Meter Replacements</div>'+
    '<div class="grid-2col">'+
    '<div class="space">'+
    '<div class="step-row">'+steps+'</div>'+
    wiz+'</div>'+
    '<div class="card">'+
    '<div class="stitle">Replacement Log</div>'+
    '<div class="tbl-wrap"><table><thead><tr>'+
    '<th>Date</th><th>Asset</th><th>Stuck Rdg</th><th>Reset #</th><th>Notes</th>'+
    '</tr></thead><tbody>'+replRows+'</tbody></table></div></div>'+
    '</div>';
}

// â”€â”€ REPORTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderReports(){
  var selM=S.reportsMonth||CUR_MONTH;
  var monthOpts=MONTHS.map(function(m){ return '<option value="'+m+'"'+(selM===m?' selected':'')+'>'+fmtMonth(m)+'</option>'; }).join('');
  var report=S.assets.map(function(a){
    var r=S.readings.find(function(rd){ return rd.asset_id===a.id&&rd.month===selM; });
    var prev=null,best='';
    S.readings.forEach(function(rd){ if(rd.asset_id===a.id&&rd.month<selM&&rd.month>best){ best=rd.month;prev=rd; } });
    var delta=(r&&prev)?(r.raw_meter_reading-prev.raw_meter_reading):null;
    return {id:a.id,name:a.name,location:a.location,raw:r?r.raw_meter_reading:null,delta:delta,acc:calcAcc(a,r?r.raw_meter_reading:0),thr:a.threshold_hours,status:r?r.validation:'N/A'};
  });
  var trendData=MONTHS.map(function(m){
    var e={label:fmtMonth(m)};
    S.assets.forEach(function(a){
      var r=S.readings.find(function(rd){ return rd.asset_id===a.id&&rd.month===m; });
      e[a.name]=r?calcAcc(a,r.raw_meter_reading):null;
    });
    return e;
  });
  var colors=['#f59e0b','#6ee7b7','#38bdf8','#f472b6','#a78bfa','#fb7185'];
  var reportRows=report.map(function(r){
    return '<tr>'+
      '<td><div class="xs bold" style="color:#e4e4e7">'+esc(r.name)+'</div><div class="xs dim">'+esc(r.id)+'</div></td>'+
      '<td>'+(r.raw!==null?r.raw.toLocaleString():'â€”')+' hrs</td>'+
      '<td>'+(r.delta!==null?'<span class="'+(r.delta>r.thr?'amber':'green')+'">+'+r.delta+'</span>':'â€”')+'</td>'+
      '<td class="amber bold">'+r.acc.toLocaleString()+' hrs</td>'+
      '<td class="dim xs">'+r.thr+' hrs/mo</td>'+
      '<td>'+badge(r.status)+'</td></tr>';
  }).join('');
  var alerts=report.filter(function(r){ return r.delta!==null&&r.delta>r.thr; });
  var alertsHTML=alerts.length===0?'<p class="dim sm">No assets exceeded threshold this month. âœ“</p>':
    alerts.map(function(r){ return '<div class="alert-row">'+
      '<span class="amber">âš </span>'+
      '<div><span class="amber bold sm">'+esc(r.name)+'</span> '+
      '<span class="xs dim">ran '+r.delta+' hrs vs '+r.thr+' hr limit</span></div>'+
      '<span class="badge b-warn">+'+( r.delta-r.thr)+' over</span>'+
      '</div>'; }).join('');

  var csvData=report.map(function(r){ return {id:r.id,name:r.name,location:r.location,month:fmtMonth(selM),raw_reading:r.raw,monthly_delta:r.delta,accumulated:r.acc,threshold:r.thr,status:r.status}; });

  return '<div class="row">'+
    '<div class="ptitle">Reports</div>'+
    '<div class="flex">'+
    '<select class="sel" onchange="S.reportsMonth=this.value;render()">'+monthOpts+'</select>'+
    '<button class="btn btn-s" onclick="exportCSV('+JSON.stringify(csvData)+',\'runtime-'+selM+'.csv\')">â†“ CSV Export</button>'+
    '</div></div>'+
    '<div class="card"><div class="stitle">Monthly Report â€” '+fmtMonth(selM)+'</div>'+
    '<div class="tbl-wrap"><table><thead><tr>'+
    '<th>Asset</th><th>Raw Reading</th><th>Monthly Î”</th><th>Accumulated</th><th>Threshold</th><th>Status</th>'+
    '</tr></thead><tbody>'+reportRows+'</tbody></table></div></div>'+
    '<div class="card"><div class="stitle">All-Asset Accumulated Trend</div>'+
    svgChart(trendData,S.assets.map(function(a){ return a.name; }),colors,260)+'</div>'+
    '<div class="card"><div class="stitle">Threshold Alerts â€” '+fmtMonth(selM)+'</div>'+alertsHTML+'</div>';
}

// â”€â”€ AUDIT LOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAudit(){
  var colorMap={CREATE:'green',EDIT:'amber',DELETE:'red',LOCK:'sky',UNLOCK:'amber',CLOSE_MONTH:'sky',METER_REPLACEMENT:'amber'};
  var rows=S.audit.map(function(e){
    return '<tr>'+
      '<td class="xs dim">'+new Date(e.timestamp).toLocaleString()+'</td>'+
      '<td class="xs" style="color:#e4e4e7">'+esc(e.user_email)+'</td>'+
      '<td><span class="xs bold '+(colorMap[e.action]||'dim')+'">'+esc(e.action)+'</span></td>'+
      '<td class="xs dim">'+esc(e.entity)+'</td>'+
      '<td class="xs dim mono">'+esc(e.entity_id)+'</td>'+
      '<td class="xs dim">'+esc(e.detail)+'</td></tr>';
  }).join('');
  return '<div class="row">'+
    '<div class="ptitle">Audit Log</div>'+
    '<button class="btn btn-s" onclick="exportAudit()">â†“ Export CSV</button></div>'+
    '<div class="card"><div class="tbl-wrap"><table><thead><tr>'+
    '<th>Timestamp</th><th>User</th><th>Action</th><th>Entity</th><th>Record</th><th>Detail</th>'+
    '</tr></thead><tbody>'+(rows||'<tr><td colspan="6" style="color:#71717a;text-align:center;padding:1rem">No audit entries yet.</td></tr>')+'</tbody></table></div></div>';
}

// â”€â”€ USERS (admin) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderUsers(){
  if(!S._users){ loadUsers(); return '<div class="card"><div class="flex"><span class="spin">â—</span><span class="dim sm">Loading usersâ€¦</span></div></div>'; }
  var rows=S._users.map(function(u){
    var isMe=u.id===S.session.user.id;
    return '<tr>'+
      '<td><span class="'+(isMe?'amber bold':'sm')+'" style="color:'+(isMe?'#f59e0b':'#e4e4e7')+'">'+esc(u.email)+(isMe?' (you)':'')+'</span></td>'+
      '<td>'+roleBadge(u.role)+'</td>'+
      '<td class="xs dim">'+new Date(u.created_at).toLocaleDateString()+'</td>'+
      '<td>'+(isMe?'<span class="dim xs">Cannot change own role</span>':
        '<select class="sel" style="font-size:.72rem" onchange="changeRole(\''+esc(u.id)+'\',this.value)">'+
        '<option value="viewer"'+(u.role==='viewer'?' selected':'')+'>Viewer â€” read only</option>'+
        '<option value="engineer"'+(u.role==='engineer'?' selected':'')+'>Engineer â€” add readings</option>'+
        '<option value="admin"'+(u.role==='admin'?' selected':'')+'>Admin â€” full access</option>'+
        '</select>')+'</td></tr>';
  }).join('');
  return '<div class="ptitle" style="margin-bottom:1rem">User Management</div>'+
    '<div class="card"><div class="tbl-wrap"><table><thead><tr>'+
    '<th>Email</th><th>Role</th><th>Joined</th><th>Change Role</th>'+
    '</tr></thead><tbody>'+rows+'</tbody></table></div></div>'+
    '<div class="card">'+
    '<div class="stitle">How Team Access Works</div>'+
    '<p class="sm" style="color:#a1a1aa;margin-bottom:.7rem">Share your app URL. Colleagues sign up â†’ get Viewer access â†’ you promote them here.</p>'+
    '<div class="grid-2col">'+
    ['Viewer|Read all data and reports|rt-viewer','Engineer|+ Add readings, log replacements|rt-engineer','Admin|+ Close months, manage users|rt-admin'].map(function(s){
      var p=s.split('|');
      return '<div style="border:1px solid var(--bdr);border-radius:.375rem;padding:.7rem">'+
        '<div class="bold xs role-tag '+p[2]+'" style="display:inline-block;margin-bottom:.3rem">'+p[0].toUpperCase()+'</div>'+
        '<div class="xs dim">'+p[1]+'</div></div>';
    }).join('')+
    '</div></div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setLoginMode(m){ S.loginMode=m; S.loginErr=''; S.loginMsg=''; render(); }

async function doLogin(){
  S.loginErr=''; S.loginBusy=true; render();
  var email=document.getElementById('l-email')?document.getElementById('l-email').value:S.loginEmail;
  var pw=document.getElementById('l-pw')?document.getElementById('l-pw').value:S.loginPw;
  S.loginEmail=email; S.loginPw=pw;
  var r;
  if(S.loginMode==='login'){
    r=await DB.auth.signInWithPassword({email:email,password:pw});
  } else {
    r=await DB.auth.signUp({email:email,password:pw});
    if(!r.error){ S.loginMsg='Account created! You can now sign in.'; S.loginMode='login'; S.loginBusy=false; render(); return; }
  }
  if(r.error){ S.loginErr=r.error.message; }
  S.loginBusy=false; render();
}

async function doLogout(){
  await DB.auth.signOut();
  S.session=null; S.view='login'; render();
}

async function loadData(){
  var mainEl=document.getElementById('main');
  if(mainEl) mainEl.innerHTML='<div class="flex" style="padding:2rem;justify-content:center"><span class="spin">â—</span><span class="dim sm">&nbsp;Loading dataâ€¦</span></div>';
  var results=await Promise.all([
    DB.from('assets').select('*').order('id'),
    DB.from('monthly_readings').select('*').order('month'),
    DB.from('replacement_logs').select('*').order('replacement_date'),
    DB.from('audit_log').select('*').order('timestamp',{ascending:false}).limit(500),
    DB.from('closed_months').select('month'),
  ]);
  S.assets=results[0].data||[];
  S.readings=results[1].data||[];
  S.repls=results[2].data||[];
  S.audit=results[3].data||[];
  S.closed=(results[4].data||[]).map(function(x){ return x.month; });
  render();
}

async function loadProfile(id){
  var r=await DB.from('profiles').select('role').eq('id',id).single();
  S.userRole=(r.data&&r.data.role)||'viewer';
}

function goTab(t){ S.appTab=t; S.detailId=null; render(); }
function openAssetDetail(id){ S.detailId=id; S.appTab='assets'; render(); }

// ADD ASSET
async function submitAddAsset(){
  var nameEl=document.getElementById('na-name');
  var locEl=document.getElementById('na-loc');
  var maxEl=document.getElementById('na-max');
  var thrEl=document.getElementById('na-thr');
  if(!nameEl||!nameEl.value.trim()){ toast('Name required.','err'); return; }
  S.addAssetBusy=true; render();
  var id='A'+String(S.assets.length+1).padStart(3,'0');
  var rec={id:id,name:nameEl.value.trim(),location:locEl?locEl.value:'',meter_max_value:+(maxEl?maxEl.value:9999),reset_count:0,stuck_reading:0,created_at:new Date().toISOString().slice(0,10),active_status:true,threshold_hours:+(thrEl?thrEl.value:200)};
  var r=await DB.from('assets').insert(rec);
  if(r.error){ toast(r.error.message,'err'); S.addAssetBusy=false; render(); return; }
  S.assets.push(rec);
  await logAudit('CREATE','Asset',id,'Created: '+rec.name);
  toast('Asset '+id+' registered. âœ“','ok');
  S.addAssetOpen=false; S.addAssetBusy=false; render();
}

// MONTHLY ENTRY
function handleEntryInput(assetId, val){
  S.entryPending[assetId]=val;
  var asset=S.assets.find(function(a){ return a.id===assetId; });
  if(!asset) return;
  if(val===''||isNaN(+val)||val.trim()===''){ S.entryResults[assetId]=null; }
  else { S.entryResults[assetId]=validateReading(asset,S.readings,+val,S.entryMonth); }
  // update validation cell
  var valCell=document.getElementById('val-'+assetId);
  var accCell=document.getElementById('acc-'+assetId);
  var inpEl=document.getElementById('inp-'+assetId);
  var res=S.entryResults[assetId];
  if(valCell) valCell.innerHTML=res?badge(res.status)+'<div class="xs dim" style="margin-top:.15rem">'+esc(res.message)+'</div>':'<span class="dim xs">â€”</span>';
  if(accCell){
    var num=+val;
    if(val!==''&&!isNaN(num)&&val.trim()!==''){
      accCell.textContent=calcAcc(asset,num).toLocaleString()+' hrs';
      accCell.style.color='#f59e0b';
    } else { accCell.textContent='â€”'; accCell.style.color='var(--t3)'; }
  }
  if(inpEl&&res){
    inpEl.className='inp-sm '+(res.status==='OK'?'inp-ok':res.status==='WARNING'?'inp-warn':'inp-crit');
  } else if(inpEl){ inpEl.className='inp-sm'; }
}

async function saveAllReadings(){
  var canEdit=(S.userRole==='admin'||S.userRole==='engineer')&&S.closed.indexOf(S.entryMonth)<0;
  if(!canEdit){ toast('Month is locked or insufficient role.','err'); return; }
  var count=0;
  var newReadings=S.readings.slice();
  for(var i=0;i<S.assets.length;i++){
    var a=S.assets[i];
    if(!a.active_status) continue;
    // Get value from input first, then pending state
    var inpEl=document.getElementById('inp-'+a.id);
    var val=inpEl?inpEl.value:(S.entryPending[a.id]!==undefined?S.entryPending[a.id]:'');
    if(val===''||val===undefined) continue;
    var num=+val; if(isNaN(num)) continue;
    var v=validateReading(a,newReadings,num,S.entryMonth);
    var idx=-1;
    for(var j=0;j<newReadings.length;j++){
      if(newReadings[j].asset_id===a.id&&newReadings[j].month===S.entryMonth){ idx=j; break; }
    }
    var rec={id:idx>=0?newReadings[idx].id:uid(),asset_id:a.id,month:S.entryMonth,raw_meter_reading:num,locked:false,created_at:new Date().toISOString(),created_by:S.session.user.email,validation:v.status};
    var r=await DB.from('monthly_readings').upsert(rec,{onConflict:'asset_id,month'});
    if(r.error){ toast('Error on '+a.name+': '+r.error.message,'err'); continue; }
    if(idx>=0){ newReadings[idx]=rec; } else { newReadings.push(rec); }
    count++;
  }
  S.readings=newReadings;
  S.entryPending={};
  await logAudit('BULK_SAVE','MonthlyEntry',S.entryMonth,'Saved '+count+' readings for '+fmtMonth(S.entryMonth));
  toast(count+' reading(s) saved. âœ“','ok');
  render();
}

// CLOSE MONTH
async function closeMonth(){
  if(S.userRole!=='admin'){ toast('Only Admin can close months.','err'); return; }
  var r=await DB.from('closed_months').upsert({month:PREV_MONTH,closed_by:S.session.user.email});
  if(r.error){ toast(r.error.message,'err'); return; }
  if(S.closed.indexOf(PREV_MONTH)<0) S.closed.push(PREV_MONTH);
  await logAudit('CLOSE_MONTH','Month',PREV_MONTH,'Closed '+fmtMonth(PREV_MONTH));
  toast(fmtMonth(PREV_MONTH)+' locked. âœ“','ok');
}

// REPLACEMENTS
function replNext(){
  if(!S.replAssetId){ toast('Select an asset.','err'); return; }
  var latest=null,best='';
  S.readings.forEach(function(r){ if(r.asset_id===S.replAssetId&&r.month>best){ best=r.month;latest=r; } });
  S.replLastReading=latest?String(latest.raw_meter_reading):'0';
  S.replStep=1; render();
}
function replUpdatePreview(){
  var el=document.querySelector('.inp');
  if(el) S.replLastReading=el.value;
  var prev=document.getElementById('repl-preview');
  if(!prev) return;
  var a=S.assets.find(function(x){ return x.id===S.replAssetId; });
  if(!a) return;
  var ns=a.stuck_reading+(+S.replLastReading);
  prev.innerHTML='<div class="dim">reset_count: <span style="color:#e4e4e7">'+a.reset_count+'</span> â†’ <span class="amber">'+(a.reset_count+1)+'</span></div>'+
    '<div class="dim">new stuck_reading: <span class="amber">'+ns.toLocaleString()+' hrs</span></div>';
}
async function replConfirm(){
  var a=S.assets.find(function(x){ return x.id===S.replAssetId; });
  if(!a) return;
  var newReset=a.reset_count+1, newStuck=a.stuck_reading+(+S.replLastReading);
  var rl={id:uid(),asset_id:S.replAssetId,replacement_date:MONTHS[MONTHS.length-1],last_stuck_reading:+S.replLastReading,previous_reset_count:a.reset_count,new_reset_count:newReset,notes:S.replNotes};
  var r1=await DB.from('replacement_logs').insert(rl);
  var r2=await DB.from('assets').update({reset_count:newReset,stuck_reading:newStuck}).eq('id',S.replAssetId);
  if(r1.error||r2.error){ toast('Save error â€” try again.','err'); return; }
  S.repls.push(rl);
  S.assets=S.assets.map(function(x){ return x.id===S.replAssetId?Object.assign({},x,{reset_count:newReset,stuck_reading:newStuck}):x; });
  await logAudit('METER_REPLACEMENT','Asset',S.replAssetId,'Reset '+a.reset_count+'â†’'+newReset+'. Stuck: '+newStuck);
  S.replConf={assetName:a.name,newReset:newReset,newStuck:newStuck};
  S.replStep=2; render();
  toast('Meter replacement logged. âœ“','ok');
}
function replReset(){ S.replStep=0; S.replAssetId=''; S.replLastReading=''; S.replNotes=''; S.replConf=null; render(); }

// USERS
var _usersLoading=false;
async function loadUsers(){
  if(_usersLoading) return; _usersLoading=true;
  var r=await DB.from('profiles').select('*').order('created_at');
  S._users=r.data||[]; _usersLoading=false; render();
}
async function changeRole(userId,newRole){
  var r=await DB.from('profiles').update({role:newRole}).eq('id',userId);
  if(r.error){ toast(r.error.message,'err'); return; }
  S._users=S._users.map(function(u){ return u.id===userId?Object.assign({},u,{role:newRole}):u; });
  toast('Role updated. âœ“','ok');
  var tbody=document.querySelector('#main table tbody');
  if(tbody){ var newContent=renderUsers(); document.getElementById('main').innerHTML=newContent; }
}

// AUDIT EXPORT
function exportAudit(){ exportCSV(S.audit,'audit-log.csv'); }

// LOG AUDIT
async function logAudit(action,entity,entity_id,detail){
  if(!S.session) return;
  var e={id:uid(),timestamp:new Date().toISOString(),user_email:S.session.user.email,action:action,entity:entity,entity_id:entity_id,detail:detail};
  await DB.from('audit_log').insert(e);
  S.audit.unshift(e);
}

// REPORTS CSV EXPORT (called inline with data)
function exportCSV(data,filename){
  if(!data.length) return;
  var keys=Object.keys(data[0]);
  var rows=[keys.join(',')].concat(data.map(function(r){ return keys.map(function(k){ return '"'+(r[k]===null||r[k]===undefined?'':r[k])+'"'; }).join(','); }));
  var a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(rows.join('\n'));
  a.download=filename; a.click();
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE ASSET EDITS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveAssetEdits(assetId){
  var a=S.assets.find(function(x){ return x.id===assetId; });
  if(!a){ toast('Asset not found.','err'); return; }
  var nameEl=document.getElementById('ef-name');
  var locEl=document.getElementById('ef-loc');
  var maxEl=document.getElementById('ef-max');
  var thrEl=document.getElementById('ef-thr');
  var stuckEl=document.getElementById('ef-stuck');
  var resetEl=document.getElementById('ef-reset');
  var activeEl=document.getElementById('ef-active');
  var fields={};
  if(nameEl) fields.name=nameEl.value.trim()||a.name;
  if(locEl) fields.location=locEl.value;
  if(maxEl&&maxEl.value!=='') fields.meter_max_value=+maxEl.value;
  if(thrEl&&thrEl.value!=='') fields.threshold_hours=+thrEl.value;
  if(stuckEl&&stuckEl.value!=='') fields.stuck_reading=+stuckEl.value;
  if(resetEl&&resetEl.value!=='') fields.reset_count=+resetEl.value;
  if(activeEl) fields.active_status=activeEl.value==='true';
  var r=await DB.from('assets').update(fields).eq('id',assetId);
  if(r.error){ toast('Save error: '+r.error.message,'err'); return; }
  S.assets=S.assets.map(function(x){ return x.id===assetId?Object.assign({},x,fields):x; });
  await logAudit('EDIT','Asset',assetId,'Edited: '+JSON.stringify(fields));
  S.editingAssetId=null; S.editFields={};
  toast('Asset updated. âœ“','ok');
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI ADMIN â€” RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAI(){
  if(S.userRole!=='admin') return '<div class="card"><p class="dim">Admin only.</p></div>';
  var hints=['Show all assets with critical status','List assets with no readings this month',
    'Edit asset A001 name to "Pump Motor NW"','Show me assets over threshold in '+fmtMonth(CUR_MONTH),
    'Correct stuck reading for an asset','What is the total accumulated runtime across all motors?',
    'Deactivate a retired asset','Add a new motor asset'];
  var hintsHTML=hints.map(function(h){ return '<button class="ai-hint-btn" onclick="aiQuickSend(\''+esc(h)+'\')">'+esc(h)+'</button>'; }).join('');
  var msgsHTML=S.aiMessages.length===0?
    '<div style="flex:1;display:flex;align-items:center;justify-content:center">'+
    '<div style="text-align:center;color:var(--t3)">'+
    '<div style="font-size:2rem;margin-bottom:.5rem">âš¡</div>'+
    '<div class="xs" style="text-transform:uppercase;letter-spacing:.15em;color:var(--amber)">AI Admin Console</div>'+
    '<div class="xs dim" style="margin-top:.4rem;max-width:22rem">Ask anything about your assets, get reports, or instruct me to make database changes â€” all audited.</div>'+
    '</div></div>':
    S.aiMessages.map(function(m){
      var bubCls=m.role==='user'?'ai-bubble-user':'ai-bubble-ai';
      var msgCls=m.role==='user'?'ai-msg-user':'ai-msg-ai';
      var cmdHTML='';
      if(m.cmds&&m.cmds.length){
        cmdHTML='<div class="ai-cmd-block">'+m.cmds.map(function(c){
          return '<div class="ai-cmd-row">'+
            '<span class="ai-cmd-action">'+(c.ok?'âœ“':'âœ—')+' '+esc(c.action)+'</span>'+
            '<span class="ai-cmd-detail">'+(c.detail?esc(c.detail):'')+'</span>'+
            (c.err?'<span class="ai-cmd-err xs">'+esc(c.err)+'</span>':'')+
            '</div>';
        }).join('')+'</div>';
      }
      return '<div class="ai-msg '+msgCls+'">'+
        '<div class="ai-bubble '+bubCls+'">'+esc(m.text)+'</div>'+
        cmdHTML+'</div>';
    }).join('');

  return '<div class="row"><div class="ptitle">AI Admin <span class="role-tag rt-admin xs" style="vertical-align:middle">ADMIN ONLY</span></div>'+
    '<button class="btn btn-s" style="font-size:.7rem" onclick="S.aiMessages=[];render()">Clear Chat</button></div>'+
    '<div class="card" style="margin-bottom:.6rem"><div class="xs dim" style="margin-bottom:.4rem">Quick prompts:</div>'+hintsHTML+'</div>'+
    '<div class="card ai-wrap">'+
    '<div class="ai-messages" id="ai-msgs">'+msgsHTML+
    (S.aiLoading?'<div class="ai-msg ai-msg-ai"><div class="ai-bubble ai-bubble-ai dim xs"><span class="spin">â—</span> Thinkingâ€¦</div></div>':'')+
    '</div>'+
    '<div class="ai-input-row">'+
    '<textarea id="ai-inp" class="ai-inp" placeholder="Ask me anything or give me a commandâ€¦" onkeydown="if(event.key===\'Enter\'&&!event.shiftKey){event.preventDefault();sendAI()}">'+(S.aiInput?esc(S.aiInput):'')+'</textarea>'+
    '<button class="ai-send" onclick="sendAI()" '+(S.aiLoading?'disabled':'')+'>Send</button>'+
    '</div></div>';
}

function aiQuickSend(text){
  S.aiInput=text;
  render();
  sendAI();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI ADMIN â€” SEND MESSAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendAI(){
  if(S.aiLoading) return;
  var inpEl=document.getElementById('ai-inp');
  var text=(inpEl?inpEl.value:S.aiInput).trim();
  if(!text) return;
  S.aiMessages.push({role:'user',text:text});
  S.aiInput='';
  S.aiLoading=true;
  render();
  // Scroll to bottom
  setTimeout(function(){ var el=document.getElementById('ai-msgs'); if(el) el.scrollTop=el.scrollHeight; },50);

  // Build context snapshot
  var assetCtx=S.assets.map(function(a){
    var rds=S.readings.filter(function(r){ return r.asset_id===a.id; }).sort(function(x,y){ return y.month.localeCompare(x.month); });
    var lat=rds[0];
    return {id:a.id,name:a.name,location:a.location,active:a.active_status,meter_max:a.meter_max_value,threshold_hrs:a.threshold_hours,reset_count:a.reset_count,stuck_reading:a.stuck_reading,accumulated:calcAcc(a,lat?lat.raw_meter_reading:0),latest_raw:lat?lat.raw_meter_reading:null,latest_month:lat?lat.month:null,latest_status:lat?lat.validation:'NO_DATA'};
  });
  var closedCtx=S.closed.slice(-6);
  var recentReadings=S.readings.filter(function(r){ return r.month>=MONTHS[MONTHS.length-3]; }).length;

  var systemPrompt='You are HourTrack AI Admin â€” a powerful industrial motor runtime management assistant with FULL ADMIN ACCESS to the HourTrack database.\n\n'+
    'You help the admin manage assets (motors), correct data, analyze runtime trends, and execute database operations.\n\n'+
    '== LIVE DATABASE SNAPSHOT ==\n'+
    'Current month: '+fmtMonth(CUR_MONTH)+'\n'+
    'Previous month: '+fmtMonth(PREV_MONTH)+'\n'+
    'Total assets: '+S.assets.length+' ('+S.assets.filter(function(a){return a.active_status;}).length+' active)\n'+
    'Closed months: '+closedCtx.map(fmtMonth).join(', ')+'\n'+
    'Recent readings logged: '+recentReadings+'\n\n'+
    '== ASSETS JSON ==\n'+JSON.stringify(assetCtx,null,1)+'\n\n'+
    '== AVAILABLE COMMANDS ==\n'+
    'To execute database changes, include JSON inside <cmd> tags. Examples:\n\n'+
    'Edit asset fields:\n'+
    '<cmd>{"action":"editAsset","id":"A001","fields":{"name":"New Name","threshold_hours":250,"location":"Panel A","active_status":true,"stuck_reading":0,"reset_count":0,"meter_max_value":9999}}</cmd>\n\n'+
    'Correct a monthly reading:\n'+
    '<cmd>{"action":"upsertReading","asset_id":"A001","month":"2025-01-01","raw_meter_reading":1234}</cmd>\n\n'+
    'Delete a reading:\n'+
    '<cmd>{"action":"deleteReading","asset_id":"A001","month":"2025-01-01"}</cmd>\n\n'+
    'Add a new asset:\n'+
    '<cmd>{"action":"addAsset","id":"A200","name":"Motor Tag","location":"Panel B","meter_max_value":9999,"threshold_hours":200}</cmd>\n\n'+
    'Deactivate/activate asset:\n'+
    '<cmd>{"action":"editAsset","id":"A001","fields":{"active_status":false}}</cmd>\n\n'+
    'Close a month:\n'+
    '<cmd>{"action":"closeMonth","month":"2025-01-01"}}</cmd>\n\n'+
    'Reopen a closed month:\n'+
    '<cmd>{"action":"openMonth","month":"2025-01-01"}}</cmd>\n\n'+
    '== RULES ==\n'+
    '- Always explain what you are about to do BEFORE the <cmd> tags\n'+
    '- Only include <cmd> blocks when the admin explicitly asks for a change or confirms an action\n'+
    '- For data queries/analysis, just respond in plain text â€” no commands needed\n'+
    '- You may chain multiple <cmd> blocks in one response for bulk operations\n'+
    '- Always mention asset ID and name when referencing assets\n'+
    '- Format numbers with commas for readability\n'+
    '- Keep responses concise and professional â€” this is an industrial operations tool\n'+
    '- NEVER invent asset IDs that don\'t exist in the data above';

  // Build messages array for API
  var apiMsgs=S.aiMessages.slice(0,-1).map(function(m){
    return {role:m.role==='user'?'user':'assistant',content:m.text};
  });
  apiMsgs.push({role:'user',content:text});

  try {
    var resp=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:1500,
        system:systemPrompt,
        messages:apiMsgs
      })
    });
    var data=await resp.json();
    if(data.error){ throw new Error(data.error.message||'API error'); }
    var rawText=(data.content||[]).map(function(b){ return b.type==='text'?b.text:''; }).join('');

    // Parse and execute commands
    var cmds=[];
    var displayText=rawText;
    var cmdRegex=/<cmd>([\s\S]*?)<\/cmd>/g;
    var match;
    while((match=cmdRegex.exec(rawText))!==null){
      try {
        var cmd=JSON.parse(match[1].trim());
        var result=await executeAICommand(cmd);
        cmds.push(Object.assign({},result,{action:cmd.action}));
      } catch(e){
        cmds.push({action:'parse_error',ok:false,err:e.message});
      }
    }
    // Strip cmd blocks from display text
    displayText=rawText.replace(/<cmd>[\s\S]*?<\/cmd>/g,'').replace(/\n{3,}/g,'\n\n').trim();

    S.aiMessages.push({role:'ai',text:displayText,cmds:cmds});
  } catch(e){
    S.aiMessages.push({role:'ai',text:'âš  Error: '+e.message,cmds:[]});
  }

  S.aiLoading=false;
  render();
  setTimeout(function(){ var el=document.getElementById('ai-msgs'); if(el) el.scrollTop=el.scrollHeight; },60);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI ADMIN â€” EXECUTE COMMANDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function executeAICommand(cmd){
  var a;
  try {
    if(cmd.action==='editAsset'){
      if(!cmd.id||!cmd.fields) return {ok:false,err:'Missing id or fields',detail:''};
      a=S.assets.find(function(x){ return x.id===cmd.id; });
      if(!a) return {ok:false,err:'Asset '+cmd.id+' not found',detail:cmd.id};
      var r=await DB.from('assets').update(cmd.fields).eq('id',cmd.id);
      if(r.error) return {ok:false,err:r.error.message,detail:cmd.id};
      S.assets=S.assets.map(function(x){ return x.id===cmd.id?Object.assign({},x,cmd.fields):x; });
      await logAudit('EDIT','Asset',cmd.id,'AI edited: '+JSON.stringify(cmd.fields));
      return {ok:true,detail:(a.name)+' â€” '+Object.keys(cmd.fields).join(', ')+' updated'};
    }
    if(cmd.action==='upsertReading'){
      if(!cmd.asset_id||!cmd.month||cmd.raw_meter_reading===undefined) return {ok:false,err:'Missing fields',detail:''};
      a=S.assets.find(function(x){ return x.id===cmd.asset_id; });
      var v=validateReading(a||{id:cmd.asset_id,threshold_hours:200,meter_max_value:9999},S.readings,cmd.raw_meter_reading,cmd.month);
      var rec={id:uid(),asset_id:cmd.asset_id,month:cmd.month,raw_meter_reading:cmd.raw_meter_reading,locked:false,created_at:new Date().toISOString(),created_by:S.session.user.email+' (AI)',validation:v.status};
      var r2=await DB.from('monthly_readings').upsert(rec,{onConflict:'asset_id,month'});
      if(r2.error) return {ok:false,err:r2.error.message,detail:cmd.asset_id};
      var idx=-1; for(var i=0;i<S.readings.length;i++){ if(S.readings[i].asset_id===cmd.asset_id&&S.readings[i].month===cmd.month){idx=i;break;} }
      if(idx>=0){ S.readings[idx]=rec; } else { S.readings.push(rec); }
      await logAudit('EDIT','MonthlyReading',cmd.asset_id,'AI upserted '+fmtMonth(cmd.month)+': '+cmd.raw_meter_reading+' hrs');
      return {ok:true,detail:(a?a.name:cmd.asset_id)+' '+fmtMonth(cmd.month)+' = '+cmd.raw_meter_reading+' hrs'};
    }
    if(cmd.action==='deleteReading'){
      if(!cmd.asset_id||!cmd.month) return {ok:false,err:'Missing asset_id or month',detail:''};
      var r3=await DB.from('monthly_readings').delete().eq('asset_id',cmd.asset_id).eq('month',cmd.month);
      if(r3.error) return {ok:false,err:r3.error.message,detail:''};
      S.readings=S.readings.filter(function(x){ return !(x.asset_id===cmd.asset_id&&x.month===cmd.month); });
      await logAudit('DELETE','MonthlyReading',cmd.asset_id,'AI deleted '+fmtMonth(cmd.month)+' reading');
      return {ok:true,detail:'Deleted '+fmtMonth(cmd.month)+' reading for '+cmd.asset_id};
    }
    if(cmd.action==='addAsset'){
      if(!cmd.id||!cmd.name) return {ok:false,err:'Missing id or name',detail:''};
      var rec2={id:cmd.id,name:cmd.name,location:cmd.location||'',meter_max_value:cmd.meter_max_value||9999,reset_count:0,stuck_reading:0,created_at:new Date().toISOString().slice(0,10),active_status:true,threshold_hours:cmd.threshold_hours||200};
      var r4=await DB.from('assets').insert(rec2);
      if(r4.error) return {ok:false,err:r4.error.message,detail:cmd.id};
      S.assets.push(rec2);
      await logAudit('CREATE','Asset',cmd.id,'AI created: '+cmd.name);
      return {ok:true,detail:'Created '+cmd.id+' â€” '+cmd.name};
    }
    if(cmd.action==='closeMonth'){
      if(!cmd.month) return {ok:false,err:'Missing month',detail:''};
      var r5=await DB.from('closed_months').upsert({month:cmd.month,closed_by:S.session.user.email+' (AI)'});
      if(r5.error) return {ok:false,err:r5.error.message,detail:''};
      if(S.closed.indexOf(cmd.month)<0) S.closed.push(cmd.month);
      await logAudit('CLOSE_MONTH','Month',cmd.month,'AI closed '+fmtMonth(cmd.month));
      return {ok:true,detail:fmtMonth(cmd.month)+' closed'};
    }
    if(cmd.action==='openMonth'){
      if(!cmd.month) return {ok:false,err:'Missing month',detail:''};
      var r6=await DB.from('closed_months').delete().eq('month',cmd.month);
      if(r6.error) return {ok:false,err:r6.error.message,detail:''};
      S.closed=S.closed.filter(function(x){ return x!==cmd.month; });
      await logAudit('UNLOCK','Month',cmd.month,'AI reopened '+fmtMonth(cmd.month));
      return {ok:true,detail:fmtMonth(cmd.month)+' reopened'};
    }
    return {ok:false,err:'Unknown action: '+cmd.action,detail:''};
  } catch(e){
    return {ok:false,err:e.message,detail:''};
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if(!CONFIGURED){
  S.view='setup'; render();
} else {
  DB.auth.getSession().then(function(r){
    var sess=r.data&&r.data.session;
    S.session=sess;
    S.view=sess?'app':'login';
    if(sess){
      loadProfile(sess.user.id).then(function(){ loadData(); });
    } else { render(); }
  });
  DB.auth.onAuthStateChange(function(_,sess){
    S.session=sess;
    if(sess){
      S.view='app';
      loadProfile(sess.user.id).then(function(){ loadData(); });
    } else { S.view='login'; render(); }
  });
}
</script>
</body>
</html>
